<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.data_structures.h_grid_util &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyrid.data_structures.h_grid_util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.data_structures.h_grid_util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>

<div class="viewcode-block" id="update_particle_level"><a class="viewcode-back" href="../../../Developers/Developer%20API/data_structures/h_grid_util.html#pyrid.data_structures.h_grid_util.update_particle_level">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">update_particle_level</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Updates /sets the hierarchical grid level of all particles in the simulation according to the respective particle type.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of the Particles class</span>
<span class="sd">    particle_types : `nb.types.DictType`</span>
<span class="sd">        Numba dictionary containing the names of all particle types and their properties, such as radius and hierarchical grid level.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span>  
    
        <span class="n">ptype</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
        <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span></div>




<div class="viewcode-block" id="update_hgrid"><a class="viewcode-back" href="../../../Developers/Developer%20API/data_structures/h_grid_util.html#pyrid.data_structures.h_grid_util.update_hgrid">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">update_hgrid</span><span class="p">(</span><span class="n">HGrid</span><span class="p">,</span> <span class="n">box_lengths</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Updates the hierarchical grid. This function is only called when the Berendsen barostat is used as in this case the simulation box size is changing. </span>
<span class="sd">    This necessitates an update of certain grid parameters such as cell size and number.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    HGrid : `array like`</span>
<span class="sd">        Numpy structures array that is the hierarchical grid. The structured array contains several fields defined by the np.dtype: </span>
<span class="sd">        `np.dtype([(&#39;L&#39;, np.int64, (N_Levels,)), (&#39;sh&#39;, np.float64, (N_Levels,3)), (&#39;head&#39;, np.int64, (np.sum(NCells)*2,)), (&#39;head_start&#39;, np.int64, (N_Levels,)), (&#39;ls&#39;, np.int64, (2*N+1,)), (&#39;NCells&#39;, np.int64, (N_Levels,)), (&#39;cells_per_dim&#39;, np.int64, (N_Levels,3)), (&#39;cutoff&#39;, np.float64, (N_Levels,))],  align=True)`</span>
<span class="sd">    box_lengths : `floa64[3]`</span>
<span class="sd">        Length of the simulation box in each dimension.</span>
<span class="sd">    N : `int64`</span>
<span class="sd">        Total number of particles in the simulation.</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of the System class.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="c1"># We scale the overall grid size by this factor relative to the simulation box size. This way, the cell grid is slightly larger than the simulation box. If we don&#39;t do this, we can get out of bounds errors for points that lie exactly in the plane of a positive box boundary!</span>
    
    <span class="n">N_Levels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">])</span>

    <span class="n">hstart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_Levels</span><span class="p">):</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head_start&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hstart</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
        
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">max_cells_per_dim</span><span class="p">):</span>
            <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">max_cells_per_dim</span>
            <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">eps</span><span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">eps</span><span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">eps</span><span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;NCells&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        
        <span class="n">hstart</span> <span class="o">+=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;NCells&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span></div>
        
    
    
<div class="viewcode-block" id="create_hgrid"><a class="viewcode-back" href="../../../Developers/Developer%20API/data_structures/h_grid_util.html#pyrid.data_structures.h_grid_util.create_hgrid">[docs]</a><span class="k">def</span> <span class="nf">create_hgrid</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">,</span> <span class="n">box_lengths</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Creates a hierarchical grid.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of the Particles class</span>
<span class="sd">    particle_types : `nb.types.DictType`</span>
<span class="sd">        Numba dictionary containing the names of all particle types and their properties, such as radius and hierarchical grid level.</span>
<span class="sd">    box_lengths : `floa64[3]`</span>
<span class="sd">        Length of the simulation box in each dimension.</span>
<span class="sd">    N : `int64`</span>
<span class="sd">        Total number of particles in the simulation.</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of the System class.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    *Hierarchical Grid*</span>
<span class="sd">    </span>
<span class="sd">    The computationally most expensive part in molecular dynamics simulations is usually the calculation of the pairwise interaction forces, beacuase to calculate these, we need to determine the distance between particles. When doing this in the most naiv way, i.e. for each particle i we iterate over all the other particles j in the system and calculate the distance, the computation time will increase quadratically with the number of partciles in the system (:math:`O(N^2)`). Even if we take into account Newtons third law, this will decrease the number of computations (:math:`O(\\frac{1}{2}N(N-1))`), but the computational complexity still is quadratic in N. </span>
<span class="sd">    A straight forward method to significantly improve the situation is the linked cell list approach :cite:p:`Allen2017` (pp.195: 5.3.2 Cell structures and linked lists) where the simulation box is divided into :math:`n \\times n \\times n` cells. The number of cells must be chosen such that the side length of the cells in each dimension :math:`s = L/n`, where :math:`L` is the simulation box length, is greater than the maximum cutoff radius for the pairwise molecular interactions (and in our case also bimolecular reactions). This will decrease the computational complexity to :math:`O(14 N \\rho s^3 )`, where :math:`\\rho` is the molecule density (assuming a mostly homogeneous distribution of molecules). Thereby, the computation time increase rather linear with :math:`N` instead of quadratically (:math:`N^2`).</span>
<span class="sd">    </span>
<span class="sd">    However, one problem with this method is that it does not efficiently handle polydisperse particle size distributions. This becomes a problem when doing minimal coarse graining of proteins and other structures we find in the cell such as vesicles. As mentioned above, n should be chosen such that the cell length is greater than teh maximum cutoff radius. If we would like to simulate, e.g. proteins (:math:`r \\approx 2-5 nm`) in the presence of synaptic vesicles (:math:`r \\approx 20-30 nm`), the cells become way larger than necessary from the perspective of the small proteins. </span>
<span class="sd">    </span>
<span class="sd">    One way to approach this problem would be, to choose a small cell size (e.g. based on the samllest cutoff radius) and just iterate not just over the nearest neighbour cells but over as many cells such that the cutoff radius of the larger proteins/SVs is covered. This approach has has a big disadvantages: Whereas for the smaller partciles we actually reduce the number of unnecessary distance calculations, for the larger particles we don&#39;t. We can, however, still take advantage of Newton&#39;s 3rd law. For this, we only do the distance calculation if the radius of particle i is larger than the radius of particle j. If the radii are equal, we only do the calculation if index i is smaller than index j.</span>
<span class="sd">    </span>
<span class="sd">    A much better approach has been introduced by :cite:t:`Ogarko2012` and makes use of a so called hierarchical grid. This approach is the one we use in PyRID. In the hierarchical grid approach, each particle is assigned to a different cell grid depending on its cutoff radius, i.e. the grid consists of different levels or hierarchies, each having a different cell size. This has the downside of taking up more memory, howewer, it drastically reduces the number of distance calculations we need to do for the larger particles and also takes advantage of Newtons third law, enabling polydisiperse system simulations with almost no performance loss. The algorithm for the distance checks works as follows:</span>
<span class="sd">        </span>
<span class="sd">        1. Iterate over all particles</span>
<span class="sd">        2. Assign each particle to a cell on their respective level in the hierarchical grid</span>
<span class="sd">        3. Iterate over all particles once more</span>
<span class="sd">        4. Do a distance check for the nearest neigbour cells on the level the current particle sites in. This is done using the classical linekd cell list algorithm.</span>
<span class="sd">        5. Afterwards, do a cross-level search. For this, distance checks are only done on lower hierarchy levels, i.e. on levels with smaller partcile sizes than the current one. This way, we do not need to double check the same particle pair (3rd law). However, in this step, we will have to iterate over potentialy many empty cells (Note: this should, in principle, also be doable in a more efficient way).</span>
<span class="sd">        </span>

<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    array like</span>
<span class="sd">        Numpy structures array that is the hierarchical grid. The structured array contains several fields defined by the np.dtype: </span>
<span class="sd">        `np.dtype([(&#39;L&#39;, np.int64, (N_Levels,)), (&#39;sh&#39;, np.float64, (N_Levels,3)), (&#39;head&#39;, np.int64, (np.sum(NCells)*2,)), (&#39;head_start&#39;, np.int64, (N_Levels,)), (&#39;ls&#39;, np.int64, (2*N+1,)), (&#39;NCells&#39;, np.int64, (N_Levels,)), (&#39;cells_per_dim&#39;, np.int64, (N_Levels,3)), (&#39;cutoff&#39;, np.float64, (N_Levels,))],  align=True)`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="c1"># We scale the overall grid size by this factor relative to the simulation box size. This way, the cell grid is slightly larger than the simulation box. If we don&#39;t do this, we can get out of bounds errors for points that lie exactly in the plane of a positive box boundary!</span>
    
    <span class="n">Radii</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Types</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="n">particle_types</span><span class="p">:</span>

        <span class="n">Radii</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">particle_types</span><span class="p">[</span><span class="n">ptype</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">])</span>
        <span class="n">Types</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ptype</span><span class="p">)</span>
        
    <span class="n">R_T</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">Radii</span><span class="p">,</span><span class="n">Types</span><span class="p">)</span>
    <span class="n">Radii</span><span class="p">,</span> <span class="n">Types</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="nb">sorted</span><span class="p">(</span><span class="n">R_T</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span> <span class="c1">#sort by Radii        </span>
    
    <span class="n">Level</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cells</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">Cutoffs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">current_radius</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">current_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">current_cells</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">N_Levels</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">Radii</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">radius</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
            <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_lengths</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cells</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">max_cells_per_dim</span><span class="p">):</span>
                <span class="c1"># cells = np.array([50,50,50], dtype = np.int64) </span>
                <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">max_cells_per_dim</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">current_step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Note: </span><span class="si">{</span><span class="n">Types</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s1"> lacks any bimolecular reactions or interactions!&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">current_cells</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">cells</span> <span class="o">=</span> <span class="n">current_cells</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># cells = np.array([50,50,50], dtype = np.int64) </span>
                <span class="n">cells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
                <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">max_cells_per_dim</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="n">cells</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">cells</span> <span class="o">==</span> <span class="n">current_cells</span><span class="p">):</span>
            <span class="n">Level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_level</span><span class="p">)</span>
            <span class="n">Cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_cells</span><span class="p">)</span>
            <span class="n">Cutoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
   
            <span class="n">current_cells</span> <span class="o">=</span> <span class="n">cells</span>
            <span class="n">current_level</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">Level</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_level</span><span class="p">)</span>
            <span class="n">Cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cells</span><span class="p">)</span>
            <span class="n">Cutoffs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">radius</span><span class="p">)</span>
            
            <span class="n">current_radius</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="n">N_Levels</span> <span class="o">+=</span> <span class="mi">1</span>
        
    
    <span class="n">NCells</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_Levels</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">N_Levels</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">Cutoff_HGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N_Levels</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">h</span><span class="p">,</span> <span class="n">cell</span><span class="p">,</span> <span class="n">ptype</span><span class="p">,</span> <span class="n">cutoff</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">Level</span><span class="p">,</span> <span class="n">Cells</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Cutoffs</span><span class="p">):</span>
        
        <span class="n">particle_types</span><span class="p">[</span><span class="n">ptype</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">h</span>
        
        <span class="n">NCells</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="n">cells_per_dim</span><span class="p">[</span><span class="n">h</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cell</span>
        <span class="n">Cutoff_HGrid</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">=</span> <span class="n">cutoff</span>
    
    <span class="n">item_t_hgrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;L&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;sh&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;head&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">NCells</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;head_start&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;ls&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">N</span><span class="o">+</span><span class="mi">1</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;NCells&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="n">N_Levels</span><span class="p">,))],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    
    <span class="n">HGrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_hgrid</span><span class="p">)</span>
    
    <span class="n">hstart</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_Levels</span><span class="p">):</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head_start&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">hstart</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;L&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="o">*</span><span class="n">eps</span><span class="o">/</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">Cutoff_HGrid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;NCells&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">NCells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        <span class="n">hstart</span> <span class="o">+=</span> <span class="n">NCells</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>


    <span class="n">update_particle_level</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">HGrid</span></div>



<span class="c1">#%%</span>

<span class="c1"># if __name__ == &#39;__main__&#39;:</span>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>