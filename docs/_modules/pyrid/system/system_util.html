<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.system.system_util &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyrid.system.system_util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.system.system_util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">from</span> <span class="nn">numba.experimental</span> <span class="kn">import</span> <span class="n">jitclass</span>
<span class="kn">from</span> <span class="nn">..reactions</span> <span class="kn">import</span> <span class="n">reactions_registry_util</span> <span class="k">as</span> <span class="n">rru</span>
<span class="kn">from</span> <span class="nn">..geometry.mesh_util</span> <span class="kn">import</span> <span class="n">triangle_centroid</span><span class="p">,</span> <span class="n">triangle_area</span><span class="p">,</span> <span class="n">triangle_volume_signed</span>
<span class="kn">from</span> <span class="nn">..math.transform_util</span> <span class="kn">import</span> <span class="n">local_coord</span><span class="p">,</span> <span class="n">normal_vector</span><span class="p">,</span> <span class="n">isclose</span><span class="p">,</span> <span class="n">barycentric_params</span>
<span class="kn">from</span> <span class="nn">..math</span> <span class="kn">import</span> <span class="n">random_util</span> <span class="k">as</span> <span class="n">rnd</span>
<span class="kn">from</span> <span class="nn">..data_structures.cell_list_util</span> <span class="kn">import</span> <span class="n">CellListMesh</span><span class="p">,</span> <span class="n">create_cell_list_mesh</span>

<span class="c1">#%%</span>

<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">string_in_array</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="n">strings_array</span><span class="p">):</span>
    
    <span class="n">in_array</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">for</span> <span class="n">string_i</span> <span class="ow">in</span> <span class="n">strings_array</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">string_i</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">string</span><span class="p">):</span>
            <span class="n">in_array</span> <span class="o">=</span> <span class="kc">True</span>
            
    <span class="k">return</span> <span class="n">in_array</span>
        
    
<span class="c1">#%%</span>

<span class="n">item_t_border_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;edge_id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;direction_normal&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;edge_length&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cum_edge_length&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">border_2d_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_2d</span><span class="p">))</span>

<span class="n">item_t_border_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cum_area&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">border_3d_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_3d</span><span class="p">))</span>

<span class="n">item_t_group</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">group_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_group</span><span class="p">))</span>

<span class="n">key_typeGroup</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span>
<span class="n">value_typeGroup</span> <span class="o">=</span> <span class="n">group_lt</span>

<span class="c1"># item_t_border_3d = np.dtype([(&#39;triangle_ids&#39;, np.int64, (3,)),],  align=True)</span>

<span class="c1"># border_3d_lt = nb.typeof(np.zeros(1, dtype = item_t_border_2d))</span>

<span class="n">spec</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;triangle_ids_exclTransp&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;AABB&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;box_lengths&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;centroid&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;border_2d&#39;</span><span class="p">,</span> <span class="n">border_2d_lt</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;border_length&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;border_3d&#39;</span><span class="p">,</span> <span class="n">border_3d_lt</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;border_area&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;groups&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">key_typeGroup</span><span class="p">,</span> <span class="n">value_typeGroup</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;box_overlap&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">),</span>
<span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">Compartment</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compartment class contains attributes and methods used to describe a triangulated mesh compartment.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    triangle_ids : `int64[:]`</span>
<span class="sd">        triangle indices of the compartment mesh.</span>
<span class="sd">    triangle_ids_exclTransp : `int64[:]`</span>
<span class="sd">        triangle indices of the compartment mesh, escluding triangles marked as transparent.</span>
<span class="sd">    name : `str`</span>
<span class="sd">        Name of the compartment.</span>
<span class="sd">    AABB : `float64[:,:]`</span>
<span class="sd">        Axis Aligned Bounding Box of the compartment</span>
<span class="sd">    origin : `float64[:]`</span>
<span class="sd">        coordinates of AABB origin (AABB[0])</span>
<span class="sd">    box_lengths : `float64[:]`</span>
<span class="sd">        length of AABB in each dimension</span>
<span class="sd">    centroid : `float64[:]`</span>
<span class="sd">        centroid of mesh</span>
<span class="sd">    border_2d : `array_like 1-D`</span>
<span class="sd">        Information about edge of intersection between mesh and simualtion box</span>
<span class="sd">        </span>
<span class="sd">        `data-type: np.dtype([(&#39;edge_id&#39;, np.int64), (&#39;triangle_ids&#39;, np.int64),(&#39;direction_normal&#39;, np.float64, (3,)), (&#39;edge_length&#39;, np.float64),(&#39;cum_edge_length&#39;, np.float64),],  align=True)`</span>
<span class="sd">    border_length : `float64`</span>
<span class="sd">        length of edge of intersection between mesh and simualtion box</span>
<span class="sd">    border_3d : `array_like 1-D`</span>
<span class="sd">        Information about faces of intersection between mesh and simulation box</span>
<span class="sd">        </span>
<span class="sd">        `data-type: np.dtype([(&#39;triangle_ids&#39;, np.int64), (&#39;cum_area&#39;, np.float64),],  align=True)`</span>
<span class="sd">    border_area : float64</span>
<span class="sd">        area of intersection between mesh and simualtion box</span>
<span class="sd">    groups : `array_like 1-D`</span>
<span class="sd">        triangle ids of face groups</span>
<span class="sd">        </span>
<span class="sd">        data-type: `np.dtype([(&#39;triangle_ids&#39;, np.int64),],  align=True)`</span>
<span class="sd">    area : `float64`</span>
<span class="sd">        Total area of mesh surface</span>
<span class="sd">    volume : `float64`</span>
<span class="sd">        Total mesh volume</span>
<span class="sd">    box_overlap : `bool`</span>
<span class="sd">        True is any intersection between mesh and simulation box</span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    calc_centroid_radius_AABB(self, System):</span>
<span class="sd">        calculates some general properties of the mesh compartment</span>
<span class="sd">    add_border_2d(triangle_ids_border, System):</span>
<span class="sd">        Registers the edge of intersection (if exists) between compartment mesh and simulation box.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangle_ids</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">triangle_ids_transparent</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids_exclTransp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tri_id</span> <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids</span> <span class="k">if</span> <span class="n">tri_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">triangle_ids_transparent</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids_exclTransp</span> <span class="o">=</span> <span class="n">triangle_ids</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">triangle_ids</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">comp_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">key_typeGroup</span><span class="p">,</span> <span class="n">value_typeGroup</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids</span><span class="p">:</span>
            <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;comp_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_id</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">calc_centroid_radius_AABB</span><span class="p">(</span><span class="n">System</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_overlap</span> <span class="o">=</span> <span class="kc">False</span>
        
<div class="viewcode-block" id="Compartment.calc_centroid_radius_AABB"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.Compartment.calc_centroid_radius_AABB">[docs]</a>    <span class="k">def</span> <span class="nf">calc_centroid_radius_AABB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Calculates some general properties of the mesh compartment</span>
<span class="sd">        </span>
<span class="sd">             - area</span>
<span class="sd">             - volume</span>
<span class="sd">             - centroid</span>
<span class="sd">             - AABB (Axis Aligned Bounding Box), origin, box_lengths</span>
<span class="sd">             </span>
<span class="sd">        The centroid (geometric center) of the mesh is calculated by averaging over</span>
<span class="sd">        all triangles centroids, weighted by their area.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        System : `obj`</span>
<span class="sd">            Instance of System class</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids_exclTransp</span><span class="p">:</span>
            
            <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">+=</span> <span class="n">triangle_area</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span>
        <span class="n">area_sum</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">:</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">+=</span> <span class="n">triangle_volume_signed</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">);</span>
            
            <span class="n">center</span> <span class="o">=</span> <span class="p">(</span><span class="n">p0</span> <span class="o">+</span> <span class="n">p1</span> <span class="o">+</span> <span class="n">p2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span> <span class="c1"># center of tetrahedron</span>
            <span class="n">area</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">,</span><span class="n">p2</span><span class="o">-</span><span class="n">p0</span><span class="p">))</span>  <span class="c1"># signed volume of tetrahedron</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span> <span class="o">+=</span> <span class="n">area</span><span class="o">*</span><span class="n">center</span>
            <span class="n">area_sum</span> <span class="o">+=</span> <span class="n">area</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span> <span class="o">/=</span> <span class="n">area_sum</span>
        
        <span class="c1">###############################</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="c1"># Since we iterate over all triangles, vertices are accounted for multiple times.</span>
        <span class="c1"># However, this should not be a huge performance issue here. Still, I should probably come up</span>
        <span class="c1"># with a better solution at some point.</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="c1"># for vert_idx in self.triangles[:,i]:</span>
            <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">:</span>
                <span class="n">vert_idx</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">vert_idx</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="o">&lt;</span><span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">d</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">vert_idx</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">vert_idx</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">d</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">d</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">vert_idx</span><span class="p">][</span><span class="n">d</span><span class="p">]</span>
                        

        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c1">#1.0 #</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="c1">#1.0 #</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="c1">#1.0 #</span></div>
        
    
<div class="viewcode-block" id="Compartment.add_border_2d"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.Compartment.add_border_2d">[docs]</a>    <span class="k">def</span> <span class="nf">add_border_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangle_ids_border</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registers the edge of intersection (if exists) between compartment mesh and simulation box. The intersection line is needed for fixed concdentration simulations as new molecules enter the simualtion box along this intersection line.</span>
<span class="sd">        </span>
<span class="sd">        .. admonition:: Note</span>
<span class="sd">        </span>
<span class="sd">            See naming conventions for face groups!</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        triangle_ids_border : `int64[:]`</span>
<span class="sd">            triangle ids of the mesh triangle along the border</span>
<span class="sd">        System : `obj`</span>
<span class="sd">            Instance of System class</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="c1"># eps = 1e-3</span>
        
        <span class="n">System</span><span class="o">.</span><span class="n">boundary_2d</span> <span class="o">=</span> <span class="kc">True</span>
        
        
        <span class="n">edge_ids</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">direction_normals</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">edge_lengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">triangle_ids</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># Edges = []</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">)):</span>

            <span class="n">tri_id</span> <span class="o">=</span> <span class="n">triangle_ids_border</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
            <span class="c1"># Find the edge that aligns with one of the box faces:</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                edge:   [0,1]</span>
<span class="sd">                        [1,2]</span>
<span class="sd">                        [0,2]</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="n">edge</span> <span class="o">=</span> <span class="n">edges</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="n">v0</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">v1</span> <span class="o">=</span> <span class="n">edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v0</span><span class="p">]</span>
                <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span>
                
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">dim</span><span class="p">],</span><span class="n">p1</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="ow">and</span> <span class="n">isclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">dim</span><span class="p">]),</span><span class="nb">abs</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>
                        
                        <span class="c1"># Change the vertex position such that the edge aligns</span>
                        <span class="c1"># exactly with the simulation box border:</span>
                        <span class="n">p0</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">System</span><span class="o">.</span><span class="n">update_mesh</span><span class="p">(</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">v0</span><span class="p">)</span>
                        
                        <span class="n">p1</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">p1</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">System</span><span class="o">.</span><span class="n">update_mesh</span><span class="p">(</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">v1</span><span class="p">)</span>
                        <span class="c1">######</span>
                        
                        <span class="n">edge_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                      
                        <span class="c1"># Calculate the direction normal vector:</span>
                        <span class="n">v_edge</span> <span class="o">=</span> <span class="n">p0</span><span class="o">-</span><span class="n">p1</span>
                        <span class="n">normal</span> <span class="o">=</span>  <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cross</span><span class="p">(</span><span class="n">v_edge</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
                        <span class="n">direction</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
                        
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">direction</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">p0</span><span class="p">[</span><span class="n">dim</span><span class="p">]):</span>
                            <span class="n">direction</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                        
                        <span class="n">direction_normals</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
                        
                        <span class="n">edge_lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v_edge</span><span class="p">))</span>
                        
                        <span class="n">triangle_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tri_id</span><span class="p">)</span>
                        
                        <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;border_edge&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;border_dim&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim</span>
                        <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;border_normal&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">direction</span>
         
        <span class="c1">#---------</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ids</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_2d</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edge_ids</span><span class="p">)):</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;direction_normal&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">direction_normals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;edge_length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">edge_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">triangle_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="s1">&#39;cum_edge_length&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="s1">&#39;edge_length&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">border_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="s1">&#39;edge_length&#39;</span><span class="p">])</span></div>
            
<div class="viewcode-block" id="Compartment.add_border_3d"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.Compartment.add_border_3d">[docs]</a>    <span class="k">def</span> <span class="nf">add_border_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangle_ids_border</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registers the area of intersection (if exists) between compartment mesh and simulation box. The intersection area is needed for fixed concdentration simulations as new molecules enter the simualtion box along the faces of the intersection.</span>
<span class="sd">        </span>
<span class="sd">        .. admonition:: Note</span>
<span class="sd">        </span>
<span class="sd">            See naming conventions for face groups!</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        triangle_ids_border : `int64[:]`</span>
<span class="sd">            triangle ids of the mesh triangle along the border</span>
<span class="sd">        System : `obj`</span>
<span class="sd">            Instance of System class</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># eps = 1e-3</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">border_3d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_3d</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">)):</span>

            <span class="n">tri_id</span> <span class="o">=</span> <span class="n">triangle_ids_border</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">border_3d</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_id</span>
            
            <span class="c1"># Make sure the box vertices lie exactly on the simulation box border:</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">vert</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">isclose</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">]),</span><span class="nb">abs</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)):</span>
                        
                        <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">])</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        
                        <span class="n">System</span><span class="o">.</span><span class="n">update_mesh</span><span class="p">(</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">])</span>
            
        
        <span class="bp">self</span><span class="o">.</span><span class="n">border_3d</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_ids_border</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">border_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_ids_border</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_overlap</span> <span class="o">=</span> <span class="kc">True</span></div>
            
<div class="viewcode-block" id="Compartment.add_group"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.Compartment.add_group">[docs]</a>    <span class="k">def</span> <span class="nf">add_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">triangle_ids_group</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registers any triangle/face group that has been defined in the mesh ob file that is not a 2d or 3d border of intersectioj with the simulation box </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        .. admonition:: Note</span>
<span class="sd">        </span>
<span class="sd">            See naming conventions for face groups!</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        group_name : `str`</span>
<span class="sd">            name of the group</span>
<span class="sd">        triangle_ids_group : `int64[:]`</span>
<span class="sd">            triangle ids of the mesh triangle group</span>
<span class="sd">        System : `obj`</span>
<span class="sd">            Instance of System class</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_group</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_group</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_group</span><span class="p">)):</span>

            <span class="n">tri_id</span> <span class="o">=</span> <span class="n">triangle_ids_group</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_id</span></div>
        

<span class="c1">#%%</span>


<span class="c1">#TODO: molecule_type does not need to be a class, could simply use a struct instead!</span>

<span class="n">item_t_UMR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">spec_moltype</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;pos&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;h_membrane&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;radii&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;pos_rb&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;radii_rb&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;types&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="s1">&#39;type&#39;</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U20&#39;</span><span class="p">)))),</span>
    <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;radius_2d&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Dtrans&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Dtrans_2d&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Drot&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Drot_2d&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;mu_rb&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;mu_tb&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;mu_rb_sqrt&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;mu_tb_sqrt&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;D_rr&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;D_tt&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;type_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;r_mean&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;r_mean_pair&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;collision_type&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;transition_rate_total&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;number_umr&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;um_reaction&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">boolean</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;concentration&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;concentration_surface&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;l_perp&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">spec_moltype</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">MoleculeType</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A brief summary of the classes purpose and behavior</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : `str`</span>
<span class="sd">        Name of molecule    </span>
<span class="sd">    type_id : `int64`</span>
<span class="sd">        ID of molecule type    </span>
<span class="sd">    collision_type : `int64` {0,1}</span>
<span class="sd">        collision type of molecule. (Default = 0)</span>
<span class="sd">    pos : `float64[N,3]`</span>
<span class="sd">        positions of each particle </span>
<span class="sd">    radii : `float64[N]`</span>
<span class="sd">        radii of particles</span>
<span class="sd">    pos_rb : `float64[N,3]`</span>
<span class="sd">        position of each particle with exculded volume radius &gt; 0.0</span>
<span class="sd">    radii_rb : `float64[N]`</span>
<span class="sd">        radii of particles with exculded volume radius &gt; 0.0</span>
<span class="sd">    types : `array_like 1-D`</span>
<span class="sd">        array of names of particle types</span>
<span class="sd">        `dtype : np.dtype(&#39;U20&#39;)`</span>
<span class="sd">    radius : `float64`</span>
<span class="sd">        Total radius of molecule</span>
<span class="sd">    radius_2d : `float64`</span>
<span class="sd">        Total radius of molecule in plane (needed when distributing molecules on surface)  </span>
<span class="sd">    Dtrans : `float64`</span>
<span class="sd">        Translational diffusion coefficient </span>
<span class="sd">    Drot : `float64`</span>
<span class="sd">        Rotational diffusion coefficient </span>
<span class="sd">    mu_rb : `float64[3,3]`</span>
<span class="sd">        Rotational mobility tensor</span>
<span class="sd">    mu_tb : `float64[3,3]`</span>
<span class="sd">        Translational mobility tensor</span>
<span class="sd">    mu_rb_sqrt : `float64[3,3]`</span>
<span class="sd">        Rotational mobility tensor</span>
<span class="sd">    mu_tb_sqrt : `float64[3,3]`</span>
<span class="sd">        Square root of translational mobility tensor</span>
<span class="sd">    mu_rb_sqrt : `float64[3,3]`</span>
<span class="sd">        Square root of rotational mobility tensor</span>
<span class="sd">    D_tt : `float64[3,3]`</span>
<span class="sd">        Translational diffusion tensor</span>
<span class="sd">    D_rr : `float64[3,3]`</span>
<span class="sd">        Rotational diffusion tensor</span>
<span class="sd">    r_mean : `float64`</span>
<span class="sd">        Average radial displacement of diffusing molecule</span>
<span class="sd">    volume : `float64`</span>
<span class="sd">        Volume of molecule</span>
<span class="sd">    transition_rate_total : `float64`</span>
<span class="sd">        Total transition rate of unimolecular reactions</span>
<span class="sd">    um_reaction : `bool`</span>
<span class="sd">        True if unimolecular reaction has been defined for molecule type</span>
<span class="sd">    number_umr : `int64`</span>
<span class="sd">        Number of unimolecular reactions</span>
<span class="sd">    concentration : `float64[:]`</span>
<span class="sd">        concentration of molecule in volume of each compartment outside simulation box (Needed for simulation with fixed concentration boundary condition)</span>
<span class="sd">    concentration_surface : `float64[:]`</span>
<span class="sd">        concentration of molecule on surface of each compartment outside simulation box (Needed for simulation with fixed concentration boundary)</span>
<span class="sd">    l_perp : `float64`</span>
<span class="sd">        Mean diffusive displacement of molecule perpendicular to a plane.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    update_um_reaction(rate)</span>
<span class="sd">        Updates the the total transitaion rate for unimolecular reactions of this molecule type.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">types</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">collision_type</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">h_membrane</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pos</span> <span class="o">=</span> <span class="n">pos</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">types</span> <span class="o">=</span> <span class="n">types</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii</span> <span class="o">=</span> <span class="n">radii</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">ntypes_rb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collision_type</span> <span class="o">=</span> <span class="n">collision_type</span>
        
        <span class="k">if</span> <span class="n">h_membrane</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_membrane</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">h_membrane</span> <span class="o">=</span> <span class="n">h_membrane</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">concentration_surface</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">number_umr</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pos_rb</span> <span class="o">=</span> <span class="n">pos</span><span class="p">[</span><span class="n">radii</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radii_rb</span> <span class="o">=</span> <span class="n">radii</span><span class="p">[</span><span class="n">radii</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">radius_2d</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">distance_from_center</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">distance_from_center_2d</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pos</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">+=</span> <span class="mi">4</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">**</span><span class="mi">3</span>
                
                <span class="n">distance_from_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="p">)</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">distance_from_center_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">distance_from_center</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">=</span> <span class="n">distance_from_center</span>
                    
                <span class="k">if</span> <span class="n">distance_from_center_2d</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius_2d</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">radius_2d</span> <span class="o">=</span> <span class="n">distance_from_center_2d</span>
                    
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">radius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Warning</span><span class="p">(</span><span class="s1">&#39;Molecules must not have a total radius of 0!&#39;</span><span class="p">)</span>
            
        <span class="c1"># self.update_mobility_matrix(System)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Dtrans</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span><span class="o">/</span><span class="p">(</span><span class="mi">6</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">eta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="p">)</span> <span class="c1">#in mum^2/s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Drot</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span><span class="o">/</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">eta</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">radius</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#in 1/s</span>
        
        
        
<div class="viewcode-block" id="MoleculeType.update_um_reaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.MoleculeType.update_um_reaction">[docs]</a>    <span class="k">def</span> <span class="nf">update_um_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rate</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Updates the the total transitaion rate for unimolecular reactions of this molecule type.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rate : float64</span>
<span class="sd">            Reaction rate </span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        We cannot tell when a bimolecular reaction will occur, beacause we do not know when </span>
<span class="sd">        two diffusing molecules meet. However, for unimolecular reactions the expected </span>
<span class="sd">        lifetime distribution is known in case there is no interruption by any bimolecular reaction: </span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            :label: rho</span>
<span class="sd">            </span>
<span class="sd">            \\rho(t) = k*e^{-k t},</span>
<span class="sd">            </span>
<span class="sd">        where :math:`k = \sum_i^n(k_i)`.</span>
<span class="sd">        As such, we can schedule a reaction event by using the upper equation :cite:t:`Stiles2001`, :cite:t:`Erban2007`. </span>
<span class="sd">        For a unimolecular reaction occuring between t+dt we add this reaction to the reaction list </span>
<span class="sd">        evaluated at time t+dt. The reaction is then processed as any other bimolecular reaction that may </span>
<span class="sd">        occur within that timestep. If the unimolecular reaction is picked, it needs to be checked if different </span>
<span class="sd">        unimolecular reaction pathways exist. The fractional probablity for each of the n </span>
<span class="sd">        transitions is:</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            :label: pi</span>
<span class="sd">            </span>
<span class="sd">            p_i = k_i/\sum_n(k_j)</span>
<span class="sd">            </span>
<span class="sd">        Based on the latter equation one of the n unimolecular transitions will be picked.</span>
<span class="sd">        As for bimolecular reactions, all other reactions that exist for the educt will be deleted.</span>
<span class="sd">        In case a bimolecular reaction is picked before the unimolecular reaction and in case it is successfull, the unimolecular reaction will be deleted from the reaction list and a new reaction time is drawn for the product molecule of the bimolecular reaction if any unimolecular reaction has been defined for the product type.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">number_umr</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">transition_rate_total</span> <span class="o">+=</span> <span class="n">rate</span></div>
        
<span class="c1">#%%</span>

<span class="n">item_t_bpr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;ids&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">100</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="n">item_t_ptype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;h&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;transition_rate_total&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;UP_reaction&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bond_educt_id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> 

<span class="n">key_typePT</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span>
<span class="n">value_typePT</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_ptype</span><span class="p">))</span>

<span class="n">key_mt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span> 
<span class="n">value_mt</span> <span class="o">=</span> <span class="n">MoleculeType</span><span class="o">.</span><span class="n">class_type</span><span class="o">.</span><span class="n">instance_type</span>

<span class="n">keytype_RD</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span>
<span class="n">valuetype_RD</span> <span class="o">=</span> <span class="n">rru</span><span class="o">.</span><span class="n">Reaction</span><span class="o">.</span><span class="n">class_type</span><span class="o">.</span><span class="n">instance_type</span>

<span class="n">item_t_inter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">5</span><span class="p">,))),</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;U20&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;global&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cutoff&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;breakable&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">item_t_react</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;defined&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;bond&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;enzyme&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;radius&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;U20&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;type_id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">,</span> <span class="s1">&#39;U2&#39;</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="n">item_t_barostat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;mu_tensor&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),(</span><span class="s1">&#39;Tau_P&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;P0&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
<span class="n">barostat_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_barostat</span><span class="p">))</span>

<span class="c1"># item_t_baryc = np.dtype([(&#39;d00&#39;, np.float64),(&#39;d01&#39;, np.float64),(&#39;d11&#39;, np.float64),(&#39;denom&#39;, np.float64)],  align=True)</span>

<span class="n">item_t_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;triangles&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;edges&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;border_edge&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;border_dim&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;border_normal&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;neighbours&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">)),</span> <span class="p">(</span><span class="s1">&#39;normal&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">4</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;triangle_distance&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;triangle_centroid&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;stamp&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;comp_id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;group_id&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">mesh_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_mesh</span><span class="p">))</span>

<span class="c1"># TODO: Might be usefull to add a struct for mesh edges, so we can better save edge properties, e.g. for borders. Also, we would have less memory overhead compared to saving edge data for each triangle, which introduces some redudance!</span>
<span class="n">item_t_edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;edge&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">,</span> <span class="p">(</span><span class="mi">2</span><span class="p">,)),</span> <span class="p">(</span><span class="s1">&#39;border_edge&#39;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">edges_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_edges</span><span class="p">))</span>


<span class="n">Comp_keytype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span>
<span class="n">Comp_valuetype</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">class_type</span><span class="o">.</span><span class="n">instance_type</span>

<span class="n">item_t_border_box</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;cum_area&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">),],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">border_box_lt</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_box</span><span class="p">))</span>

<span class="n">list_int64</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>

<span class="n">spec</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Np&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Nmol&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;dim&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dt&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;box_lengths&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Epot&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;AABB&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span> <span class="c1"># AABB of the simulation box</span>
    <span class="p">(</span><span class="s1">&#39;AABB_all&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span> <span class="c1"># AABB covering all mesh compartments</span>
    <span class="p">(</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;empty&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;vertices&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,::</span><span class="mi">1</span><span class="p">]),</span>
    <span class="p">(</span><span class="s1">&#39;vertex_triangles&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">list_int64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;Mesh&#39;</span><span class="p">,</span> <span class="n">mesh_lt</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;N_triangles&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;box_border&#39;</span><span class="p">,</span> <span class="n">border_box_lt</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;box_area&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;boundary_2d&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;triangle_ids_transparent&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;Compartments&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">Comp_keytype</span><span class="p">,</span> <span class="n">Comp_valuetype</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;n_comps&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;area&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;cell_length_per_dim&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;Ncell&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;AABB_centers&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;CellList&#39;</span><span class="p">,</span> <span class="n">CellListMesh</span><span class="o">.</span><span class="n">class_type</span><span class="o">.</span><span class="n">instance_type</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;particle_types&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">key_typePT</span><span class="p">,</span> <span class="n">value_typePT</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;particle_id_to_name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;ntypes&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;ntypes_rb&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;kB&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;Temp&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;eta&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;max_reactions_per_particle&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;reactions_left&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;molecule_types&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">key_mt</span><span class="p">,</span> <span class="n">value_mt</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;Reactions_Dict&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">keytype_RD</span><span class="p">,</span> <span class="n">valuetype_RD</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;reaction_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;bp_reaction_ids&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_bpr</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;up_reaction_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;um_reaction_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;interaction_args&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_inter</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;interaction_IDs&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;reaction_args&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_react</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;molecule_id_to_name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">))),</span>
    <span class="p">(</span><span class="s1">&#39;mesh_scale&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;mesh&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;boundary_condition&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;boundary_condition_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;interactions&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;avogadro&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;kbt&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;wall_force&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;barostat&#39;</span><span class="p">,</span> <span class="n">barostat_lt</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;seed&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;mol_type_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;react_type_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;virial_scalar&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;virial_scalar_Wall&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;virial_tensor&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;virial_tensor_Wall&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;Pressure&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;N_bonds&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span> <span class="c1"># This is the id to identify the compartment. For Wolrd it is 0.</span>
    <span class="p">(</span><span class="s1">&#39;count&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;current_step&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;time_stamp&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;interaction_defined&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">[:,:]),</span>
    <span class="p">(</span><span class="s1">&#39;pair_interaction&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">boolean</span><span class="p">[:]),</span>
    <span class="p">(</span><span class="s1">&#39;length_unit&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;time_unit&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;energy_unit&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;length_units_prefix&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;time_units_prefix&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">)),</span>
    <span class="c1"># (&#39;energy_units&#39;, nb.types.DictType(nb.types.string, nb.float64)),</span>
    <span class="p">(</span><span class="s1">&#39;max_cells_per_dim&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;dx_rand&#39;</span><span class="p">,</span> <span class="n">rnd</span><span class="o">.</span><span class="n">Interpolate</span><span class="o">.</span><span class="n">class_type</span><span class="o">.</span><span class="n">instance_type</span><span class="p">),</span>
    <span class="p">(</span><span class="s1">&#39;compartments_id&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">DictType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)),</span>
    <span class="p">(</span><span class="s1">&#39;compartments_name&#39;</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">)),</span>
<span class="p">]</span>

<span class="nd">@jitclass</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">System</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A brief summary of the classes purpose and behavior</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    N : `nb.int64`</span>
<span class="sd">        Total number of molecules in simulation</span>
<span class="sd">    Np : `nb.int64`</span>
<span class="sd">        Total number of particles in simulation</span>
<span class="sd">    Nmol : `nb.int64[:]`</span>
<span class="sd">        Number of molecules per molecule type</span>
<span class="sd">    dim : `nb.int64 (3)`</span>
<span class="sd">        System dimension</span>
<span class="sd">    dt : `nb.float64`</span>
<span class="sd">        Integration time step</span>
<span class="sd">    box_lengths : `nb.float64[:]`</span>
<span class="sd">        Length of simulation box in each dimension</span>
<span class="sd">    volume : `nb.float64`</span>
<span class="sd">        Simulation box volume</span>
<span class="sd">    Epot : `nb.float64[:]`</span>
<span class="sd">        Total potential energy</span>
<span class="sd">    AABB : `nb.float64[2,3]`</span>
<span class="sd">        Axis Aligned Bounding Box of simulation box</span>
<span class="sd">    AABB_all : `nb.float64[2,3]`</span>
<span class="sd">        Axis Aligned Bounding Box of simulation box plus mesh compartments (only different from simulation box if compartments overlap with box)</span>
<span class="sd">    origin : `nb.float64[3]`</span>
<span class="sd">        origin of simulation box (AABB[0])</span>
<span class="sd">    empty : `nb.int64 (-1)`</span>
<span class="sd">        empty flag</span>
<span class="sd">    vertices : `nb.float64[N,3]`</span>
<span class="sd">        Position of all vertices in each dimension</span>
<span class="sd">    Mesh : `array_like`</span>
<span class="sd">        Mesh data</span>

<span class="sd">        `dtype : np.dtype([(&#39;triangles&#39;, np.int64, (3,)), (&#39;edges&#39;, np.int64, (3,2)), (&#39;border_edge&#39;, np.int64, (3,)), (&#39;border_dim&#39;, np.int64, (3,)), (&#39;border_normal&#39;, np.float64, (3,3)), (&#39;neighbours&#39;, np.int64, (3,)), (&#39;triangle_coord&#39;, np.float64, (4,3)), (&#39;normal&#39;, np.float64, (3,)), (&#39;triangle_distance&#39;, np.float64), (&#39;triangle_centroid&#39;, np.float64, (3,)), (&#39;triangle_area&#39;, np.float64), (&#39;stamp&#39;, np.uint64), (&#39;comp_id&#39;, np.uint64), (&#39;group_id&#39;, np.uint64),],  align=True)`</span>
<span class="sd">    N_triangles : `nb.int64`</span>
<span class="sd">        Total number of mesh triangles</span>
<span class="sd">    triangle_ids : `nb.int64[:]`</span>
<span class="sd">        triangle ids of all compartments, excluding transparent faces (borders)</span>
<span class="sd">    box_border : `border_box_lt`</span>
<span class="sd">        Triangle faces of the simulation box border (needed for distributing molecules in case of fixed concentration boundary condition)</span>
<span class="sd">    box_area : `nb.float64`</span>
<span class="sd">        Area of triangle faces of the simulation box border</span>
<span class="sd">    boundary_2d : `nb.types.boolean`</span>
<span class="sd">        True if intersection of compartment with simulation box exists.</span>
<span class="sd">    triangle_ids_transparent : `nb.int64[:]`</span>
<span class="sd">        Triangle ids of transparent faces (particles do not collide)</span>
<span class="sd">    Compartments : `nb.types.DictType(Comp_keytype, Comp_valuetype)`</span>
<span class="sd">        Dictionary containing the Compartment instances</span>
<span class="sd">    n_comps : `nb.int64`</span>
<span class="sd">        Total number of compartments</span>
<span class="sd">    area : `nb.float64`</span>
<span class="sd">        Total surface area of all compartments</span>
<span class="sd">    cells_per_dim : `nb.int64[3]`</span>
<span class="sd">        Number of cells in each dimension of system grid</span>
<span class="sd">    cell_length_per_dim : `nb.float64[3]`</span>
<span class="sd">        Cell length in each dimension of system grid</span>
<span class="sd">    Ncell : `nb.int64`</span>
<span class="sd">        Total number of cells of system grid</span>
<span class="sd">    AABB_centers : `nb.float64[:,3]`</span>
<span class="sd">        Center of each system grid cell</span>
<span class="sd">    CellList : `CellListMesh.class_type.instance_type`</span>
<span class="sd">        Linked cell list of mesh triangles</span>
<span class="sd">    particle_types : `nb.types.DictType(key_typePT, value_typePT)`</span>
<span class="sd">        Particle types</span>
<span class="sd">    particle_id_to_name : `nb.typeof(np.zeros(10, dtype = &#39;U20&#39;))`</span>
<span class="sd">        Returns the name of particle type by its id</span>
<span class="sd">    ntypes : `nb.uint64`</span>
<span class="sd">        Total number of particle types</span>
<span class="sd">    ntypes_rb : `nb.uint64`</span>
<span class="sd">        Total number of molecule types</span>
<span class="sd">    kB : `nb.float64`</span>
<span class="sd">        Boltzmann constant</span>
<span class="sd">    Temp : `nb.float64`</span>
<span class="sd">        Temperature of the system</span>
<span class="sd">    eta : `nb.float64`</span>
<span class="sd">        Viscosity</span>
<span class="sd">    max_reactions_per_particle : `nb.int64`</span>
<span class="sd">        Maximum number of reactions that can be defined per particle (Default = 20)</span>
<span class="sd">    reactions_left : `nb.int64`</span>
<span class="sd">        Number of reactions left</span>
<span class="sd">    molecule_types : `nb.types.DictType(key_mt, value_mt)`</span>
<span class="sd">        Information about each molecule type</span>
<span class="sd">    Reactions_Dict : `nb.types.DictType(keytype_RD, valuetype_RD)`</span>
<span class="sd">        Dictionary of reactions defined</span>
<span class="sd">    reaction_id : `nb.int64`</span>
<span class="sd">        Current reaction id</span>
<span class="sd">    up_reaction_id : `int64[:]`</span>
<span class="sd">        Reaction ids of all unimolecular particle reactions</span>
<span class="sd">    um_reaction_id : `int64[:]`</span>
<span class="sd">        Reaction ids of all unimolecular molecule reactions</span>
<span class="sd">    interaction_args : `nb.typeof(np.zeros((1,1), dtype = item_t_inter))`</span>
<span class="sd">        Arguments for each partcile-particle interaction</span>
<span class="sd">    interaction_IDs : `nb.types.DictType(nb.types.string, nb.int64)`</span>
<span class="sd">        Interaction ids of all partcile-particle interactions</span>
<span class="sd">    reaction_args : `nb.typeof(np.zeros((1,1), dtype = item_t_react))`</span>
<span class="sd">        Arguments for each particle-particle reaction (including fusion and enzymatic reactions)</span>
<span class="sd">    molecule_id_to_name : `nb.typeof(np.zeros(10, dtype = &#39;U20&#39;))`</span>
<span class="sd">        Returns the name of molecule type by its id</span>
<span class="sd">    mesh_scale : `nb.float64`</span>
<span class="sd">        Scaling factor for the compartment meshes</span>
<span class="sd">    mesh : `nb.types.boolean`</span>
<span class="sd">        True if mesh compartments have been defined</span>
<span class="sd">    boundary_condition : `nb.types.string (&#39;periodic&#39;, &#39;repulsive&#39;, &#39;fixed concentration&#39;)`</span>
<span class="sd">        Type of boundary condition</span>
<span class="sd">    boundary_condition_id : `nb.int64`</span>
<span class="sd">        Type id of boundary condition</span>
<span class="sd">    interactions : `nb.types.boolean`</span>
<span class="sd">        True if any interaction between particles has been defined</span>
<span class="sd">    avogadro : `nb.float64 (6.02214076e23)`</span>
<span class="sd">        Avogadros constant</span>
<span class="sd">    kbt : `nb.float64`</span>
<span class="sd">        Boltzmann constant * Temperature/Avogadros constant</span>
<span class="sd">    wall_force : `nb.float64`</span>
<span class="sd">        Force constant for repulsive walls (particle-boundary and particle-triangle interactions)</span>
<span class="sd">    barostat : `barostat_lt`</span>
<span class="sd">        Berendsen barostat</span>
<span class="sd">    seed : `nb.int64`</span>
<span class="sd">        Random seed of simulation if defined by user</span>
<span class="sd">    mol_type_id : `nb.types.DictType(nb.types.string, nb.int64)`</span>
<span class="sd">        Returns the id of molecule type by its name</span>
<span class="sd">    react_type_id : `nb.types.DictType(nb.types.string, nb.int64)`</span>
<span class="sd">        Returns the id of reaction type by its name</span>
<span class="sd">    virial_scalar : `nb.float64[:]`</span>
<span class="sd">        Virial (scalar)</span>
<span class="sd">    virial_scalar_Wall : `nb.float64[:]`</span>
<span class="sd">        Virial (scalar) of particle-wall interaction</span>
<span class="sd">    virial_tensor : `nb.float64[:,:,:]`</span>
<span class="sd">        Virial tensor</span>
<span class="sd">    virial_tensor_Wall : `nb.float64[:,:,:]`</span>
<span class="sd">        Virial tensor of particle-wall interaction</span>
<span class="sd">    Pressure : `nb.float64[:]`</span>
<span class="sd">        Current pressure</span>
<span class="sd">    N_bonds : `nb.int64[:,:]`</span>
<span class="sd">        Current number of bonds per particle type pair</span>
<span class="sd">    name : `nb.types.string (&#39;System&#39;)`</span>
<span class="sd">        Name of compartment</span>
<span class="sd">    id : `nb.int64 (0)`</span>
<span class="sd">        ID of compartment</span>
<span class="sd">    count : `nb.int64`</span>
<span class="sd">        Counter attribute (for debugging purposes)</span>
<span class="sd">    current_step : `nb.int64`</span>
<span class="sd">        Current simulation time step</span>
<span class="sd">    time_stamp : `nb.uint64`</span>
<span class="sd">        Gives the current number of rays that have been cast for collision detection</span>
<span class="sd">    interaction_defined : `nb.types.boolean[:,:]`</span>
<span class="sd">        True if any interaction or reaction between the two particle types has been defined</span>
<span class="sd">    pair_interaction : `nb.types.boolean[:]`</span>
<span class="sd">        True if any pair-interaction has been defined for this particle type</span>
<span class="sd">    length_units_prefix : `nb.types.DictType(nb.types.string, nb.float64)`</span>
<span class="sd">        Length unit prefix (Default = 1e6 (&#39;micrometer&#39;))</span>
<span class="sd">    time_units_prefix : `nb.types.DictType(nb.types.string, nb.float64)`</span>
<span class="sd">        Time unit prefix (Default = 1e0 (&#39;s&#39;))</span>
<span class="sd">    max_cells_per_dim : `nb.int64`</span>
<span class="sd">        Maximum number of cells of system grid in each dimension (Default = 50)</span>
<span class="sd">    dx_rand : `rnd.Interpolate.class_type.instance_type`</span>
<span class="sd">        Interpolation of inverse cumulative probability function describing the displacement of molecules along a planes normal after crossing by diffusion.</span>
<span class="sd">    compartments_id : `nb.types.DictType(nb.types.string, nb.int64)`</span>
<span class="sd">        Returns the compartment id by its name</span>
<span class="sd">    compartments_name : `nb.types.ListType(nb.types.string)`</span>
<span class="sd">        Returns the compartment name by its id</span>

<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    add_system_grid()</span>
<span class="sd">        Calculates properties of the system cell grid.</span>
<span class="sd">    add_barostat_berendsen(Tau_P, P0, start)</span>
<span class="sd">        Adds a berendsen barostat to the system.</span>
<span class="sd">    register_molecule_type(molecule_name, particle_pos, particle_types, collision_type = 0)</span>
<span class="sd">        Regsiters a molecule type.</span>
<span class="sd">    set_diffusion_tensor(molecule_name, D_tt, D_rr, mu_tb, mu_rb, mu_tb_sqrt, mu_rb_sqrt)</span>
<span class="sd">        Sets the diffusion tensor for a molecule type.</span>
<span class="sd">    fixed_concentration_at_boundary(molecule_name, C, comp_name, location)</span>
<span class="sd">        Sets the fixed concentration boundary given a concentartion for each defined molecule type and for each compartents volume and surface.</span>
<span class="sd">    register_particle_type(Type, radius)</span>
<span class="sd">        Registers a particle type.</span>
<span class="sd">    set_compartments(comp_name, triangle_ids)</span>
<span class="sd">        Sets a compartment given its triangle ids.</span>
<span class="sd">    add_border_3d(triangle_ids_border)</span>
<span class="sd">        Registers the border faces of an intersection between compartments and the simulation box (Needed for fixed concentration boundary condition)</span>
<span class="sd">    add_mesh(vertices, triangles, mesh_scale = 1.0, box_triangle_ids = None, triangle_ids_transparent = None)</span>
<span class="sd">        Set up the mesh for the mesh compartments.</span>
<span class="sd">    add_edges()</span>
<span class="sd">        Finds the edges of each triangle and adds them to the Mesh struct.</span>
<span class="sd">    add_neighbours()</span>
<span class="sd">        Finds the neighbours of each triangle and adds them to the Mesh struct.</span>
<span class="sd">    get_AABB_centers()</span>
<span class="sd">        Calculates the center of each cell of the system grid.</span>
<span class="sd">    create_CellList()</span>
<span class="sd">        Creates the linked cell list for the triangulated meshes (Used during collision detection).</span>
<span class="sd">    </span>
<span class="sd">    ..</span>
<span class="sd">        **Particle interactions**</span>
<span class="sd">    </span>
<span class="sd">    add_interaction(self, interaction_type, type1, type2, parameters, bond = False, breakable = False)</span>
<span class="sd">    </span>
<span class="sd">    ..</span>
<span class="sd">        **Uniparticle reactions**</span>
<span class="sd">    </span>
<span class="sd">    add_up_reaction(self, reaction_type, educt_type, rate, product_types, product_loc, product_direction, radius)</span>
<span class="sd">     </span>
<span class="sd">    ..</span>
<span class="sd">        **Unimolecular reactions**</span>
<span class="sd">    </span>
<span class="sd">    add_um_reaction(self, reaction_type, educt_type, rate, product_types, product_loc, product_direction, radius)</span>
<span class="sd">    </span>
<span class="sd">    ..</span>
<span class="sd">        **Biparticle reactions**</span>
<span class="sd">        </span>
<span class="sd">    add_bp_reaction(self, reaction_type, educt_types, product_types, rate, radius, interaction_type = None, interaction_parameters = None)</span>
<span class="sd">        </span>
<span class="sd">    ..</span>
<span class="sd">        **Bimolecular reactions**</span>
<span class="sd">    </span>
<span class="sd">    add_bm_reaction(self, reaction_type, educt_types, product_types, particle_pairs, pair_rates, pair_Radii)</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">]),</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mf">293.15</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="mf">1e-21</span><span class="p">,</span> <span class="n">boundary_condition</span> <span class="o">=</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="n">wall_force</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">length_unit</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span><span class="p">,</span> <span class="n">energy_unit</span> <span class="o">=</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">,</span> <span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_cells_per_dim</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">length_unit</span> <span class="o">=</span> <span class="n">length_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">energy_unit</span> <span class="o">=</span> <span class="n">energy_unit</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">length_units_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_units_prefix</span><span class="p">[</span><span class="s1">&#39;micrometer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length_units_prefix</span><span class="p">[</span><span class="s1">&#39;nanometer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e9</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span><span class="p">[</span><span class="s1">&#39;s&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span><span class="p">[</span><span class="s1">&#39;ms&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span><span class="p">[</span><span class="s1">&#39;mus&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span><span class="p">[</span><span class="s1">&#39;ns&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e9</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;System&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Np</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">=</span> <span class="n">box_lengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_cells_per_dim</span> <span class="o">=</span> <span class="n">max_cells_per_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="c1"># self.Epot = 0.0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">=</span> <span class="n">boundary_condition</span>
        <span class="k">if</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;fixed concentration&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s2">&quot;Unknown boundary condition!&quot;</span><span class="p">)</span> 
            
        <span class="c1"># if boundary_condition == &#39;repulsive&#39;:</span>
        <span class="k">if</span> <span class="n">wall_force</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wall_force</span> <span class="o">=</span> <span class="n">wall_force</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wall_force</span> <span class="o">=</span> <span class="mf">1e20</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">length_units_prefix</span><span class="p">[</span><span class="n">length_unit</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
            
        <span class="k">if</span> <span class="n">seed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_scale</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">box_lengths</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">empty</span> <span class="o">=</span> <span class="o">-</span><span class="mi">50</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_reactions_per_particle</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">key_typePT</span><span class="p">,</span> <span class="n">value_typePT</span><span class="p">)</span><span class="c1">#</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_id_to_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_id_to_name</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">avogadro</span> <span class="o">=</span> <span class="mf">6.02214076e23</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kB</span> <span class="o">=</span> <span class="mf">1.380649e-23</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">length_units_prefix</span><span class="p">[</span><span class="n">length_unit</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">time_units_prefix</span><span class="p">[</span><span class="n">time_unit</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="c1"># J/K = N*m/K = kg*m^2/(s^2*K)</span>
        <span class="k">if</span> <span class="n">energy_unit</span> <span class="o">==</span> <span class="s1">&#39;kJ/mol&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kbt</span> <span class="o">=</span> <span class="mf">1.380649e-23</span><span class="o">*</span><span class="n">Temp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">avogadro</span><span class="o">*</span><span class="mf">1e-3</span> <span class="c1"># kJ/mol = N*m/(mol*1000) = kg*m^2/(s^2*mol*1000)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">kbt</span> <span class="o">=</span> <span class="mf">1.380649e-23</span><span class="o">*</span><span class="n">Temp</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">avogadro</span><span class="o">*</span><span class="mf">1e-3</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The only currently supported unit for energy is kJ/mol !&#39;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">Temp</span> <span class="o">=</span> <span class="n">Temp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">key_mt</span><span class="p">,</span> <span class="n">value_mt</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">keytype_RD</span><span class="p">,</span> <span class="n">valuetype_RD</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span> <span class="o">=</span> <span class="mi">0</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;harmonic_repulsion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;harmonic_attraction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;screened_electrostatics&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;Lennard_Jones&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;Weeks_Chandler_Anderson&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;repulsive_membrane&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;CSW&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="s1">&#39;PHS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="kc">False</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_barostat</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mol_type_id</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol_type_id</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mol_type_id</span><span class="p">[</span><span class="s1">&#39;Surface&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;bind&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># Particle only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;conversion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;decay&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Molecule only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;conversion_mol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;enzymatic&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;fusion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">5</span> <span class="c1"># Molecule only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;enzymatic_mol&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;production&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">7</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;fission&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;absorption&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">9</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">react_type_id</span><span class="p">[</span><span class="s1">&#39;release&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span>
        
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">100</span><span class="p">)</span> 
        <span class="n">cum_p</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">dx_cum_prob</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">ii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">cum_p</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dx_rand</span> <span class="o">=</span> <span class="n">rnd</span><span class="o">.</span><span class="n">Interpolate</span><span class="p">(</span><span class="n">rnd</span><span class="o">.</span><span class="n">dx_cum_prob</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">ii</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">Comp_keytype</span><span class="p">,</span> <span class="n">Comp_valuetype</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_id</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">,</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_name</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">string</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">boundary_2d</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;System initialized&#39;</span><span class="p">)</span>
        
    
        
    <span class="k">def</span> <span class="nf">add_box_compartment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_id</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;Box&#39;</span><span class="p">)</span>
        
<div class="viewcode-block" id="System.add_system_grid"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_system_grid">[docs]</a>    <span class="k">def</span> <span class="nf">add_system_grid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Calculates properties of the system cell grid.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">+</span> <span class="mf">1e-8</span> <span class="c1"># We scale the overall grid size by this factor relative to the simulation box size. This way, the cell grid is slightly larger than the simulation box. If we don&#39;t do this, we can get out of bounds errors for points that lie exactly in the plane of a positive box boundary!</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        
        
        <span class="n">radii</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells_per_dim</span><span class="p">):</span>
                <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells_per_dim</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
                <span class="n">min_radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">max_cells_per_dim</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">min_radius</span><span class="p">)</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">cell_length_per_dim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="o">*</span><span class="n">eps</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Ncell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">AABB_centers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_AABB_centers</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="System.add_barostat_berendsen"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_barostat_berendsen">[docs]</a>    <span class="k">def</span> <span class="nf">add_barostat_berendsen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tau_P</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Adds a berendsen barostat to the system.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Tau_P : `float`</span>
<span class="sd">            Time constant of berendsen barostat</span>
<span class="sd">        P0 : `float`</span>
<span class="sd">            Target pressure of berendsen barostat</span>
<span class="sd">        start : `int`</span>
<span class="sd">            Simulation step from which to start simulating in NPT ensemble.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        </span>
<span class="sd">        The Berendsen barostat is frequently used in molecular dynamics simulations due to its simplicity and fast equilibration. While the Berendsen barostat results in the correct particle density, it does not correctly sample from the (NPT) thermodynamical ensemble, i.e. the fluctuation in the pressure are not 100% accurate. Therefore, one needs to be carefull when to use this Barostat. However, if the barostat is used in the preparation step but not during sampling, e.g. when doing LLPs simualtions where the barostat is used to relax the system&#39;s shape but afterwards one simulates in the NVT ensemble :cite:t:`Muller2020`, this should not be a problem. </span>
<span class="sd">        Note: :cite:t:`Baruffi2019` introduced a barostat for overdamped Langevin dynamics that settles to the correct thermodynamic equilibrium distribution.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;active&#39;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Tau_P&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">Tau_P</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;P0&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">P0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">start</span></div>
        
        
    <span class="k">def</span> <span class="nf">update_rb_barostat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what its used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">RBs</span><span class="o">.</span><span class="n">occupied</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="n">RBs</span><span class="o">.</span><span class="n">occupied</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> 
            
            <span class="n">RBs</span><span class="o">.</span><span class="n">rescale_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span><span class="n">i</span><span class="p">)</span>
            
            
        
<div class="viewcode-block" id="System.register_molecule_type"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.register_molecule_type">[docs]</a>    <span class="k">def</span> <span class="nf">register_molecule_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">particle_pos</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">,</span> <span class="n">collision_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_membrane</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Regsiters a molecule type.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule_name : `str`</span>
<span class="sd">            Name of the molecule.</span>
<span class="sd">        particle_pos : `int[:,3]`</span>
<span class="sd">            Positions of each of the molecule&#39;s particles.</span>
<span class="sd">        particle_types : `array_like (dtype = &#39;U20&#39;)`</span>
<span class="sd">            Array of names for each of the molecule&#39;s particles.</span>
<span class="sd">        collision_type : `int {0,1}`</span>
<span class="sd">            Collision type of the molecule (Default = 0). 0: Collisions with compartments are handled via interaction force. 1: Collisions with compartments are handled by raytracing algorithm (recommended for molcules whose diffusion speed and/or interaction radius is small compared to the chosen integration time step).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">collision_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">particle_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">particle_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ptype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particle_types</span><span class="p">):</span>
            <span class="n">particle_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ptype</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">MoleculeType</span><span class="p">(</span><span class="n">particle_pos</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">,</span> <span class="n">particle_radii</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">collision_type</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">h_membrane</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        
        <span class="n">molecule_id_to_name0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">molecule_id_to_name</span><span class="p">):</span>
            <span class="n">molecule_id_to_name0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
        <span class="n">molecule_id_to_name0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="p">]</span> <span class="o">=</span> <span class="n">molecule_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_id_to_name</span> <span class="o">=</span> <span class="n">molecule_id_to_name0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_scalar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_scalar_Wall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">virial_tensor_Wall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Pressure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Nmol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Epot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes_rb</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molecule type &#39;</span><span class="o">+</span><span class="n">molecule_name</span><span class="o">+</span><span class="s1">&#39; added to system&#39;</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="System.set_diffusion_tensor"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.set_diffusion_tensor">[docs]</a>    <span class="k">def</span> <span class="nf">set_diffusion_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">D_tt</span><span class="p">,</span> <span class="n">D_rr</span><span class="p">,</span> <span class="n">mu_tb</span><span class="p">,</span> <span class="n">mu_rb</span><span class="p">,</span> <span class="n">mu_tb_sqrt</span><span class="p">,</span> <span class="n">mu_rb_sqrt</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what its used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule_name : `str`</span>
<span class="sd">            Some Information</span>
<span class="sd">        D_tt : `float[3,3]`</span>
<span class="sd">            Translational diffusion tensor ()</span>
<span class="sd">        D_rr : `float[3,3]`</span>
<span class="sd">            Rotational diffusion tensor</span>
<span class="sd">        mu_tb : `float[3,3]`</span>
<span class="sd">            Translational mobility tensor</span>
<span class="sd">        mu_rb : `float[3,3]`</span>
<span class="sd">            Rotational mobility tensor</span>
<span class="sd">        mu_tb_sqrt : `float[3,3]`</span>
<span class="sd">            Square root of translational mobility tensor</span>
<span class="sd">        mu_rb_sqrt : `float[3,3]`</span>
<span class="sd">            Square root of rotational mobility tensor</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        PyRID offers a module for the calculation of the diffusion tensors of rigid bead models (see molecules_util.hydro_util). It uses the Kirkwood-Riseman calculation with modified Oseen tensor as introduced by :cite:t:`Carrasco1999`, :cite:t:`Carrasco1999a`. The same method has been implemented in the `HYDRO++ &lt;http://leonardo.inf.um.es/macromol/programs/hydro++/hydro++.htm&gt;`_ tool, which is free to use but not open source! As such, you may also use HYDRO++ for the calculation of the diffusion tensors. Or even better, use both and tell me if you you get inconsistent results ;) !</span>
<span class="sd">        </span>
<span class="sd">        .. admonition:: Note</span>
<span class="sd">        </span>
<span class="sd">            Diffusion tensor should be a real positive semidefinite matrix!</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
      
        <span class="c1"># is_diagonal(D_tt)</span>
        <span class="c1"># is_diagonal(D_rr)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">D_tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">D_tt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">D_rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">D_rr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">mu_tb</span> <span class="o">=</span> <span class="n">mu_tb</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">mu_rb</span> <span class="o">=</span> <span class="n">mu_rb</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">mu_tb_sqrt</span> <span class="o">=</span> <span class="n">mu_tb_sqrt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">mu_rb_sqrt</span> <span class="o">=</span> <span class="n">mu_rb_sqrt</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">r_mean</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_tt</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">r_mean_pair</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_tt</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_tt</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="c1">#in mum^2/s</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Drot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_rr</span><span class="p">)</span><span class="o">/</span><span class="mi">3</span> <span class="c1">#in 1/s</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_tt</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Drot_2d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">D_rr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span><span class="o">/</span><span class="mi">2</span></div>
        
<div class="viewcode-block" id="System.fixed_concentration_at_boundary"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.fixed_concentration_at_boundary">[docs]</a>    <span class="k">def</span> <span class="nf">fixed_concentration_at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Sets the fixed concentration boundary given a concentartion for each defined molecule type and for each compartents volume and surface.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        molecule_name : `str`</span>
<span class="sd">            Name of the molecule</span>
<span class="sd">        C : `float`</span>
<span class="sd">            concentration of molecule type outside simulation box (&#39;virtual molecules&#39;)</span>
<span class="sd">        comp_name : `str`</span>
<span class="sd">            Name of the compartment</span>
<span class="sd">        location : `int {0,1}`</span>
<span class="sd">            Location of the molecule. 0: Volume, 1: Surface</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        fixed_concentration_at_boundary() calculates some properties that are necessary to properly distribute molecules inside the simulation box that hit the simulation box boundary from the outside (Thereby, &#39;virtual molecules&#39; become `real` molecules in our simualtion). The number of hits per time step a boundary of area A experiences is :math:`N = l_{perp}*A*C`. Where :math:`C` is the concentration in molecules per volume and :math:`l_{perp}` is the average net displacement in one tiem step towards or away from any plane, where :math:`l_{perp} = \sqrt{(4*D*\Delta t/\pi)}` :cite:t:`Stiles2001`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compartments_id</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">comp_name</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">D</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans_2d</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">box_border</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_box</span><span class="p">)</span>
                    
            <span class="n">area</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>  <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">box_area</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">area</span><span class="p">)</span>
            
            <span class="c1"># A_x = self.box_lengths[1]*self.box_lengths[2]</span>
            <span class="c1"># A_y = self.box_lengths[0]*self.box_lengths[2]</span>
            <span class="c1"># A_z = self.box_lengths[0]*self.box_lengths[1]</span>
            
            
        <span class="c1"># A = self.box_area</span>
            
        <span class="n">l_perp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">l_perp</span> <span class="o">=</span> <span class="n">l_perp</span>
        
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">concentration</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule_name</span><span class="p">]</span><span class="o">.</span><span class="n">concentration_surface</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span></div>
        

        
<div class="viewcode-block" id="System.register_particle_type"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.register_particle_type">[docs]</a>    <span class="k">def</span> <span class="nf">register_particle_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registers a particle type.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Type : `str`</span>
<span class="sd">            Name of the particle type.</span>
<span class="sd">        radius : `float`</span>
<span class="sd">            radius of the particle.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">Type</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_ptype</span><span class="p">)</span><span class="c1">#np.array([(self.ntypes, radius)], dtype = item_t_ptype)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">Type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">Type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
        
        <span class="n">particle_id_to_name0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s1">&#39;U20&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">types</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">particle_id_to_name</span><span class="p">):</span>
            <span class="n">particle_id_to_name0</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">types</span>
        <span class="n">particle_id_to_name0</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">]</span> <span class="o">=</span> <span class="n">Type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_id_to_name</span> <span class="o">=</span> <span class="n">particle_id_to_name0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_bpr</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_inter</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_react</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">][:,:]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">N_bonds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ntypes</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">bool_</span><span class="p">)</span>
        
        <span class="c1"># self.force_measure = np.zeros(self.ntypes, dtype = np.int64)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Particle type &#39;</span><span class="o">+</span><span class="n">Type</span><span class="o">+</span><span class="s1">&#39; added to system&#39;</span><span class="p">)</span></div>
        

    
<div class="viewcode-block" id="System.set_compartments"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.set_compartments">[docs]</a>    <span class="k">def</span> <span class="nf">set_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">triangle_ids</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Sets a compartment given its triangle ids.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        comp_name : `str`</span>
<span class="sd">            Name of the compartment.</span>
<span class="sd">        triangle_ids : `int64[:]`</span>
<span class="sd">            IDs of the triangles making up the compartment mesh.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span> <span class="o">=</span> <span class="n">Compartment</span><span class="p">(</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_id</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">comp_name</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compartments_name</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">comp_name</span><span class="p">))</span>
        
        <span class="c1"># self.Compartments[self.n_comps].calc_centroid_radius_AABB(self)    </span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">volume</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span>
        
        <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AABB_all</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB_all</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">AABB_all</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">n_comps</span><span class="p">]</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
        
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Compartment &#39;</span><span class="o">+</span> <span class="n">comp_name</span> <span class="o">+</span><span class="s1">&#39; set!&#39;</span><span class="p">)</span> </div>
        

<div class="viewcode-block" id="System.add_border_3d"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_border_3d">[docs]</a>    <span class="k">def</span> <span class="nf">add_border_3d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">triangle_ids_border</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registers the border faces of an intersection between compartments and the simulation box (Needed for fixed concentration boundary condition)</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        triangle_ids_border : `int64[:]`</span>
<span class="sd">            IDs of the triangles making up the compartment-simulation box border.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">eps</span> <span class="o">=</span> <span class="mf">1e-3</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_border</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_border_box</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">)):</span>

            <span class="n">tri_id</span> <span class="o">=</span> <span class="n">triangle_ids_border</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_id</span>
            
            <span class="c1"># Make sure the box vertices lie exactly on the simulation box border:</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">vert</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="mi">1</span><span class="o">-</span><span class="n">eps</span><span class="o">&lt;</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">+</span><span class="n">eps</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">]][</span><span class="n">dim</span><span class="p">])</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">update_mesh</span><span class="p">(</span><span class="n">vertex</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="n">vert</span><span class="p">])</span>
                        
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_ids_border</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">box_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_ids_border</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">])</span></div>
        
        
<div class="viewcode-block" id="System.add_mesh"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_mesh">[docs]</a>    <span class="k">def</span> <span class="nf">add_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">triangles</span><span class="p">,</span> <span class="n">mesh_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">box_triangle_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_ids_transparent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Set up the mesh for the mesh compartments.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertices : `float64[:,3]`</span>
<span class="sd">            Position of mesh vertices in each dimension.</span>
<span class="sd">        triangles : `int64[:,3]`</span>
<span class="sd">            Indices of vertices that make up each triangle (pointers to vertices)</span>
<span class="sd">        mesh_scale : `float`</span>
<span class="sd">            Scaling factor to scale up or down the mesh (Default = 1.0).</span>
<span class="sd">        box_triangle_ids : `int64[:]`</span>
<span class="sd">            Triangle ids of the faces that make up the simulation box border (To be excluded from self.triangle_ids)</span>
<span class="sd">        triangle_ids_transparent : `int64[:]`</span>
<span class="sd">            Triangle ids of any transparent faces (To be excluded from self.triangle_ids)</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        </span>
<span class="sd">        A Compartment is defined by a triangulated manifold mesh (a mesh without holes and disconnected vertices or edges),</span>
<span class="sd">        i.e. it has no gaps and separates the space on the inside of the surface from the space outside. It also looks like a surface everywhere on the mesh :cite:t:`Shirley2009`.</span>
<span class="sd">        The mesh is stored as a shared vertex mesh. This data structure has triangles which point to vertices which contain the vertex data:</span>
<span class="sd">            </span>
<span class="sd">            | triangles: Three vectors per triangle</span>
<span class="sd">            | 0 | (0,1,2)</span>
<span class="sd">            | 1 | (1,3,2)</span>
<span class="sd">            | 2 | (0,3,1)</span>
<span class="sd">            | </span>
<span class="sd">            | vertices: One vector per vertex</span>
<span class="sd">            | 0 | (a_x,a_y,a_z)</span>
<span class="sd">            | 1 | (b_x,b_y,b_z)</span>
<span class="sd">            | 2 | (c_x,c_y,c_z)</span>
<span class="sd">            | 3 | (d_x,d_y,d_z)</span>
<span class="sd">        </span>
<span class="sd">        During raymarching on a mesh surface, we need to find the neighbor triangle given some edge i that has been crossed.</span>
<span class="sd">        We may save, for each triangle, the corresponding edges in an array:</span>
<span class="sd">            </span>
<span class="sd">            | 0 | (0,1), (0,2), (1,2)</span>
<span class="sd">            | 1 | ...</span>
<span class="sd">            </span>
<span class="sd">        In addition, we save, for each edge of a triangle the corresponding neighbor in another array:</span>
<span class="sd">            </span>
<span class="sd">            | 0 | (1, 4, 2)</span>
<span class="sd">            | 1 | ...</span>
<span class="sd">        </span>
<span class="sd">        Also, we need to rotate the particles between local coordinate systems of neighbouring triangles, as particles cross an edge.</span>
<span class="sd">        We may precalculate the necessary parameters and save them in a datastructure similar to the above:</span>
<span class="sd">            </span>
<span class="sd">            | 0 | (params_0-&gt;1, params_0-&gt;4, params_0-&gt;2)</span>
<span class="sd">            | 1 | ...</span>
<span class="sd">            | </span>
<span class="sd">            | params_i-&gt;j : [sinPhi, cosPhi, a_n]</span>
<span class="sd">            </span>
<span class="sd">        We may also want to prcompute the rotation parameters for each triangle pait to speed up the coordiante transformation </span>
<span class="sd">        when a particle hops between two triangles. We may take the same data structure as before:</span>
<span class="sd">            </span>
<span class="sd">            | 0 | (rot_params[0-&gt;1], (rot_params[0-&gt;4], (rot_params[0-&gt;2])</span>
<span class="sd">            | 1 | ...</span>
<span class="sd">            | </span>
<span class="sd">            | rot_params: array[sin, cos, an]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">vertices</span><span class="o">*=</span><span class="n">mesh_scale</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_scale</span> <span class="o">=</span> <span class="n">mesh_scale</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span> <span class="o">=</span> <span class="n">vertices</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangles</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangles</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">triangle_ids_transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids_transparent</span> <span class="o">=</span> <span class="n">triangle_ids_transparent</span>
        
        <span class="n">triangle_ids_all</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">box_triangle_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">triangle_ids_transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tri_id</span> <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids_all</span> <span class="k">if</span> <span class="p">(</span><span class="n">tri_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">box_triangle_ids</span> <span class="ow">and</span> <span class="n">tri_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">triangle_ids_transparent</span><span class="p">)],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">box_triangle_ids</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">triangle_ids_transparent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">triangle_ids_all</span>
        
        <span class="k">elif</span> <span class="n">box_triangle_ids</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tri_id</span> <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids_all</span> <span class="k">if</span> <span class="n">tri_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">box_triangle_ids</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span> 
        <span class="k">elif</span> <span class="n">triangle_ids_transparent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">tri_id</span> <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids_all</span> <span class="k">if</span> <span class="n">tri_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">triangle_ids_transparent</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            
            
        
        <span class="c1">#Assign values:</span>
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">triangles</span><span class="p">[</span><span class="n">tri_id</span><span class="p">]</span>
            <span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span> <span class="o">=</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span> <span class="n">vertices</span><span class="p">[</span><span class="n">triangles</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
            <span class="n">origin</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="n">ez</span> <span class="o">=</span> <span class="n">local_coord</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">origin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ey</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ez</span> <span class="c1"># normalied triangle normal</span>
            
            <span class="n">d00</span><span class="p">,</span> <span class="n">d01</span><span class="p">,</span> <span class="n">d11</span><span class="p">,</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">barycentric_params</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d00</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d01</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d11</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">denom</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;normal&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">normal_vector</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="c1"># unnormalied triangle normal</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_centroid&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">triangle_centroid</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">triangle_area</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">add_edges</span><span class="p">()</span> <span class="c1">#Given an edge, which two triangles share it?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_neighbours</span><span class="p">()</span> <span class="c1">#Given a triangle, what are the (three) adjacent triangles?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_vertex_triangles</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">wall_force</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: No wall_force set, molecules wont get repelled by the mesh!&#39;</span><span class="p">)</span></div>
        
        
            
            
            
<span class="c1">#%%</span>

    <span class="k">def</span> <span class="nf">update_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vertex</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_ids_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates mesh properties. Should be called whever the mesh topology changes, i.e. the position of a vertex is changed after the mesh has been initialized (System.add_mesh()).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        vertex : `int64`</span>
<span class="sd">            The index of the vertex that has been changed. (Default = None)</span>
<span class="sd">        triangle_ids_list : `int64[:]`</span>
<span class="sd">            List of triangle ids which to update. (Default = None)</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">vertex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">triangle_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertex_triangles</span><span class="p">[</span><span class="n">vertex</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">triangle_ids_list</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">triangle_ids_list</span>
            
        <span class="c1">#Assign values:</span>
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="n">triangle_ids</span><span class="p">:</span>
            
            <span class="n">triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            
            <span class="n">p0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> 
            
            <span class="n">origin</span><span class="p">,</span> <span class="n">ex</span><span class="p">,</span><span class="n">ey</span><span class="p">,</span><span class="n">ez</span> <span class="o">=</span> <span class="n">local_coord</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">origin</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ey</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">ez</span> <span class="c1"># normalied triangle normal</span>
            
            <span class="n">d00</span><span class="p">,</span> <span class="n">d01</span><span class="p">,</span> <span class="n">d11</span><span class="p">,</span> <span class="n">denom</span> <span class="o">=</span> <span class="n">barycentric_params</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d00</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">d01</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">d11</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;barycentric_params&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">denom</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;normal&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">normal_vector</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span> <span class="c1"># unnormalied triangle normal</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_centroid&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">triangle_centroid</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">triangle_area</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">area</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">]</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_distance&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]])</span>
            
            

<div class="viewcode-block" id="System.add_edges"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_edges">[docs]</a>    <span class="k">def</span> <span class="nf">add_edges</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Finds the edges of each triangle and adds them to the Mesh struct.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>

<span class="sd">        Edges are sorted in counter clockwise order:</span>
<span class="sd">        </span>
<span class="sd">            | edge:   [0,1]</span>
<span class="sd">            |         [1,2]</span>
<span class="sd">            |         [0,2]</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
                
        <span class="c1">#Given triangle i and the jth edge of that triangle, which is the neighboring triangle?</span>
        
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span></div>
        
        
    <span class="k">def</span> <span class="nf">add_vertex_triangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">vertex_triangles</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">list_int64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">vertex_triangles</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">):</span>
            
            <span class="n">triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">vertex_id</span> <span class="ow">in</span> <span class="n">triangle</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vertex_triangles</span><span class="p">[</span><span class="n">vertex_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tri_id</span><span class="p">)</span>
            
            
<div class="viewcode-block" id="System.add_neighbours"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_neighbours">[docs]</a>    <span class="k">def</span> <span class="nf">add_neighbours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Finds the neighbours of each triangle and adds them to the Mesh struct.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">Vertex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">):</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">triangle</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Vertex</span><span class="p">:</span>
                    <span class="n">Vertex</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">tri_id</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">Vertex</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="n">j</span><span class="p">]]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tri_id</span><span class="p">)</span>
        
        
        <span class="k">for</span> <span class="n">tri_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">):</span>
            <span class="n">triangle</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">k1</span><span class="p">,</span> <span class="n">k2</span> <span class="ow">in</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]]:</span>
                
                <span class="n">a</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Vertex</span><span class="p">[</span><span class="n">k1</span><span class="p">])</span><span class="o">-</span><span class="nb">set</span><span class="p">([</span><span class="n">tri_id</span><span class="p">])</span>
                <span class="n">b</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">Vertex</span><span class="p">[</span><span class="n">k2</span><span class="p">])</span><span class="o">-</span><span class="nb">set</span><span class="p">([</span><span class="n">tri_id</span><span class="p">])</span>
                <span class="n">neighb</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;neighbours&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">neighb</span></div>
                
    
    <span class="c1">#%%</span>
    
<div class="viewcode-block" id="System.get_AABB_centers"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.get_AABB_centers">[docs]</a>    <span class="k">def</span> <span class="nf">get_AABB_centers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Calculates the center of each cell of the system grid.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">AABB_centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">Ncell</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
        
        <span class="k">for</span> <span class="n">cx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">cy</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">cz</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="n">AABB_center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">cx</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">cy</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">cz</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
                    <span class="n">AABB_center</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">origin</span>
                    
                    <span class="n">c</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cz</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">AABB_centers</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">AABB_center</span>
                            
        <span class="k">return</span> <span class="n">AABB_centers</span></div>
    
    
<div class="viewcode-block" id="System.create_cell_list"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.create_cell_list">[docs]</a>    <span class="k">def</span> <span class="nf">create_cell_list</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Creates the linked cell list for the triangulated meshes by calling system_util.CellList_util.create_cell_list_mesh() (Used during collision detection).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">boundary_2d</span><span class="p">:</span>
            <span class="n">centroid_in_box</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">centroid_in_box</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">CellList</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AABB_centers</span> <span class="o">=</span> <span class="n">create_cell_list_mesh</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">centroid_in_box</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="System.add_up_reaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_up_reaction">[docs]</a>    <span class="k">def</span> <span class="nf">add_up_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registeres a Uni-Particle (UP) reaction for an educt particle.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reaction_type : `str` {&#39;relase&#39;, &#39;conversion&#39;}</span>
<span class="sd">            Name of the reaction type</span>
<span class="sd">        educt_type : `str`</span>
<span class="sd">            Name of the educt particle type</span>
<span class="sd">        rate : `float64`</span>
<span class="sd">            Reaction rate</span>
<span class="sd">        product_types : `array_like`</span>
<span class="sd">            List of products</span>
<span class="sd">        product_loc : `array_like`</span>
<span class="sd">            List specifying whether the individual products are volume (0) or surface (1) molecules </span>
<span class="sd">        product_direction : `array_like`</span>
<span class="sd">            Specifies whether, in case of a surface particle releasing products into the volume, the realease occurs inside (-1) or outside (1) the mesh compartment.</span>
<span class="sd">        radius : `float64`</span>
<span class="sd">            The radius within which molecules are distributed upon a successfull release reaction.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Uni-particle reactions are evaluated using a variant of the Gillespie stochastic simulation algorithm. Thereby, for a particle type, the time point of the next uni-particle reaction occuring is calculated in advance and executed when the simualtion reaches the respective time point. </span>
<span class="sd">        For unimolecular reactions we can draw the time point of the next reaction from a distribution using a variant of the Gillespie Stochastic Simulation Algorithm (SSA) :cite:t:`Stiles2001`, :cite:t:`Erban2007`. For a single molecule having :math:`n` possible transition reactions/reaction paths each having a reaction rate :math:`k_i`, let :math:`k_t = \sum_i^n k_i` be the total reaction rate. </span>
<span class="sd">        </span>
<span class="sd">        Now, let :math:`\\rho(\\tau) d\\tau` be the probability that the next reaction occurs within :math:`[t+\\tau,t+\\tau+d\\tau)` and let :math:`g(\\tau)` be the probability that no reaction occurs within :math:`[t,t+\\tau)`. The probability that a reaction occurs within the time interval :math:`d\\tau` is simply :math:`k_t d\\tau`. Thereby</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            </span>
<span class="sd">            \\rho(\\tau) d\\tau = g(\\tau) k_t d\\tau</span>
<span class="sd">        </span>
<span class="sd">        where :math:`g(\\tau) = e^{-k_t \\tau}` (see also Poisson process).</span>
<span class="sd">        From the above equation we easily find :math:`P(\\tau) = 1-e^{-k_t \\tau}` by integration.</span>
<span class="sd">        To sample from this distribution, we can use the inverse distribution function.</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            </span>
<span class="sd">            \\tau = P^{-1}(U)</span>
<span class="sd">            </span>
<span class="sd">        where :math:`U` i uniformly distributed in :math:`(0,1)`. </span>
<span class="sd">        Given that :math:`U = P(\\tau) = 1-e^{-k_t \\tau}`, we find :math:`P^{-1}(U) = \\frac{-log(1-U)}{k_t}`. Since </span>
<span class="sd">        :math:`U` is uniformly distributed in 0,1, so is :math:`1-U`. Thereby, we can draw the time point of the next reaction from:</span>
<span class="sd">            </span>
<span class="sd">        .. math::</span>
<span class="sd">            \\tau = \\frac{1}{k_t} \ln\Big[\\frac{1}{U}\Big],</span>
<span class="sd">        </span>
<span class="sd">        With the above method, we accurately sample from the distribution of expected molecule lifetimes :math:`\\rho(\\tau) = k_t e^{-k_t \\tau}`.</span>
<span class="sd">        </span>
<span class="sd">        A uni-particle reaction can consist of several reaction paths. Each particle type has exactly one uni-particle reaction id registered for which the time point is drawn randomly based on the total reaction rate which is the sum of all path reaction rates. At the time point of the reaction occuring, a path is randomly drawn from the set of possible paths weighted by the individual path reaction rates. </span>
<span class="sd">        To get the reaction path we compare a second random number, uninformly distributed in (0,k_t), with the cumulative set of reaction rates :math:`(k_1, k_1+k_2, ..., k_t)`. The comparison is done via a bisection algorithm (see rand_util.random_util.bisect_right()).</span>
<span class="sd">        </span>
<span class="sd">        To illustrate the above by an example: For particle &#39;A&#39; a we may define two convcersion reactions where A -k1-&gt; B, A -k2-&gt; C. In addition, we define a release reaction A -k3-&gt; 2*D+5*E. The next reaction will occur at a time point T that is calculated based on the total rate k1+k2+k3. At time T, one of the three reactions is executed. The probability for each reaction to be selected being k1/(k1+k2+k3), k2/(k1+k2+k3), k3/(k1+k2+k3).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the educt id:</span>
        <span class="n">educt_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">educt_type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">educt_type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;UP_reaction&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rru</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">educt_id</span><span class="p">]),</span> <span class="s1">&#39;unimolecular&#39;</span><span class="p">,</span> <span class="s1">&#39;Particle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;release&#39;</span><span class="p">:</span>
            <span class="c1"># In case of a release reaction, we have a special case, since the educt is a particle and will therefore change to a different particle type whereas the other products are rigid bead molecules:</span>
                
            <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                
                <span class="n">educt_product_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">educt_product_id</span>
                <span class="n">product_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">product_id</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        
        <span class="k">elif</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;conversion&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;decay&#39;</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">educt_type</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;transition_rate_total&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rate</span></div>
        

<span class="c1">#%%</span>


<div class="viewcode-block" id="System.add_um_reaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_um_reaction">[docs]</a>    <span class="k">def</span> <span class="nf">add_um_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;Registeres a Uni-Molecular (UM) reaction for an educt Molecule.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reaction_type : `str` {&#39;production&#39;, &#39;fission&#39;, &#39;conversion_mol&#39;, &#39;decay&#39;}</span>
<span class="sd">            Name of the reaction type</span>
<span class="sd">        educt_type : `str`</span>
<span class="sd">            Name of the educt molecule type</span>
<span class="sd">        rate : `float64`</span>
<span class="sd">            Reaction rate</span>
<span class="sd">        product_types : `array_like`</span>
<span class="sd">            List of products</span>
<span class="sd">        product_loc : `array_like`</span>
<span class="sd">            List specifying whether the individual products are volume (0) or surface (1) molecules </span>
<span class="sd">        product_direction : `array_like`</span>
<span class="sd">            Specifies whether, in case of a surface molecule releasing products into the volume, the realease occurs inside (-1) or outside (1) the mesh compartment.</span>
<span class="sd">        radius : `float64`</span>
<span class="sd">            The radius within which molecules are distributed upon a successfull release reaction.</span>
<span class="sd">            </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Uni-molecular reactions are evaluated using the Gillespie stochastic simulation algorithm. Thereby, for a molecule type, the time point of the next uni-molecular reaction occuring is calculated in advance and executed when the simualtion reaches the respective time point. A uni-molecular reaction can consist of several reaction paths. Each molecule type has exactly one uni-molecular reaction id registered for which the time point is drawn randomly based on the total reaction rate which is the sum of all path reaction rates. At the time point of the reaction occuring, a path is randomly drawn from the set of possible paths weighted by the individual path reaction rates. To illustrate the above by an example: For Molecule &#39;A&#39; a we may define two convcersion reactions where A -k1-&gt; B, A -k2-&gt; C. In addition, we define a fission reaction A -k3-&gt; D+E. The next reaction will occur at a time point T that is calculated based on the total rate k1+k2+k3. At time T, one of the three reactions is executed. The probability for each reaction to be selected being k1/(k1+k2+k3), k2/(k1+k2+k3), k3/(k1+k2+k3).</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># Get the educt id:</span>
        <span class="n">educt_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_type</span><span class="p">)]</span><span class="o">.</span><span class="n">type_id</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rru</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">educt_id</span><span class="p">]),</span> <span class="s1">&#39;unimolecular&#39;</span><span class="p">,</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span> <span class="o">+=</span> <span class="mi">1</span>
            

        <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;production&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">product_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">prod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">product_types</span><span class="p">):</span>
                    <span class="n">product_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prod</span><span class="p">)]</span><span class="o">.</span><span class="n">type_id</span>
                    <span class="n">products_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">product_id</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        
        <span class="k">elif</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;fission&#39;</span><span class="p">:</span>
                
            <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">product_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span>  <span class="n">radius</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">prod</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">product_types</span><span class="p">):</span>
                    <span class="n">product_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">prod</span><span class="p">)]</span><span class="o">.</span><span class="n">type_id</span>
                    <span class="n">products_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">product_id</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;conversion_mol&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>
            
        <span class="k">elif</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;decay&#39;</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">um_reaction_id</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_type</span><span class="p">)]</span><span class="o">.</span><span class="n">update_um_reaction</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span></div>


<span class="c1">#%%</span>


<div class="viewcode-block" id="System.add_bp_reaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_bp_reaction">[docs]</a>    <span class="k">def</span> <span class="nf">add_bp_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_types</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">interaction_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interaction_parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Registeres a Bi-Particle (BP) reaction for an educt particle.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reaction_type : `str` {&#39;bind&#39;, &#39;absorption&#39;, &#39;enzymatic&#39;}</span>
<span class="sd">            Name of the reaction type</span>
<span class="sd">        educt_type : `array_like`</span>
<span class="sd">            Names of the educt particle types</span>
<span class="sd">        product_types : `array_like`</span>
<span class="sd">            List of products (only used for binding reactions)</span>
<span class="sd">        rate : `float64`</span>
<span class="sd">            Reaction rate</span>
<span class="sd">        radius : `float64`</span>
<span class="sd">            Reaction radius.</span>
<span class="sd">        interaction_type : `str`</span>
<span class="sd">            Name of the energy potential function in case &#39;reaction_type&#39; is a binding reaction.</span>
<span class="sd">        interaction_parameters : `dict`</span>
<span class="sd">            Parameters for the interaction function in case &#39;reaction_type&#39; is a binding reaction.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Bi-particle reactions are evaluated using the Doi scheme. Thereby, two educt particles react with a reaction rate k if the inter-particle distance is below the reaction radius.</span>
<span class="sd">        </span>
<span class="sd">        `Binding Reactions`</span>
<span class="sd">        </span>
<span class="sd">        A particle pair will only enter a bound state if the binding reaction was succesfull. Otherwise two particles won&#39;t experience any pairwise interaction force! A reaction occurs if two particles for whose type a binding reaction has been defined are within the reaction radius. The reaction probability is evaluated as:</span>
<span class="sd">            </span>
<span class="sd">        .. math::</span>
<span class="sd">            </span>
<span class="sd">            1-exp(\lambda \cdot \Delta t),</span>
<span class="sd">        </span>
<span class="sd">        where :math:`\lambda` is the reaction rate and :math:`\Delta t` is the integration time step.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">educts_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">educt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">educt_types</span><span class="p">):</span>
            <span class="n">educt_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">educt_id</span>


        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">n_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">n_reactions</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">n_reactions</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>                
            
            <span class="c1"># update the reaction_args matrix, which is used to lookup all the necessary properties for each reaction</span>
            <span class="c1"># during reaction handling (see update_util):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BP&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BP&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>       
            <span class="c1"># Which of the two educts is the enzyme?:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="kc">True</span>
    
            <span class="k">if</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span>
    
            <span class="k">if</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span>
            
            <span class="c1">#-------------</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rru</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">educts_ids</span><span class="p">,</span> <span class="s1">&#39;bimolecular&#39;</span><span class="p">,</span> <span class="s1">&#39;Particle&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            <span class="n">current_reaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span> <span class="o">+=</span> <span class="mi">1</span>
            
            
        <span class="k">else</span><span class="p">:</span>
            
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;BP&#39;</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to add the Biparticle reaction! A Bimolecular reaction has already been defined betwen these two particle types!&#39;</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span><span class="p">:</span>
                
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to add the binding reaction! A Biparticle reaction has already been defined betwen these two particle types! Binding reactions cannot be defined in parallel with other biparticle reactions!&#39;</span><span class="p">)</span>
                
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to add the Biparticle reaction! A binding reaction has already been defined betwen these two particle types! Binding reactions cannot be defined in parallel with other biparticle reactions!&#39;</span><span class="p">)</span>
                
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;A new reaction path is added. Note that any new reaction radius that has been passed will be ignored!&#39;</span><span class="p">)</span>
                
                
            <span class="n">current_reaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            


        <span class="k">if</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;bind&#39;</span><span class="p">:</span>
            
            <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">products_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="c1"># If the particles change their type by binding, we also want to save the </span>
            <span class="c1"># original type (bond_educt_id).</span>
            <span class="c1"># If a bond breaks, the otiginal pyrticle type will be restored.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bond_educt_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bond_educt_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">current_reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>            
            
            <span class="k">if</span> <span class="n">interaction_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_interaction</span><span class="p">(</span><span class="n">interaction_type</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">interaction_parameters</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            
        <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;absorption&#39;</span><span class="p">:</span>
            
            <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">current_reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>
            
        <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;enzymatic&#39;</span><span class="p">:</span>
        
            <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            <span class="n">products_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">current_reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>            </div>
            
            
        <span class="c1"># print(&#39;Particle enzymatic reaction added (&#39;+type1+&#39;+&#39;+type2+&#39;-&gt;&#39;+type3+&#39;+&#39;+type2+&#39;)&#39;)        </span>
        
        
        
        
<span class="c1">#%%</span>

<div class="viewcode-block" id="System.add_interaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_interaction">[docs]</a>    <span class="k">def</span> <span class="nf">add_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interaction_type</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">bond</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">breakable</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
         
        <span class="sd">&quot;&quot;&quot;Assigns a particle-particle interaction potential to a particle type pair.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        interaction_type : `str` {&#39;harmonic_repulsion&#39;, &#39;PHS&#39;, &#39;harmonic_attraction&#39;, &#39;CSW&#39;}</span>
<span class="sd">            Type of interaction potential</span>
<span class="sd">        type1 : `str`</span>
<span class="sd">            Names of the educt particle type 1</span>
<span class="sd">        type2 : `str`</span>
<span class="sd">            Names of the educt particle type 2</span>
<span class="sd">        parameters : `dict`</span>
<span class="sd">            Parameters for the interaction potential function.</span>
<span class="sd">        bond : `bool`</span>
<span class="sd">            True if interaction is initialized as part of a bindign reaction. (Default: False)</span>
<span class="sd">        breakable : `bool`</span>
<span class="sd">            If set to True, bonds that have been formed by a binding reaction are deleted if the interparticle distance is above the cutoff radius of the interaction potenial.</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Bi-particle reactions are evaluated using the Doi scheme. Thereby, two educt particles react with a reaction rate k if the inter-particle distance is below the reaction radius.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">type1_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        <span class="n">type2_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
        <span class="n">stokes_radius_1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
        <span class="n">stokes_radius_2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
        
        <span class="n">interaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">interaction_IDs</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">interaction_type</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;global&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bond</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;global&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">bond</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_id</span>    
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interaction_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;breakable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;breakable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">breakable</span>
        
        <span class="k">if</span> <span class="n">interaction_type</span> <span class="o">==</span> <span class="s1">&#39;harmonic_repulsion&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="s1">&#39;radius_1&#39;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s1">&#39;radius_2&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_1&#39;</span><span class="p">]</span>
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_2&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">stokes_radius_1</span> 
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">stokes_radius_2</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
          
            <span class="k">if</span> <span class="n">radius_1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span>
            
            <span class="k">if</span> <span class="n">radius_2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_2</span>
            
        
        <span class="k">elif</span> <span class="n">interaction_type</span> <span class="o">==</span> <span class="s1">&#39;PHS&#39;</span><span class="p">:</span>

            <span class="k">if</span> <span class="s1">&#39;radius_1&#39;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s1">&#39;radius_2&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_1&#39;</span><span class="p">]</span>
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_2&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">stokes_radius_1</span> 
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">stokes_radius_2</span>
                
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;EpsR&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;EpsR&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;la&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;la&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>

            <span class="k">if</span> <span class="n">radius_1</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span>
            
            <span class="k">if</span> <span class="n">radius_2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_2</span>
                
        <span class="k">elif</span> <span class="n">interaction_type</span> <span class="o">==</span> <span class="s1">&#39;harmonic_attraction&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="s1">&#39;radius_1&#39;</span> <span class="ow">in</span> <span class="n">parameters</span> <span class="ow">and</span> <span class="s1">&#39;radius_2&#39;</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_1&#39;</span><span class="p">]</span>
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;radius_2&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">radius_1</span> <span class="o">=</span> <span class="n">stokes_radius_1</span> 
                <span class="n">radius_2</span> <span class="o">=</span> <span class="n">stokes_radius_2</span>   

            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span> <span class="o">+</span> <span class="n">radius_2</span> <span class="o">+</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">radius_1</span><span class="o">+</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_1</span><span class="o">+</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> 
            <span class="k">if</span> <span class="n">radius_2</span><span class="o">+</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius_2</span><span class="o">+</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rc&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> 
                
                
        <span class="k">elif</span> <span class="n">interaction_type</span> <span class="o">==</span> <span class="s1">&#39;CSW&#39;</span><span class="p">:</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;eps_csw&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;eps_csw&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type1</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> 
            <span class="k">if</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type2</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.75</span><span class="o">*</span><span class="n">parameters</span><span class="p">[</span><span class="s1">&#39;rw&#39;</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> 
                
            
            
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">type2_id</span><span class="p">][</span><span class="n">type1_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">type1_id</span><span class="p">][</span><span class="n">type2_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">type1_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">type2_id</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">bond</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Global &#39;</span><span class="o">+</span><span class="n">interaction_type</span><span class="o">+</span><span class="s1">&#39; added (&#39;</span><span class="o">+</span><span class="n">type1</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">type2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span>  
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">interaction_type</span><span class="o">+</span><span class="s1">&#39; bond added (&#39;</span><span class="o">+</span><span class="n">type1</span><span class="o">+</span><span class="s1">&#39;-&#39;</span><span class="o">+</span><span class="n">type2</span><span class="o">+</span><span class="s1">&#39;)&#39;</span><span class="p">)</span></div>


<span class="c1">#%%</span>


<div class="viewcode-block" id="System.add_bm_reaction"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/system_util.html#pyrid.system.system_util.System.add_bm_reaction">[docs]</a>    <span class="k">def</span> <span class="nf">add_bm_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_types</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">particle_pairs</span><span class="p">,</span> <span class="n">pair_rates</span><span class="p">,</span> <span class="n">pair_Radii</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;Registeres a Bi-Molecular (BM) reaction for an educt molecule.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        reaction_type : `str` {&#39;fusion&#39;, &#39;enzymatic_mol&#39;}</span>
<span class="sd">            Name of the reaction type</span>
<span class="sd">        educt_type : `array_like`</span>
<span class="sd">            Names of the educt molecule types</span>
<span class="sd">        particle_pairs : `array_like`</span>
<span class="sd">            List of educt particle pairs belonging to each of the two educt molecules</span>
<span class="sd">        pair_rates : `array_like`</span>
<span class="sd">            List of reaction rates for each particle pair</span>
<span class="sd">        pair_Radii : `array_like`</span>
<span class="sd">            List of reaction radii for each particle pair</span>
<span class="sd">        </span>
<span class="sd">        Notes</span>
<span class="sd">        -----</span>
<span class="sd">        Bi-molecular reactions are evaluated using the Doi scheme. Thereby, two educt particles react with a reaction rate k if the inter-particle distance is below the reaction radius. PyRID only evaluates the eucludean distances between particles but not molecule centers. Thereby, also for bi-molecular reactions educt particles need to be set. Since molecules can consist of several particles, a list of particle pairs can be passed and for each particle pair a reaction rate and radius is defined. If one of the pair particle reactions is successfull, the corresponding molecule that the particle belongs to is converted as defined by the reaction type. If the moelcule cosnsists of a single particle, the reaction will be handled just as the bi-particle reactions. The user needs to take care of calculating accurate reaction radii and rates such that the desired reaction dynamics are simulated, which can become difficult for large molecules. Therefore it is sometimes more convenient to place an interaction free particle at the origin of the molecule and execute the bimolecular reaction via this particle. This method is equivalent to the case where one would evaluate reactions based on the distance between molecule centers.</span>
<span class="sd">        As for the uni-moelcular reactions, several reaction paths can be defined. Each reaction path may involve different particle pairs of the educt molecules. On a side note: Thereby, orientation dependent bimolecular reactions are in principle possibile. However, since the reaction probability does not scale with the distance, directionality is only really accounted for if the reaction radius is small compared to the molecule size.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">for</span> <span class="n">educt_particle_types</span> <span class="ow">in</span> <span class="n">particle_pairs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">string_in_array</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">types</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Particle type &#39;</span><span class="o">+</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; ist not part of molecule &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; topology!&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Particle type ist not part of molecule topology!&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="n">string_in_array</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">types</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Particle type &#39;</span><span class="o">+</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="s1">&#39; ist not part of molecule &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; topology!&#39;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Particle type ist not part of molecule topology!&#39;</span><span class="p">)</span>
                
            <span class="k">for</span> <span class="n">mol_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">string_in_array</span><span class="p">(</span><span class="n">mol_type</span><span class="p">,</span> <span class="n">educt_types</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">string_in_array</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">mol_type</span><span class="p">]</span><span class="o">.</span><span class="n">types</span><span class="p">)</span> <span class="ow">or</span> <span class="n">string_in_array</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">mol_type</span><span class="p">]</span><span class="o">.</span><span class="n">types</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Educt particle type found in multiple molecule topologies! Cannot unambiguously assign reaction educts for bimolecular reaction!&#39;</span><span class="p">)</span>

        <span class="n">educt_molecule_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="n">educt_molecule_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        <span class="n">educt_molecule_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        
        <span class="k">for</span> <span class="n">educt_particle_types</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">particle_pairs</span><span class="p">,</span> <span class="n">pair_rates</span><span class="p">,</span> <span class="n">pair_Radii</span><span class="p">):</span>
            
            <span class="n">educts_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">educt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">):</span>
                <span class="n">educt_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt</span><span class="p">)][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                <span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">educt_id</span>
    
    
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
                        <span class="n">n_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">n_reactions</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">n_reactions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="n">n_reactions</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">bp_reaction_ids</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;n_reactions&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>                
                
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BM&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;BM&#39;</span>
                <span class="c1"># update the reaction_args matrix, which is used to lookup all the necessary properties for each reaction</span>
                <span class="c1"># during reaction handling (see update_util):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span>
                <span class="c1"># Which of the two educts is the enzyme?:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rru</span><span class="o">.</span><span class="n">Reaction</span><span class="p">(</span><span class="n">educt_molecule_ids</span><span class="p">,</span> <span class="s1">&#39;bimolecular&#39;</span><span class="p">,</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">,</span> <span class="n">educts_ids</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
                <span class="n">current_reaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    
                <span class="bp">self</span><span class="o">.</span><span class="n">reaction_id</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;type_BP_BM&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;BM&#39;</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Unable to add the Bimolecular reaction! A Biparticle reaction has already been defined betwen these two particle types!&#39;</span><span class="p">)</span>
    
                <span class="n">current_reaction_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">educts_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
    
    
    
            <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;fusion&#39;</span><span class="p">:</span>
                
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">current_reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>
                
            <span class="k">if</span>  <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;enzymatic_mol&#39;</span><span class="p">:</span>
            
                <span class="n">products_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
                <span class="n">products_ids</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">product_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">current_reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">products_ids</span><span class="p">)</span>            
                
            
            <span class="bp">self</span><span class="o">.</span><span class="n">interactions</span> <span class="o">=</span> <span class="kc">True</span>
            
            
            <span class="k">if</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span>
    
            <span class="k">if</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">educt_particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">radius</span><span class="o">/</span><span class="mi">2</span></div>
            
        <span class="c1"># print(&#39;Particle enzymatic reaction added (&#39;+type1+&#39;+&#39;+type2+&#39;-&gt;&#39;+type3+&#39;+&#39;+type2+&#39;)&#39;)           </span>

        

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>