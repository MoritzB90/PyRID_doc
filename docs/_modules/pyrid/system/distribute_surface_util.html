<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.system.distribute_surface_util &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyrid.system.distribute_surface_util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.system.distribute_surface_util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>

<span class="kn">from</span> <span class="nn">..math</span> <span class="kn">import</span> <span class="n">transform_util</span> <span class="k">as</span> <span class="n">trf</span>
<span class="kn">from</span> <span class="nn">..geometry.intersections_util</span> <span class="kn">import</span> <span class="n">mesh_inside_box_test</span>
<span class="kn">from</span> <span class="nn">..geometry.ray_march_util</span> <span class="kn">import</span> <span class="n">ray_march_surface</span>
<span class="kn">from</span> <span class="nn">..math</span> <span class="kn">import</span> <span class="n">random_util</span> <span class="k">as</span> <span class="n">randu</span>
<span class="kn">from</span> <span class="nn">..data_structures.cell_list_util</span> <span class="kn">import</span> <span class="n">create_cell_list_points</span><span class="p">,</span> <span class="n">reverse_cell_mapping</span>

<span class="c1">#%%</span>

<span class="n">keytype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">int64</span>
<span class="n">valuetype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<span class="n">listtype_W</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:,:]</span>

<span class="n">listtype_1</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]</span>
<span class="n">listtype_2</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span>
<span class="n">listtype_3</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">listtype_4</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]</span>
<span class="n">listtype_5</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:])</span>
    
<span class="c1">#%%</span>

<div class="viewcode-block" id="random_point_in_triangle"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.random_point_in_triangle">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">random_point_in_triangle</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed in a triangle.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p0 : `float64[3]`</span>
<span class="sd">        Triangle vertex 1</span>
<span class="sd">    p1 : `float64[3]`</span>
<span class="sd">        Triangle vertex 2</span>
<span class="sd">    p2 : `float64[3]`</span>
<span class="sd">        Triangle vertex 3</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    Random points, uniformly distributed inside a triangle can be sampled using an algorithm introduced by :cite:t:`Osada2002`:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        P(\\boldsymbol{r}) = (1-\\sqrt{\\mu_1})*\\boldsymbol{p}_0+(\\sqrt{\\mu_1}*(1-\\mu_2))*\\boldsymbol{p}_1+(\\mu_2*\\sqrt{\\mu_1})*\\boldsymbol{p}_2  ,</span>
<span class="sd">        </span>
<span class="sd">    where :math:`\\mu_1, \\mu_2` are random numbers between 0 and 1. :math:`\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2` are the three vertices of the triangle.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[3]</span>
<span class="sd">        Uniformly, random point in triangle</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">))</span><span class="o">*</span><span class="n">p0</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu</span><span class="p">))</span><span class="o">*</span><span class="n">p1</span><span class="o">+</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">))</span><span class="o">*</span><span class="n">p2</span>  
    
    <span class="k">return</span> <span class="n">pos</span></div>

<div class="viewcode-block" id="random_point_on_edge"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.random_point_on_edge">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">random_point_on_edge</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed on a line segment/edge between two vertices.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    p0 : `float64[3]`</span>
<span class="sd">        Vertex 1</span>
<span class="sd">    p1 : `float64[3]`</span>
<span class="sd">        Vertex 2    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[3]</span>
<span class="sd">        Random point on edge</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">dl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="p">(</span><span class="n">p1</span><span class="o">-</span><span class="n">p0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">p0</span><span class="o">+</span><span class="n">dl</span></div>


<div class="viewcode-block" id="point_on_sphere"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.point_on_sphere">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">point_on_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed on the surface of a sphere with radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius : `float`</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float, float, float)</span>
<span class="sd">        Uniformly distributed random point on sphere surface</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">u</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="evenly_on_sphere"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.evenly_on_sphere">[docs]</a><span class="k">def</span> <span class="nf">evenly_on_sphere</span><span class="p">(</span><span class="n">n</span><span class="p">,</span><span class="n">r</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Approximately distributes n points evenly on the sphere surface.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    n : `int64`</span>
<span class="sd">        Number of points.</span>
<span class="sd">    `r` : `float64`</span>
<span class="sd">        Sphere radius.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    To distribute an arbitrary number of points evenly on a sphere surface, maximizing the minimum distance between all points, is not easily solved and only for a few cases exact theoretical solutions exist. For the cases n=1 to n=6 the known solutions to the Thompson problem are used, which is closesly related to the problem of distributing n points evenly on a sphere surface. N=1 and N=2 are trivial, for the other cases we find</span>
<span class="sd">    </span>
<span class="sd">    3. N = 3: points reside at vertices of equilateral triangle</span>
<span class="sd">    4. N = 4: points reside at the vertices of a regular tetrahedron.</span>
<span class="sd">    5. N = 5: points reside at vertices of a triangular dipyramid.</span>
<span class="sd">    6. N = 6: points reside at vertices of a regular octahedron.</span>
<span class="sd">    </span>
<span class="sd">    For n&gt;6, points an approximation using the Fibonacci lattice is used (see e.g. http://extremelearning.com.au/how-to-evenly-distribute-points-on-a-sphere-more-effectively-than-the-canonical-fibonacci-lattice/#more-3069, https://stackoverflow.com/questions/9600801/evenly-distributing-n-points-on-a-sphere). Thereby</span>
<span class="sd">    </span>
<span class="sd">    .. math::  </span>
<span class="sd">        </span>
<span class="sd">        \\begin{align*}</span>
<span class="sd">        x_i = R (\\cos(\\theta_i) \\sin(\\phi_i)) \\\\</span>
<span class="sd">        y_i = R (\\sin(\\theta_i) \\sin(\\phi_i)) \\\\</span>
<span class="sd">        z_i = R \\cos(\\phi_i) \\\\</span>
<span class="sd">        \\end{align*}</span>
<span class="sd">        </span>
<span class="sd">    where</span>
<span class="sd">        </span>
<span class="sd">    .. math::  </span>

<span class="sd">        \\begin{align*}</span>
<span class="sd">        G = \\frac{1 + \\sqrt{5}}{2} \\\\</span>
<span class="sd">        \\phi = \\arccos \\Big(1 - \\frac{2 i+1}{n} \\Big) \\\\</span>
<span class="sd">        \\theta = \\frac{2 \\pi i}{G}</span>
<span class="sd">        \\end{align*}</span>
<span class="sd">    </span>
<span class="sd">    Here, :math:`G` is the so called golden ratio, :math:`i = 1,2,...,n`, and :math:`R` is the sphere radius.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[n,3]</span>
<span class="sd">        Array of n points that are approximatels evenly distributed on a sphere surface.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="k">if</span> <span class="n">n</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">elif</span> <span class="n">n</span><span class="o">==</span><span class="mi">2</span><span class="p">:</span> <span class="c1"># points reside antipodal points.</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">elif</span> <span class="n">n</span><span class="o">==</span><span class="mi">3</span><span class="p">:</span> <span class="c1"># points reside at vertices of equilateral triangle</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">7</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">11</span><span class="o">/</span><span class="mi">6</span><span class="p">)])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">7</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">11</span><span class="o">/</span><span class="mi">6</span><span class="p">)])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">elif</span> <span class="n">n</span><span class="o">==</span><span class="mi">4</span><span class="p">:</span> <span class="c1"># points reside at the vertices of a regular tetrahedron.</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">8</span><span class="o">/</span><span class="mi">9</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">9</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">9</span><span class="p">),</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="p">),</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">elif</span> <span class="n">n</span><span class="o">==</span><span class="mi">5</span><span class="p">:</span> <span class="c1"># points reside at vertices of a triangular dipyramid.</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">7</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">11</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">7</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">11</span><span class="o">/</span><span class="mi">6</span><span class="p">),</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">elif</span> <span class="n">n</span><span class="o">==</span><span class="mi">6</span><span class="p">:</span> <span class="c1"># points reside at vertices of a regular octahedron.</span>
        <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">y</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
        <span class="n">z</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="n">r</span>
    <span class="k">else</span><span class="p">:</span>
        
        <span class="n">goldenRatio</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">5</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
        
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="n">n</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">i</span> <span class="o">/</span> <span class="n">goldenRatio</span>
        
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">))</span><span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">r</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">x</span><span class="p">))</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">y</span><span class="p">))</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="n">z</span><span class="p">))</span>
        
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span><span class="o">.</span><span class="n">T</span> <span class="c1">#x,y,z</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="release_molecules_boundary_2d"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.release_molecules_boundary_2d">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">release_molecules_boundary_2d</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Releases molecules into the volume at the simulation box boundary given an outside concentration of the different molecule types.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">       Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The average number of molecules that hit a boundary of edge length :math:`L` from one side within a time step :math:`\\Delta t` can be calculated from the molecule surface concentration :math:`C` and the average distance a diffusing molecule travels normal to an line :math:`l_{n}` within :math:`\\Delta t` :cite:p:`Kerr2008`:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       N_{hits} = \\frac{L l_{n}}{2 C},</span>
<span class="sd">    </span>
<span class="sd">    where</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       l_{n} = \\sqrt{\\frac{4D\\Delta t}{\\pi}}.</span>
<span class="sd">       </span>
<span class="sd">    Here :math:`D = Tr(\\boldsymbol{D}_{xy}^{tt,b})/2` is the scalar translational diffusion constant.</span>
<span class="sd">    The boundary crossing of molecules can be described as a poisson process. As such, the number of molecules that cross the boundary each time step is drawn from a poisson distribution with a rate :math:`N_{hits}`.</span>
<span class="sd">    </span>
<span class="sd">    The normalized distance that a crossing molecule ends up away from the plane/boundary follows the following distribution :cite:p:`Kerr2008`:</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        P(d\\tilde{x}) = 1-e^{-d\\tilde{x}^2}+\\sqrt{\\pi}*dx*\\text{erfc}(d\\tilde{x})</span>
<span class="sd">        </span>
<span class="sd">    The distance vector normal to the plane after the crossing can then be calculated from the diffusion length constant :math:`\\lambda` and the edges&#39;s normal vector :math:`\\hat{\\boldsymbol{n}}` by :math:`d\\boldsymbol{x} = \\lambda \\, d\\tilde{x} \\, \\hat{\\boldsymbol{n}} = \sqrt{4Dt} \\, d\\tilde{x} \\, \\hat{\\boldsymbol{n}}`.</span>
<span class="sd">    </span>
<span class="sd">    Now that the number of molecules and their distance away from the plane are determined, the molecules are distributed in the simualtion box. Since the diffusion along each dimension is independent we can simply pick a random point uniformly distributed on the respective edge:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        P(\\boldsymbol{r}) = p_0+\\mu*(p_1-p_0) ,</span>
<span class="sd">        </span>
<span class="sd">    where :math:`\\mu` is a random number between 0 and 1. :math:`\\boldsymbol{p}_0, \\boldsymbol{p}_1` are the two vertices of the edge.</span>
<span class="sd">    </span>
<span class="sd">    Note that, in general, here we neglect any interactions between the virtual molecules. Therefore, fixed concentration boundary conditions only result in the same inside and outside concentrations if no molecular in teractions are simulated.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">quat</span> <span class="o">=</span> <span class="n">trf</span><span class="o">.</span><span class="n">rot_quaternion</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">n_comps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">box_overlap</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                
                <span class="n">concentration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">concentration_surface</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">concentration</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                    
                    <span class="n">l_perp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">l_perp</span>
                    <span class="n">length</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_length</span>
                    
                    <span class="n">hits_in_dt</span> <span class="o">=</span> <span class="n">length</span><span class="o">*</span><span class="n">l_perp</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">concentration</span>
                    
                    <span class="n">D</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans_2d</span>
                    <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                    
                    
                    <span class="n">N_crossed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">hits_in_dt</span><span class="p">)</span>
                    
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_crossed</span><span class="p">):</span>
                            
                        <span class="n">tri_id_0</span> <span class="o">=</span> <span class="n">randu</span><span class="o">.</span><span class="n">random_choice</span><span class="p">(</span><span class="n">cum_weights</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="s1">&#39;cum_edge_length&#39;</span><span class="p">])</span>
                        
                        
                        <span class="n">tri_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">tri_id_0</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span>
                        <span class="n">tri_direction</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">tri_id_0</span><span class="p">][</span><span class="s1">&#39;direction_normal&#39;</span><span class="p">]</span>
                        
                        <span class="n">edge_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_2d</span><span class="p">[</span><span class="n">tri_id_0</span><span class="p">][</span><span class="s1">&#39;edge_id&#39;</span><span class="p">]</span>
                        
                        <span class="n">e0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="n">edge_id</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">e1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;edges&#39;</span><span class="p">][</span><span class="n">edge_id</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                        
                        <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">e0</span><span class="p">]</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">e1</span><span class="p">]</span> 
                        
                        <span class="n">xm</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">dx_rand</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">lamb</span>
                        
                        <span class="n">pos</span> <span class="o">=</span> <span class="n">random_point_on_edge</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">)</span>
                        <span class="n">dX</span> <span class="o">=</span> <span class="n">xm</span><span class="o">*</span><span class="n">tri_direction</span>
                        
                        
                        <span class="n">face_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                        
                        <span class="c1">#Rotation into the plane of the triangle:</span>
                        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_to_plane</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">quat</span><span class="p">)</span>
                        
                        <span class="c1"># Random orientation in plane</span>
                        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_random_axis_rot</span><span class="p">(</span><span class="n">quat</span><span class="p">,</span> <span class="n">face_normal</span><span class="p">)</span>
                        
                        
                        <span class="n">add_molecule_single</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">tri_id</span><span class="p">,</span> <span class="n">molecule</span><span class="p">)</span>
                        
                        
                        <span class="n">RBs</span><span class="p">[</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dX&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">dX</span>
                        
                        <span class="n">RBs</span><span class="o">.</span><span class="n">update_particle_pos_2D</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>



<span class="c1">#%%</span>

<div class="viewcode-block" id="add_molecules"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.add_molecules">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">add_molecules</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">triangle_ids</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">Types</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Places new molecules on teh surface of a compartment, given their positions, orientations, triangle ids and types.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment_id : `int64`</span>
<span class="sd">        id of the compartment</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">        Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of Particles class   </span>
<span class="sd">    pos : `array_like`</span>
<span class="sd">        Positions of the molecule centers   </span>
<span class="sd">    quaternion : `array_like`</span>
<span class="sd">        Rotation quaternions of the molecules</span>
<span class="sd">    triangle_ids : `array_like`</span>
<span class="sd">        Triangle ids of the molecules</span>
<span class="sd">    mol_type_ids : `array_like`</span>
<span class="sd">        Type ids of the molecules</span>
<span class="sd">    Types : `array_like`</span>
<span class="sd">        Array of strings of the molecule names</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)):</span>
        
        <span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Types</span><span class="p">[</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">RBs</span><span class="o">.</span><span class="n">set_triangle</span><span class="p">(</span><span class="n">triangle_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        
        <span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
                
<span class="c1">#%%</span>

<div class="viewcode-block" id="add_molecule_single"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.add_molecule_single">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">add_molecule_single</span><span class="p">(</span><span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">triangle_id</span><span class="p">,</span> <span class="n">mol_type</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Places a single new molecule into a compartment, given its position, orientation, triangle id and type.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment_id : `int64`</span>
<span class="sd">        id of the compartment</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">        Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of Particles class   </span>
<span class="sd">    pos : `array_like`</span>
<span class="sd">        Position of the molecul center   </span>
<span class="sd">    quaternion : `array_like`</span>
<span class="sd">        Rotation quaternion of the molecule</span>
<span class="sd">    triangle_ids : `array_like`</span>
<span class="sd">        Triangle ids of the molecules</span>
<span class="sd">    mol_type : `string`</span>
<span class="sd">        Molecule name</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_type</span><span class="p">),</span> <span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">set_triangle</span><span class="p">(</span><span class="n">triangle_id</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
    
    

<span class="c1">#%%</span>

<div class="viewcode-block" id="normal"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.normal">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">normal</span><span class="p">(</span><span class="n">triangle_id</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">center</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Distributes molecules spherically around a point on a mesh surface by a gaussian distribution and using a ray marching algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    triangle_id : `int64`</span>
<span class="sd">        triangle id around whose centroid the molecules are distributed</span>
<span class="sd">    jitter : `float64`</span>
<span class="sd">        Standard deviation of the normal distribution</span>
<span class="sd">    number : `int64[:]`</span>
<span class="sd">        Number of molecules to distribute per type</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of molecule names</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[N,3], float64[N,4], int64[N])</span>
<span class="sd">        Positions, Quaternions, and Molecule ids</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># We pick a point on a triangle and then randomly draw distance vectors from a gaussian distribution.</span>
    <span class="c1"># Next, we simply raymarch along that vector on the mesh surface!</span>
    
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">center</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">origin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_id</span><span class="p">][</span><span class="s1">&#39;triangle_centroid&#39;</span><span class="p">])</span>
    
    <span class="n">W_inv</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
        
    <span class="n">positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">origin</span>
    <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">))</span>
    <span class="n">molecules_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
    <span class="n">quaternions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
    
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span> 
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)):</span>
        <span class="n">x_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jitter</span><span class="p">)</span>
        <span class="n">y_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jitter</span><span class="p">)</span>
        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
        
        <span class="n">tri_id</span> <span class="o">=</span> <span class="n">ray_march_surface</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">quaternions</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">triangle_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">update_quat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">tri_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span> 
            <span class="c1"># distribution was not successfull (molecule got absorbed due to fixed concentration boundary condition)</span>
            <span class="k">continue</span>
        
        <span class="n">triangle_ids</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">tri_id</span>
    
        <span class="n">face_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        
        <span class="c1"># Rotation into the plane of the triangle:</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_to_plane</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">quaternions</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
        
        <span class="c1"># Random orientation in plane</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_random_axis_rot</span><span class="p">(</span><span class="n">quaternions</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">face_normal</span><span class="p">)</span>
        
        <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    
    
    <span class="n">N0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
        <span class="n">molecules_id</span><span class="p">[</span><span class="n">N0</span><span class="p">:</span><span class="n">N0</span><span class="o">+</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        <span class="n">N0</span> <span class="o">+=</span> <span class="n">N</span>

    <span class="k">return</span> <span class="n">positions</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">quaternions</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">molecules_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">triangle_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">]</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="point_in_disc"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.point_in_disc">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">point_in_disc</span><span class="p">(</span><span class="n">triangle_id</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed inside a disc with radius r that lies within the plane of given mesh triangle.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    triangle_id : `int64`</span>
<span class="sd">        Index of the triangle from where the point is distributed</span>
<span class="sd">    radius : `float`</span>
<span class="sd">        Radius of the disc</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class    </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `float64[3]`</span>
<span class="sd">        Random point uniformly distributed in a disc.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">W_inv</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">T</span>
    
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> 

    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span>
    <span class="n">x_r</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y_r</span> <span class="o">=</span> <span class="n">r</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    
    <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">x_r</span> <span class="o">+</span> <span class="n">W_inv</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">y_r</span>
    
    <span class="k">return</span> <span class="n">dX</span></div>


<div class="viewcode-block" id="trace_direction_vector"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.trace_direction_vector">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">trace_direction_vector</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">triangle_id</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Traces the path along a direction vector, and, depending on the boundary conditions and the presence of mesh compartments updates the direction vector. If the direction vector hits an absorptive boundary (fixed concentration boundary conditions) triangle id -1 is returned.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dX : `float64[3]`</span>
<span class="sd">        Direction vector</span>
<span class="sd">    origin : `float64[3]`</span>
<span class="sd">        Origin of the molecule</span>
<span class="sd">    triangle_id : `int64`</span>
<span class="sd">        Triangle id of the starting position/origin. </span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>

<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[3], float64[4], int64)</span>
<span class="sd">        Returns position, quaternion, and triangle_id of the new position. If path hit an absorptive boundary triangle_id = -1 is returned.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># We pick a point on a triangle and then randomly draw a distance vector.</span>
    <span class="c1"># Next, we simply raymarch along that vector on the mesh surface!</span>
    
    <span class="n">position</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
    
    <span class="c1"># create a quaternion</span>
    <span class="n">quaternion</span> <span class="o">=</span>  <span class="n">trf</span><span class="o">.</span><span class="n">rot_quaternion</span><span class="p">()</span>
    
    <span class="c1"># Ray march on surface without updating the molecules quaternion (not necessary since we assign a random orietnetation afterwards anyway):</span>
    <span class="n">triangle_id</span> <span class="o">=</span> <span class="n">ray_march_surface</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">triangle_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">update_quat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1">#Rotation into the plane of the triangle:</span>
    <span class="n">face_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_to_plane</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">)</span>
                        
    <span class="c1"># Random orientation in plane</span>
    <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_random_axis_rot</span><span class="p">(</span><span class="n">quaternion</span><span class="p">,</span> <span class="n">face_normal</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">position</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">triangle_id</span></div>
        
<span class="c1">#%%</span>


<div class="viewcode-block" id="pds"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.pds">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">pds</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">facegroup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Uniformly distributes molecules of different types on the mesh surface of a compartment using a blue noise/poisson disc sampling algorithm originaly introduced by :cite:t:`Corsini2012`.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of molecule names</span>
<span class="sd">    number : `float64[:]`</span>
<span class="sd">        Number of molecules to distribute per given type</span>
<span class="sd">    facegroup : `string`</span>
<span class="sd">        Name of the facegroup to which to restrict the molecule distribution. Default = None</span>
<span class="sd">    multiplier : `int64`</span>
<span class="sd">        Specifies the multiplication factor by which the algorithm upscales the target number for the Monte Carlo sampling. Default = 50</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4])</span>
<span class="sd">        Returns arrays of the positions, molecule types, and rotation quaternions of the distributed moelcules.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">))</span>
    <span class="n">mol_type_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">moltype</span><span class="p">)]</span><span class="o">.</span><span class="n">radius_2d</span>
        <span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        
    <span class="n">weights</span> <span class="o">=</span> <span class="n">radii</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">radii</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">face_ids</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">poisson_disc_sampling_2D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">facegroup</span><span class="p">,</span> <span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; molecules &#39;</span><span class="o">+</span><span class="n">moltype</span><span class="o">+</span><span class="s1">&#39; distributed on surface of compartment &#39;</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span>      </div>


<span class="c1">#%%</span>

<span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">mc</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">face_group</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

    <span class="n">N_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    
    <span class="n">mol_type_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
    
    <span class="n">points_type</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">N_total</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">N0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mol_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">):</span>
        <span class="n">points_type</span><span class="p">[</span><span class="n">N0</span><span class="p">:</span><span class="n">N0</span><span class="o">+</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mol_id</span>
        <span class="n">N0</span><span class="o">+=</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        
        
    <span class="n">points</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">monte_carlo_distribution_2D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">N_total</span><span class="p">,</span> <span class="n">facegroup</span> <span class="o">=</span> <span class="n">face_group</span><span class="p">)</span>
    
    
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">N_total</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_total</span><span class="p">):</span>
        
        <span class="c1">#Rotation into the plane of the triangle:</span>
        <span class="n">face_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">face_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="c1"># create a quaternion</span>
        <span class="n">q</span> <span class="o">=</span>  <span class="n">trf</span><span class="o">.</span><span class="n">rot_quaternion</span><span class="p">()</span>
        <span class="c1"># Rotation into the plane of the triangle:</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_to_plane</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
        
        <span class="c1"># Random orientation in plane</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_random_axis_rot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">face_normal</span><span class="p">)</span>

        <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">q</span>
                
        
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molecules distributed on surface of compartment &#39;</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">N</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span> 


<span class="c1">#%%</span>


<div class="viewcode-block" id="monte_carlo_distribution_2D"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.monte_carlo_distribution_2D">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">monte_carlo_distribution_2D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">N_total</span><span class="p">,</span> <span class="n">facegroup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Does Monte Carlo sampling for N points inside a compartment.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    N_total : `int64`</span>
<span class="sd">        Total number of points to distribute</span>
<span class="sd">    facegroup : `string`</span>
<span class="sd">        Name of the facegroup to which to restrict the molecule distribution. Default = None    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[:,3]</span>
<span class="sd">        Array of positions</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">if</span> <span class="n">facegroup</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">triangle_ids_exclTransp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">facegroup</span><span class="p">)][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span>
        
    <span class="n">A_max</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">triangle_ids</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">])</span>
    
    <span class="n">points_MC</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_1</span><span class="p">)</span>
    <span class="n">face_ids_MC</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_2</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="k">while</span> <span class="n">count</span><span class="o">&lt;</span><span class="n">N_total</span><span class="p">:</span>
        
        <span class="n">face_id0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids</span><span class="p">))</span>
        <span class="n">face_id</span> <span class="o">=</span> <span class="n">triangle_ids</span><span class="p">[</span><span class="n">face_id0</span><span class="p">]</span>
        
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">face_id</span><span class="p">][</span><span class="s1">&#39;triangle_area&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">A_max</span><span class="p">:</span>
        
            <span class="n">X</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">face_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
            
            <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
            <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">X</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        
            <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
            <span class="c1"># Osada et al. 2002, Shape Distributions</span>
            <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">))</span><span class="o">*</span><span class="n">p0</span><span class="o">+</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">mu</span><span class="p">))</span><span class="o">*</span><span class="n">p1</span><span class="o">+</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lamb</span><span class="p">))</span><span class="o">*</span><span class="n">p2</span>  
            
            <span class="n">outside</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">outside</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                    <span class="n">outside</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">outside</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                                        
                <span class="n">points_MC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>           
                <span class="n">face_ids_MC</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_id</span><span class="p">)</span>
                
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            
    <span class="k">return</span> <span class="n">points_MC</span><span class="p">,</span> <span class="n">face_ids_MC</span></div>


<div class="viewcode-block" id="poisson_disc_sampling_2D"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_surface_util.html#pyrid.system.distribute_surface_util.poisson_disc_sampling_2D">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">poisson_disc_sampling_2D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">facegroup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">50</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Uniformly distributes spheres of different radii inside a compartment using a blue noise/poisson disc sampling algorithm originaly introduced by :cite:t:`Corsini2012` to distribute points on triangulated mesh surfaces but that has been adapted here for volume distributions. PyRID also uses a variant of the original algorithm to distribute molecules on mesh surfaces.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    radii : `int64[:]`</span>
<span class="sd">        radii of the different sphere types</span>
<span class="sd">    mol_type_ids : `array_like`</span>
<span class="sd">        Array of molecule type ids</span>
<span class="sd">    weights : `float64[:]`</span>
<span class="sd">        Weights specifying how often the different sphere types are selected for distribution. Weights should be higher for large spheres since the probability of a successfull trial is lower than for small spheres.</span>
<span class="sd">    N : `float64[:]`</span>
<span class="sd">        Number of molecules to distribute per given type</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    facegroup : `string`</span>
<span class="sd">        Name of the facegroup to which to restrict the molecule distribution. Default = None</span>
<span class="sd">    multiplier : `int64`</span>
<span class="sd">        Specifies the multiplication factor by which the algorithm upscales the target number for the Monte Carlo sampling. Default = 100</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError(&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points in Compartment!&#39;)</span>
<span class="sd">        Raised if the selected compartment does not overlap with the simulation box.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4], int64)</span>
<span class="sd">        Returns arrays of the positions, types and rotations quaternions. Also return the total count of distributed spheres.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The algorithm is based on Corsini et al. 2012, Efficient and Flexible Sampling with Blue Noise Properties of Triangular Meshes.</span>
<span class="sd">    </span>
<span class="sd">    The algorithm consists of 10 steps:</span>
<span class="sd">        </span>
<span class="sd">    1. Generate a sample pool S using monte_carlo_distribution_3D().</span>
<span class="sd">    2. Divide space into cells and count the number of samples in each cell.</span>
<span class="sd">    3. Randomly select a cell weighted by the number of active samples in each cell (active sample: sample that is not yet occupied or deleted).</span>
<span class="sd">    4. Randomly select a sample from the selected cell.</span>
<span class="sd">    5. Randomly choose a particle type of radius Ri (weighted by the relative number of each type that we want to distribute).</span>
<span class="sd">    6. Check whether the distance of the selected sample to the neighboring samples that are already occupied is larger or equal to Ri+Rj.</span>
<span class="sd">    7. If True, accept the sample and add the molecule type and position to an occupied sample list. Next, delete all other samples within radius Ri, as these wont ever become occupied anyway.</span>
<span class="sd">    8. Update the number count of samples for the current cell.</span>
<span class="sd">    9. While the desired number of molecules is not reached, return to 3. However, set a maximum number of trials.</span>
<span class="sd">    10. If their are no active samples left before we reach the desired molecule number and the maximum number of trials, generate a new sample pool.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Check if any part of the compartment is actually in the simulation box so we dont end</span>
    <span class="c1"># up in an infinite loop!</span>
    <span class="n">Compartment_in_box</span> <span class="o">=</span> <span class="n">mesh_inside_box_test</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">Compartment_in_box</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="c1"># print(&#39;Warning: There is no overlap of the Compartment with the Simulation box!&#39;)</span>
        <span class="c1"># return None, None, None, None, None</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points on Compartment Surface!&#39;</span><span class="p">)</span>
    
    
    <span class="n">points</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_1</span><span class="p">)</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_1</span><span class="p">)</span>
    <span class="n">points_type</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_2</span><span class="p">)</span>
    <span class="n">face_ids_psd</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_2</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
    <span class="c1">#1. -----------------------------------------------------</span>
    <span class="n">N_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">multiplier</span>
    <span class="n">sample_points</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">monte_carlo_distribution_2D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">N_total</span><span class="p">,</span> <span class="n">facegroup</span><span class="p">)</span>
    
    <span class="c1">#2. -----------------------------------------------------</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">)</span> <span class="c1"># np.max(radii)*10</span>
    
    <span class="n">active_cell_list</span><span class="p">,</span> <span class="n">N_samples_cell</span><span class="p">,</span> <span class="n">nonempty_cells</span><span class="p">,</span> <span class="n">Ncell</span><span class="p">,</span> <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="n">create_cell_list_points</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
    
    <span class="n">occupied_cell_list</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncell</span><span class="p">):</span>

        <span class="n">occupied_cell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_4</span><span class="p">))</span>
        
    <span class="c1">#3.1 -----------------------------------------------------</span>
    
    <span class="n">N_Trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">max_Trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)):</span>
        <span class="n">max_Trials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">pos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="n">N</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">N_Trials</span><span class="o">&lt;</span><span class="n">max_Trials</span><span class="p">):</span>
        
        <span class="c1">#3.2 -----------------------------------------------------</span>
        <span class="c1"># Randomly select a cell weighted by the number of active samples. Yes, this can be done better...</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonempty_cells</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">selected</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">cell_id</span> <span class="o">=</span> <span class="n">nonempty_cells</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nonempty_cells</span><span class="p">))]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">N_samples_cell</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N_samples_cell</span><span class="p">):</span>            
                    
                    <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="c1">#3.3 Randomly select a sample from the selected cell.</span>
                    <span class="n">sample_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">N_samples_cell</span><span class="p">[</span><span class="n">cell_id</span><span class="p">])</span>
                    <span class="n">sample_id</span> <span class="o">=</span> <span class="n">active_cell_list</span><span class="p">[</span><span class="n">cell_id</span><span class="p">][</span><span class="n">sample_nr</span><span class="p">]</span>
                    
                    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">sample_points</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># generate new samples</span>
            <span class="k">break</span>
                
        <span class="c1">#4. -----------------------------------------------------</span>
        <span class="c1"># Randomly choose a particle type of radius Ri (weighted by the relative number of each </span>
        <span class="c1"># type that we want to distribute).</span>
        <span class="n">dN</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="n">count</span> <span class="c1">#difference between goal and current number of molecules for each type</span>
        <span class="n">dN_weight</span> <span class="o">=</span> <span class="n">dN</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dN</span><span class="p">)</span>
        
        <span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="n">selected</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">type_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">N_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&lt;</span><span class="n">max_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                <span class="n">N_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">dN_weight</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">weights</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                        <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">N_Trials</span><span class="o">&gt;=</span><span class="n">max_Trials</span><span class="p">):</span>
                <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
                     
        <span class="c1">#5. -----------------------------------------------------</span>
        <span class="c1"># Check whether the distance of the selected sample to the neighboring samples that are </span>
        <span class="c1"># already occupied is larger or equal to Ri+Rj.</span>
        
        <span class="n">boundary_check</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">:</span>
            <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span>

        
        <span class="k">if</span> <span class="n">boundary_check</span><span class="p">:</span>
                
            <span class="n">fits</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">cz</span> <span class="o">=</span> <span class="n">reverse_cell_mapping</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">cells_per_dim</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">cz_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cz</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">cy_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                    <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">cx_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="mi">2</span><span class="p">):</span>
                        <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        
                        <span class="n">cell_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">+</span> <span class="n">cx_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">+</span> <span class="n">cy_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">+</span> <span class="n">cz_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        
                        <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">occupied_cell_list</span><span class="p">[</span><span class="n">cell_temp</span><span class="p">]:</span>
                            <span class="n">sample_id_j</span><span class="p">,</span> <span class="n">type_id_j</span> <span class="o">=</span> <span class="n">neighbour</span>
                            <span class="n">pos_j</span> <span class="o">=</span> <span class="n">sample_points</span><span class="p">[</span><span class="n">sample_id_j</span><span class="p">]</span> 
                            
                            <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                            
                            <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                    
                            <span class="k">if</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id_j</span><span class="p">]:</span>
                                <span class="n">fits</span><span class="o">=</span><span class="kc">False</span>
            
            <span class="c1"># 6. -----------------------------------------------------</span>
            <span class="c1"># If True, accept the sample and add the molecule type and position to an occupied sample list. </span>
            <span class="c1"># Next, delete all other samples within radius Ri, as these wont ever become occupied anyway.</span>
            <span class="k">if</span> <span class="n">fits</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                
                <span class="n">count</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                
                <span class="n">occupied_cell_list</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">type_id</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
                
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_i</span><span class="p">)</span>
                <span class="n">points_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span>
                <span class="n">face_ids_psd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">face_ids</span><span class="p">[</span><span class="n">sample_id</span><span class="p">])</span>
                
                <span class="c1">#Rotation into the plane of the triangle:</span>
                <span class="n">face_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">face_ids</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                <span class="c1"># create a quaternion</span>
                <span class="n">q</span> <span class="o">=</span>  <span class="n">trf</span><span class="o">.</span><span class="n">rot_quaternion</span><span class="p">()</span>
                <span class="c1"># Rotation into the plane of the triangle:</span>
                <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_to_plane</span><span class="p">(</span><span class="n">face_normal</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
                
                <span class="c1"># Random orientation in plane</span>
                <span class="n">trf</span><span class="o">.</span><span class="n">quaternion_random_axis_rot</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">face_normal</span><span class="p">)</span>
    
                <span class="n">quaternion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                
                <span class="c1">#7. -----------------------------------------------------</span>
                <span class="c1"># Update the number count of samples for the current cell.</span>
            
    <span class="c1"># print(&#39;N_Trials: &#39;, N_Trials)</span>
    <span class="c1"># print(&#39;max_Trials: &#39;, max_Trials)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">face_ids_psd</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span></div>
                
                

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>