<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.system.distribute_vol_util &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyrid.system.distribute_vol_util</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.system.distribute_vol_util</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">..geometry.mesh_util</span> <span class="kn">import</span> <span class="n">point_triangle_distance</span>
<span class="kn">from</span> <span class="nn">..geometry.intersections_util</span> <span class="kn">import</span> <span class="n">point_inside_AABB_test</span><span class="p">,</span> <span class="n">mesh_inside_box_test</span><span class="p">,</span> <span class="n">point_inside_mesh_test</span>
<span class="kn">from</span> <span class="nn">..geometry.ray_march_util</span> <span class="kn">import</span> <span class="n">ray_march_volume</span>
<span class="kn">from</span> <span class="nn">..math</span> <span class="kn">import</span> <span class="n">random_util</span> <span class="k">as</span> <span class="n">randu</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">..system.distribute_surface_util</span> <span class="kn">import</span> <span class="n">random_point_in_triangle</span>
<span class="kn">from</span> <span class="nn">..data_structures.cell_list_util</span> <span class="kn">import</span> <span class="n">create_cell_list_mesh</span><span class="p">,</span> <span class="n">create_cell_list_points</span><span class="p">,</span> <span class="n">reverse_cell_mapping</span>


<span class="c1">#%%</span>

<div class="viewcode-block" id="release_molecules_boundary"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.release_molecules_boundary">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">release_molecules_boundary</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Releases molecules into the volume at the simulation box boundary given an outside concentration of the different molecule types.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">       Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The average number of molecules that hit a boundary of area :math:`A` from one side within a time step :math:`\\Delta t` can be calculated from the molecule concentration :math:`C` and the average distance a diffusing molecule travels normal to a plane :math:`l_{n}` within :math:`\\Delta t` :cite:p:`Kerr2008`:</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       N_{hits} = \\frac{A l_{n}}{2 C},</span>
<span class="sd">    </span>
<span class="sd">    where</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">    </span>
<span class="sd">       l_{n} = \\sqrt{\\frac{4D\\Delta t}{\\pi}}.</span>
<span class="sd">       </span>
<span class="sd">    Here :math:`D = Tr(\\boldsymbol{D}^{tt,b})/3` is the scalar translational diffusion constant.</span>
<span class="sd">    The boundary crossing of molecules can be described as a poisson process. As such, the number of molecules that cross the boundary each time step is drawn from a poisson distribution with a rate :math:`N_{hits}`.</span>
<span class="sd">    </span>
<span class="sd">    The normalized distance that a crossing molecule ends up away from the plane/boundary follows the following distribution :cite:p:`Kerr2008`:</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        P(d\\tilde{x}) = 1-e^{-d\\tilde{x}^2}+\\sqrt{\\pi}*dx*\\text{erfc}(d\\tilde{x})</span>
<span class="sd">        </span>
<span class="sd">    The distance vector normal to the plane after the crossing can then be calculated from the diffusion length constant :math:`\\lambda` and the plane&#39;s normal vector :math:`\\hat{\\boldsymbol{n}}` by :math:`d\\boldsymbol{x} = \\lambda \\, d\\tilde{x} \\, \\hat{\\boldsymbol{n}} = \sqrt{4Dt} \\, d\\tilde{x} \\, \\hat{\\boldsymbol{n}}`.</span>
<span class="sd">    </span>
<span class="sd">    In the case that a molecule enters the simulation box near to another boundary, e.g. of a mesh compartment, we may also want to account for the distance traveled parallel to the plane in order to correctly resolve collision with the mesh. However, currently PyRID does not account for this. For small intregration time steps and meshes that are further than :math:`\sqrt{4Dt}` away from the simulation box border, the error introduced should however be negligable.</span>
<span class="sd">    </span>
<span class="sd">    Now that the number of molecules and their distance away from the plane are determined, the molecules are distributed in the simualtion box. Since the diffusion along each dimension is independent we can simply pick a random point uniformly distributed on the respective plane. For triangulated mesh surfaces, triangles are picked randomly, weighted by their area. Sampling a uniformly distributed random point in a triangle is done by :cite:p:`Osada2002`</span>
<span class="sd">    </span>
<span class="sd">    .. math::</span>
<span class="sd">        </span>
<span class="sd">        P(\\boldsymbol{r}) = (1-\\sqrt{\\mu_1})*\\boldsymbol{p}_0+(\\sqrt{\\mu_1}*(1-\\mu_2))*\\boldsymbol{p}_1+(\\mu_2*\\sqrt{\\mu_1})*\\boldsymbol{p}_2  ,</span>
<span class="sd">        </span>
<span class="sd">    where :math:`\\mu_1, \\mu_2` are random numbers between 0 and 1. :math:`\\boldsymbol{p}_0, \\boldsymbol{p}_1, \\boldsymbol{p}_2` are the three vertices of the triangle.</span>
<span class="sd">    </span>
<span class="sd">    Note that, in general, here we neglect any interactions between the virtual molecules. Therefore, fixed concentration boundary conditions only result in the same inside and outside concentrations if no molecular in teractions are simulated.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">comp_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
            
            <span class="n">concentration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">concentration</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">concentration</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="n">l_perp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">l_perp</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_area</span>
                
                <span class="n">hits_in_dt</span> <span class="o">=</span> <span class="n">area</span><span class="o">*</span><span class="n">l_perp</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">concentration</span>
                
                <span class="n">D</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                
                <span class="n">N_crossed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">hits_in_dt</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_crossed</span><span class="p">):</span>
                        
                    <span class="n">dim</span> <span class="o">=</span> <span class="n">randu</span><span class="o">.</span><span class="n">random_choice</span><span class="p">(</span><span class="n">cum_weights</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">])</span>
                    <span class="n">side</span> <span class="o">=</span> <span class="n">sides</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">2</span><span class="p">)]</span>
                    <span class="n">xm</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">dx_rand</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">lamb</span>
                        
                    <span class="n">axes_</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">axes</span> <span class="k">if</span> <span class="n">x</span><span class="o">!=</span><span class="n">dim</span><span class="p">]</span>
                    
                    <span class="n">pos</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">side</span><span class="o">*</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">xm</span><span class="p">)</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">axes_</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">pos</span><span class="p">[</span><span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">axes_</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">quat</span> <span class="o">=</span> <span class="n">random_quaternion</span><span class="p">()</span>
                        
                    <span class="n">add_molecule_single</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">molecule</span><span class="p">)</span>
                    
                    
    <span class="k">else</span><span class="p">:</span>
        
        <span class="n">comp_id</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">sides</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
            
            <span class="n">concentration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">concentration</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">concentration</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                <span class="n">l_perp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">l_perp</span>
                <span class="n">area</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_area</span>
                
                <span class="n">hits_in_dt</span> <span class="o">=</span> <span class="n">area</span><span class="o">*</span><span class="n">l_perp</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">concentration</span>
                
                <span class="n">D</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans</span>
                <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                
                
                <span class="n">N_crossed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">hits_in_dt</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_crossed</span><span class="p">):</span>
                        
                    <span class="n">tri_id_0</span> <span class="o">=</span> <span class="n">randu</span><span class="o">.</span><span class="n">random_choice</span><span class="p">(</span><span class="n">cum_weights</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">])</span>
                    <span class="n">tri_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_border</span><span class="p">[</span><span class="n">tri_id_0</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span>
                    
                    <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]]</span>
                    <span class="n">tri_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                    
                    <span class="n">p0</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">p1</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">p2</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    
                    <span class="n">xm</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">dx_rand</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">lamb</span>
                    
                    <span class="n">pos</span> <span class="o">=</span> <span class="n">random_point_in_triangle</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
                    <span class="n">dX</span> <span class="o">=</span> <span class="o">-</span><span class="n">xm</span><span class="o">*</span><span class="n">tri_normal</span>
                    
                    <span class="n">quat</span> <span class="o">=</span> <span class="n">random_quaternion</span><span class="p">()</span>
                    
                    
                    <span class="n">add_molecule_single</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">molecule</span><span class="p">)</span>
                    
                    
                    <span class="n">RBs</span><span class="p">[</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dX&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">dX</span>
                    
                    <span class="n">RBs</span><span class="o">.</span><span class="n">update_particle_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">n_comps</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">box_overlap</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">molecule</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                    
                    <span class="n">concentration</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">concentration</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">concentration</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span>
                        
                        <span class="n">l_perp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">l_perp</span>
                        <span class="n">area</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_area</span>
                        
                        <span class="n">hits_in_dt</span> <span class="o">=</span> <span class="n">area</span><span class="o">*</span><span class="n">l_perp</span><span class="o">/</span><span class="mi">2</span><span class="o">*</span><span class="n">concentration</span>
                        
                        <span class="n">D</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">molecule</span><span class="p">]</span><span class="o">.</span><span class="n">Dtrans</span>
                        <span class="n">lamb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">D</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
                        
                        <span class="n">N_crossed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">poisson</span><span class="p">(</span><span class="n">hits_in_dt</span><span class="p">)</span>
                        
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_crossed</span><span class="p">):</span>
                                
                            <span class="n">tri_id_0</span> <span class="o">=</span> <span class="n">randu</span><span class="o">.</span><span class="n">random_choice</span><span class="p">(</span><span class="n">cum_weights</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_3d</span><span class="p">[</span><span class="s1">&#39;cum_area&#39;</span><span class="p">])</span>
                            <span class="n">tri_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">border_3d</span><span class="p">[</span><span class="n">tri_id_0</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span>
                            
                            <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]]</span>
                            <span class="n">tri_normal</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                            
                            <span class="n">p0</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">p1</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            <span class="n">p2</span> <span class="o">=</span> <span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            
                            <span class="n">xm</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">dx_rand</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">lamb</span>
                            
                            <span class="n">pos</span> <span class="o">=</span> <span class="n">random_point_in_triangle</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">)</span>
                            <span class="n">dX</span> <span class="o">=</span> <span class="o">-</span><span class="n">xm</span><span class="o">*</span><span class="n">tri_normal</span>
                            
                            <span class="n">quat</span> <span class="o">=</span> <span class="n">random_quaternion</span><span class="p">()</span>
                            
                            
                            <span class="n">add_molecule_single</span><span class="p">(</span><span class="n">comp_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quat</span><span class="p">,</span> <span class="n">molecule</span><span class="p">)</span>
                            
                            
                            <span class="n">RBs</span><span class="p">[</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;dX&#39;</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">dX</span>
                            
                            <span class="n">RBs</span><span class="o">.</span><span class="n">update_particle_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="random_quaternion"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.random_quaternion">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">random_quaternion</span><span class="p">():</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a unit quaternion representing a uniformly distributed random rotation.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The method can be found in K. Shoemake, Graphics Gems III by D. Kirk, pages 124-132 :cite:p:`Kirk2012` and on http://planning.cs.uiuc.edu/node198.html:</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            </span>
<span class="sd">            \\boldsymbol{q} = [\\sqrt{1-u_1} \\, \\sin(2 \\pi u_2), \\sqrt{1-u_1} \\, \\cos(2 \\pi u_2), \\sqrt{u_1} \\, \\sin(2 \\pi u_3), \\sqrt{u_1} \\, \\cos(2 \\pi u_3)] ,</span>
<span class="sd">    </span>
<span class="sd">            </span>
<span class="sd">    where :math:`u_1,u_2,u_3 \\in [0,1]` are uniformly distributed random numbers. :math:`\\boldsymbol{q}` is a uniformly distributed, random rotation quaternion.</span>
<span class="sd">                                                                                                                                                              </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `float64[4]`</span>
<span class="sd">        Uniformly distributed, random rotation quaternion</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">)])</span></div>


<div class="viewcode-block" id="random_quaternion_tuple"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.random_quaternion_tuple">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">random_quaternion_tuple</span><span class="p">():</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a unit quaternion representing a uniformly distributed random rotation.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The method can be found in K. Shoemake, Graphics Gems III by D. Kirk, pages 124-132 :cite:p:`Kirk2012` and on http://planning.cs.uiuc.edu/node198.html:</span>
<span class="sd">        </span>
<span class="sd">        .. math::</span>
<span class="sd">            </span>
<span class="sd">            \\boldsymbol{q} = [\\sqrt{1-u_1} \\, \\sin(2 \\pi u_2), \\sqrt{1-u_1} \\, \\cos(2 \\pi u_2), \\sqrt{u_1} \\, \\sin(2 \\pi u_3), \\sqrt{u_1} \\, \\cos(2 \\pi u_3)] ,</span>
<span class="sd">    </span>
<span class="sd">            </span>
<span class="sd">    where :math:`u_1,u_2,u_3 \\in [0,1]` are uniformly distributed random numbers. :math:`\\boldsymbol{q}` is a uniformly distributed, random rotation quaternion.</span>
<span class="sd">                                                                                                                                                              </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    `tuple[4]`</span>
<span class="sd">        Uniformly distributed, random rotation quaternion</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Based on K. Shoemake. Uniform random rotations. In D. Kirk, editor, Graphics Gems III, pages 124-132. Academic, New York, 1992. http://planning.cs.uiuc.edu/node198.html</span>
    
    <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(),</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">)</span></div>


<div class="viewcode-block" id="point_on_sphere"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.point_on_sphere">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">point_on_sphere</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed on the surface of a sphere with radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius : `float`</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float, float, float)</span>
<span class="sd">        Uniformly distributed random point on sphere surface</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">u</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span></div>

<div class="viewcode-block" id="point_in_sphere_simple"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.point_in_sphere_simple">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">point_in_sphere_simple</span><span class="p">(</span><span class="n">radius</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random point uniformly distributed in the volume of a sphere with radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    radius : `float`</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float, float, float)</span>
<span class="sd">        Uniformly distributed random point in sphere volume</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="n">radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">u</span>
    <span class="k">return</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="add_molecules"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.add_molecules">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">add_molecules</span><span class="p">(</span><span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Places new molecules into a compartment, given their positions, orientations and types.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment_id : `int64`</span>
<span class="sd">        id of the compartment</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">        Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of Particles class   </span>
<span class="sd">    pos : `array_like`</span>
<span class="sd">        Positions of the molecule centers   </span>
<span class="sd">    quaternion : `array_like`</span>
<span class="sd">        Rotation quaternions of the molecules</span>
<span class="sd">    mol_type_ids : `array_like`</span>
<span class="sd">        Type ids of the molecules</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of the molecule names</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">pos</span><span class="p">)):</span>
        
        <span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">pos</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
        
        <span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="add_molecule_single"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.add_molecule_single">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">add_molecule_single</span><span class="p">(</span><span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">mol_type</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Places a single new molecule into a compartment, given its position, orientation and type.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment_id : `int64`</span>
<span class="sd">        id of the compartment</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">        Instance of RBs class</span>
<span class="sd">    Particles : `object`</span>
<span class="sd">        Instance of Particles class   </span>
<span class="sd">    pos : `array_like`</span>
<span class="sd">        Position of the molecul center   </span>
<span class="sd">    quaternion : `array_like`</span>
<span class="sd">        Rotation quaternion of the molecule</span>
<span class="sd">    mol_type : `string`</span>
<span class="sd">        Molecule name</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_type</span><span class="p">),</span> <span class="n">Compartment_id</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
    
    <span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span></div>
        

<span class="c1">#%%</span>


<div class="viewcode-block" id="normal"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.normal">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">normal</span><span class="p">(</span><span class="n">origin</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Distributes molecules spherically around a point by a gaussian distribution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    origin : `float64[3]`</span>
<span class="sd">        Origin of the distribution</span>
<span class="sd">    jitter : `float64`</span>
<span class="sd">        Standard deviation of the normal distribution</span>
<span class="sd">    number : `int64[:]`</span>
<span class="sd">        Number of molecules to distribute per type</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of molecule names</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[N,3], float64[N,4], int64[N])</span>
<span class="sd">        Positions, Quaternions, and Molecule ids</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span><span class="o">*</span><span class="n">origin</span>
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span><span class="mi">4</span><span class="p">))</span>
    
    <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">)):</span>
        
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
            
            <span class="n">success</span> <span class="o">=</span> <span class="n">ray_march_volume</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">System</span><span class="p">)</span>
            
        
        <span class="k">else</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                
            
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">success</span> <span class="o">=</span> <span class="n">point_inside_AABB_test</span><span class="p">(</span><span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">)</span>
                
            
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                
                
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">+</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        
                        <span class="n">boundary</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">])</span><span class="o">/</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
                        <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][:]</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                        
                    <span class="k">elif</span> <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">+</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        
                        <span class="n">boundary</span> <span class="o">=</span> <span class="o">-</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">])</span><span class="o">/</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
                        <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][:]</span> <span class="o">+=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][:]</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">pos</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
                        
        <span class="k">if</span> <span class="n">success</span><span class="p">:</span>
            
            <span class="n">q1</span><span class="p">,</span><span class="n">q2</span><span class="p">,</span><span class="n">q3</span><span class="p">,</span><span class="n">q4</span> <span class="o">=</span> <span class="n">random_quaternion_tuple</span><span class="p">()</span>
            <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">q1</span>
            <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">q2</span>
            <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">q3</span>
            <span class="n">quaternion</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">q4</span>
            
            <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    
    
    <span class="n">molecules_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">number</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">N0</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">number</span><span class="p">):</span>
        <span class="n">molecules_id</span><span class="p">[</span><span class="n">N0</span><span class="p">:</span><span class="n">N0</span><span class="o">+</span><span class="n">N</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        <span class="n">N0</span> <span class="o">+=</span> <span class="n">N</span>

    <span class="k">return</span> <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">quaternion</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">],</span> <span class="n">molecules_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="n">j</span><span class="p">]</span></div>
                

<div class="viewcode-block" id="random_direction_sphere"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.random_direction_sphere">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">random_direction_sphere</span><span class="p">(</span><span class="n">sphere_radius</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random direction vector uniformly distributed in the volume of a sphere with radius r.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sphere_radius : `float64`</span>
<span class="sd">        Radius of the sphere</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[3]</span>
<span class="sd">        Direction vector</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="n">sphere_radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">u</span>
    
    <span class="k">return</span> <span class="n">dX</span></div>


<div class="viewcode-block" id="random_direction_Halfsphere"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.random_direction_Halfsphere">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">random_direction_Halfsphere</span><span class="p">(</span><span class="n">sphere_radius</span><span class="p">,</span> <span class="n">normal</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Returns a random direction vector uniformly distributed in the volume of a half-sphere with radius r, splitted in half in direction of a given plane normal vector.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sphere_radius : `float64`</span>
<span class="sd">        Radius of the sphere</span>
<span class="sd">    normal : `float64[3]`</span>
<span class="sd">        Normal vector of the plane splitting the sphere in half</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    First a uniformly distributed random vector :math:`d\\boldsymbol{X}` that sites somewhere within the full sphere is drawn.</span>
<span class="sd">    Next, we test whether the vector points into the same direction as the plane normal vector :math:`\\hat{\\boldsymbol{n}}` via their dot product.</span>
<span class="sd">    If the dot product is negative, the direction vector is reflected at the plane by :math:`d\\boldsymbol{X}_{refl} = d\\boldsymbol{X} -2 d\\boldsymbol{X} \cdot \\hat{\\boldsymbol{n}}`.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[3]</span>
<span class="sd">        Direction vector</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">u</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">phi</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
    
    <span class="n">D</span> <span class="o">=</span> <span class="n">sphere_radius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>
    <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">D</span><span class="o">*</span><span class="n">u</span>
    
    <span class="n">dX_dot_n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="n">normal</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dX_dot_n</span><span class="o">&lt;</span><span class="mf">0.0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">dX</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">dX_dot_n</span><span class="o">*</span><span class="n">normal</span>
    
    <span class="k">return</span> <span class="n">dX</span></div>


<div class="viewcode-block" id="trace_direction_vector"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.trace_direction_vector">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">trace_direction_vector</span><span class="p">(</span><span class="n">dX</span><span class="p">,</span> <span class="n">origin</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Traces the path along a direction vector, and, depending on the boundary conditions and the presence of mesh compartments updates the direction vector. If the direction vector hits an absorptive boundary (fixed concentration boundary conditions), returns False, indicating that the corresponding molecule needs to be deleted.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dX : `float64[3]`</span>
<span class="sd">        Direction vector</span>
<span class="sd">    origin : `float64[3]`</span>
<span class="sd">        Origin of the molecule</span>
<span class="sd">    pos : `float64[3]`</span>
<span class="sd">        New position/origin of the moelcule is saved in this array. </span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>

<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Indicates whether the position tracing was successful or the molecule hit an absorptive boundary.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
        
        <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
        <span class="n">success</span> <span class="o">=</span> <span class="n">ray_march_volume</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">dX</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">success</span>
    
    <span class="k">else</span><span class="p">:</span>
        
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="n">inside_box</span> <span class="o">=</span> <span class="n">point_inside_AABB_test</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">inside_box</span>
        
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pos</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">+</span><span class="n">dX</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                    
                    <span class="n">boundary</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">/</span><span class="n">dX</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                    <span class="n">pos</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span>
                    <span class="n">dX</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span>
                    <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
                    
                <span class="k">elif</span> <span class="n">pos</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">+</span><span class="n">dX</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">&lt;-</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                    
                    <span class="n">boundary</span> <span class="o">=</span> <span class="o">-</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="n">boundary</span> <span class="o">-</span> <span class="n">pos</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span><span class="o">/</span><span class="n">dX</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span>
                    <span class="n">pos</span><span class="p">[:]</span> <span class="o">+=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span>
                    <span class="n">dX</span><span class="p">[:]</span> <span class="o">-=</span> <span class="n">t</span><span class="o">*</span><span class="n">dX</span>
                    <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dX</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    
            
            <span class="k">return</span> <span class="kc">True</span></div>
        
        
            
<span class="c1">#%%</span>


<div class="viewcode-block" id="pds"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.pds">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">pds</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Distributes a number of molecules of different types inside the volume of a compartment using a poisson disc sampling algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of molecule names</span>
<span class="sd">    number : `float64[:]`</span>
<span class="sd">        Number of molecules to distribute per given type</span>
<span class="sd">    clustering factor : `int64`</span>
<span class="sd">        Determines how much the molecules are spread inside the compartment. Higher values are necessary for uniform distributions at low density. Default = 1</span>
<span class="sd">    max_trials : `int64`</span>
<span class="sd">        Maximum number of trials to find a new position around a given active point in the poisson disc sampling algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4])</span>
<span class="sd">        Returns arrays of the positions, molecule types, and rotation quaternions of the distributed moelcules.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">))</span>
    <span class="n">mol_type_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">moltype</span><span class="p">)]</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        
    <span class="n">weights</span> <span class="o">=</span> <span class="n">radii</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
    <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">poisson_disc_sampling</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">number</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="p">,</span> <span class="n">max_trials</span><span class="p">)</span>
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molecules distributed in volume of compartment &#39;</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span></div>


    

<div class="viewcode-block" id="poisson_disc_sampling"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.poisson_disc_sampling">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)    </span>
<span class="k">def</span> <span class="nf">poisson_disc_sampling</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="p">,</span> <span class="n">max_trials</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Poisson disc sampling algorithm for different sized spheres, accounting for different boundary conditions and mesh compartment boundaries. The algorithm is based on :cite:t:`Bridson2007`. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    radii : `float64[:]`</span>
<span class="sd">        Radii of the different sphere types</span>
<span class="sd">    mol_type_ids : `array_like`</span>
<span class="sd">        Type ids of the different spheres</span>
<span class="sd">    N : `float64[:]`</span>
<span class="sd">        Number of spheres to distribute per given type</span>
<span class="sd">    clustering factor : `int64`</span>
<span class="sd">        Determines how much the spheres are spread inside the compartment. Higher values are necessary for uniform distributions at low density. Default = 1</span>
<span class="sd">    max_trials : `int64`</span>
<span class="sd">        Maximum number of trials to find a new position around a given active point in the poisson disc sampling algorithm.</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError(&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points in Compartment!&#39;)</span>
<span class="sd">        Raised if the selected compartment does not overlap with the simulation box.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4], int64)</span>
<span class="sd">        Returns arrays of the positions, types and rotations quaternions. Also return the total count of distributed spheres.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    

    
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="p">:</span>
        <span class="c1"># Check if any part of the compartment is actually in the simulation box so we dont end</span>
        <span class="c1"># up in an infinite loop!</span>
        <span class="n">Compartment_in_box</span> <span class="o">=</span> <span class="n">mesh_inside_box_test</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Compartment_in_box</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>

            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points in Compartment!&#39;</span><span class="p">)</span>
            
    
    <span class="n">pos_tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> 
        
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">/</span> <span class="n">rc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cells_per_dim</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: Cell division &lt;3&#39;</span><span class="p">)</span>
        <span class="n">cell_length_per_dim</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">/</span> <span class="n">cells_per_dim</span>
        
        <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">)</span>
        
        <span class="n">CellList</span><span class="p">,</span> <span class="n">AABB_centers</span> <span class="o">=</span> <span class="n">create_cell_list_mesh</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">cells_per_dim</span><span class="p">,</span> <span class="n">cell_length_per_dim</span><span class="p">,</span> <span class="n">triangle_ids</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># np.max(System.box_lengths)/50</span>
    
    <span class="n">dim</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">dim</span>
    
    <span class="n">origin_x</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">origin_y</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">origin_z</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    
    <span class="n">width</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">width</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">height</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">height</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">depth</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
        <span class="n">depth</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        
    <span class="n">number_types</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
    <span class="n">diameter</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span>
    <span class="n">searchRadius</span> <span class="o">=</span> <span class="n">clustering_factor</span><span class="o">*</span><span class="p">(</span><span class="nb">max</span><span class="p">((</span><span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="n">depth</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">searchRadius</span><span class="o">&lt;</span><span class="n">diameter</span><span class="p">:</span>
        <span class="n">searchRadius</span> <span class="o">=</span> <span class="n">diameter</span>
    <span class="c1"># print(&#39;searchRadius: &#39;, searchRadius)</span>
    <span class="n">w0</span> <span class="o">=</span> <span class="n">diameter</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">cells_per_dim_pds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">w0</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">width</span><span class="o">/</span><span class="n">cells_per_dim_pds</span>

    
    <span class="c1">#Step 0</span>
    <span class="n">columns</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">height</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
    <span class="n">aisles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">depth</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
    <span class="n">grid</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rows</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">aisles</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">grid_type</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">rows</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">aisles</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">active</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">ptype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">type_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">))</span>
    <span class="n">points_ptype</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="c1">#Step 1</span>
    
    
    <span class="n">seed_found</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">count_loop</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">seed_found</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
        <span class="n">count_loop</span><span class="o">+=</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">count_loop</span><span class="o">&gt;</span><span class="mi">10000</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Canceled while loop: Not able to place moelcule seed in poisson_disc_sampling()&#39;</span><span class="p">)</span>
            
        <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">width</span>
        <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">height</span>
        <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span><span class="o">*</span><span class="n">depth</span>
        <span class="n">i</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
        <span class="n">j</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">y</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
        <span class="n">k</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">z</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">z</span><span class="p">])</span>
        <span class="n">type_1_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">number_types</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
                <span class="n">Compartment_temp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                <span class="n">point_on_correct_side_temp</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos</span><span class="o">+</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span>
                <span class="k">if</span> <span class="n">point_on_correct_side_temp</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>        
        
        <span class="n">boundary_check</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">:</span>
            <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">width</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">height</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span> <span class="ow">or</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;fixed concentration&#39;</span><span class="p">:</span>
            <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">width</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span> <span class="ow">and</span> <span class="n">height</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">&gt;</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span>
        
        <span class="k">if</span> <span class="n">boundary_check</span> <span class="ow">and</span> <span class="n">point_on_correct_side</span><span class="p">:</span>         
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>              
                <span class="c1"># !!! Here we use a loose cell grid!</span>
                <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
                <span class="c1"># Determine cell in 3D volume for i-th particle</span>
                <span class="n">cell</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cz</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            
                <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e6</span>
                <span class="n">triangles_list</span> <span class="o">=</span> <span class="n">CellList</span><span class="o">.</span><span class="n">get_triangles</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangles_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">Tri_idx</span> <span class="ow">in</span> <span class="n">triangles_list</span><span class="p">:</span>
                        
                        <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
                    
                        <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                        <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                        <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
        
                        <span class="n">dist</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">point_triangle_distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">pos</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">pos_tri</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">dist</span><span class="o">&lt;</span><span class="n">min_dist</span><span class="p">:</span>
                            <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span>
                <span class="n">no_overlap</span> <span class="o">=</span> <span class="n">min_dist</span> <span class="o">&gt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">no_overlap</span> <span class="o">=</span> <span class="kc">True</span>    
                
            <span class="k">if</span> <span class="n">no_overlap</span><span class="p">:</span>
                <span class="n">seed_found</span> <span class="o">=</span> <span class="kc">True</span>
    
    
    <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">pos</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">))]))</span>
    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>
    <span class="n">quaternion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_quaternion</span><span class="p">())</span>
    <span class="n">ptype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_1_idx</span><span class="p">)</span>
    <span class="n">points_ptype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">])</span>
    <span class="n">grid</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">columns</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">rows</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">grid_type</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="o">*</span><span class="n">columns</span><span class="o">+</span><span class="n">k</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">rows</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_1_idx</span>
    <span class="n">count</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    

    <span class="n">trials</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="n">N</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">trials</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">active</span><span class="p">))</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">type_1_idx</span> <span class="o">=</span> <span class="n">ptype</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">]</span>
        
        <span class="c1">#====================================================</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">randu</span><span class="o">.</span><span class="n">random_choice</span><span class="p">(</span><span class="n">weights</span> <span class="o">=</span> <span class="n">weights</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">])</span>
        
        <span class="c1"># probDensity = np.zeros(len(weights[active[rand_idx][1]==1])+1)</span>
        <span class="c1"># sort_indices = randu.probDens_2(weights[active[rand_idx][1]==1], probDensity)</span>
        <span class="c1"># idx = randu.binary_search(probDensity, sort_indices, np.random.rand())</span>
        <span class="c1">#====================================================</span>
        
        <span class="n">type_2_idx</span> <span class="o">=</span> <span class="n">type_list</span><span class="p">[</span><span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">][</span><span class="n">idx</span><span class="p">]</span>
        
        <span class="n">found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span><span class="o">&lt;</span><span class="n">N</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]:</span>
            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_trials</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arccos</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">())</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">],(</span><span class="n">radii</span><span class="p">[</span><span class="n">type_1_idx</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">])</span><span class="o">+</span><span class="n">searchRadius</span><span class="p">)</span>
                
                <span class="n">offsetX</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">offsetY</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">offsetZ</span> <span class="o">=</span> <span class="n">m</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="n">sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">offsetX</span><span class="p">,</span> <span class="n">offsetY</span><span class="p">,</span> <span class="n">offsetZ</span><span class="p">])</span>
                <span class="n">sample</span> <span class="o">+=</span> <span class="n">pos</span>
                

                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
                    <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
                        <span class="n">Compartment_temp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                        <span class="n">point_on_correct_side_temp</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">sample</span><span class="o">+</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span>
                        <span class="k">if</span> <span class="n">point_on_correct_side_temp</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
                    <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">sample</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>  
                
                
                <span class="n">boundary_check</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">:</span>
                    <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">width</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">height</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;periodic&#39;</span> <span class="ow">or</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;fixed concentration&#39;</span><span class="p">:</span>
                    <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">width</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span> <span class="ow">and</span> <span class="n">height</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span> <span class="ow">and</span> <span class="n">depth</span><span class="o">&gt;</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=</span><span class="mf">0.0</span>
                
                <span class="k">if</span> <span class="n">boundary_check</span> <span class="ow">and</span> <span class="n">point_on_correct_side</span><span class="p">:</span> 


                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> 
                        <span class="c1"># !!! Here we use a loose cell grid!</span>
                        <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                
                        <span class="c1"># Determine cell in 3D volume for i-th particle</span>
                        <span class="n">cell</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cz</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        
                    
                        <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e6</span>
                        <span class="n">triangles_list</span> <span class="o">=</span> <span class="n">CellList</span><span class="o">.</span><span class="n">get_triangles</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangles_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">Tri_idx</span> <span class="ow">in</span> <span class="n">triangles_list</span><span class="p">:</span>
                                
                                <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
                            
                                <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                                
                                <span class="n">dist</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">point_triangle_distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">sample</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">,</span> <span class="n">pos_tri</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">dist</span><span class="o">&lt;</span><span class="n">min_dist</span><span class="p">:</span>
                                    <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span>
                        <span class="n">no_overlap</span> <span class="o">=</span> <span class="n">min_dist</span> <span class="o">&gt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">no_overlap</span> <span class="o">=</span> <span class="kc">True</span>
                        
                            
                    <span class="k">if</span> <span class="n">no_overlap</span><span class="p">:</span>
                        
                        <span class="n">col</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
                        <span class="n">aisle</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">w</span><span class="p">)</span>
                        
                        <span class="n">ok</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">NNrange</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">])</span><span class="o">/</span><span class="n">w</span><span class="p">)</span> 
                        
                        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">aisle</span><span class="o">-</span><span class="n">NNrange</span><span class="p">,</span><span class="n">aisle</span><span class="o">+</span><span class="n">NNrange</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                            <span class="n">k_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">aisles</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">aisles</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">aisles</span><span class="p">)</span>
                            <span class="n">k_pos_shift</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">depth</span> <span class="o">*</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">depth</span><span class="o">*</span><span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="n">aisles</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">row</span><span class="o">-</span><span class="n">NNrange</span><span class="p">,</span><span class="n">row</span><span class="o">+</span><span class="n">NNrange</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                <span class="n">j_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">rows</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">rows</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">rows</span><span class="p">)</span>
                                <span class="n">j_pos_shift</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">height</span> <span class="o">*</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">height</span><span class="o">*</span><span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="n">rows</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">col</span><span class="o">-</span><span class="n">NNrange</span><span class="p">,</span><span class="n">col</span><span class="o">+</span><span class="n">NNrange</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                                    <span class="n">i_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">columns</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">columns</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">columns</span><span class="p">)</span>
                                    <span class="n">i_pos_shift</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">width</span> <span class="o">*</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">width</span><span class="o">*</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">columns</span><span class="p">)</span>
                            
                                
                                    <span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">i_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">j</span> <span class="o">+</span> <span class="n">j_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">columns</span> <span class="o">+</span> <span class="p">(</span><span class="n">k</span> <span class="o">+</span> <span class="n">k_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">columns</span> <span class="o">*</span> <span class="n">rows</span>
                                    <span class="n">neighbour</span> <span class="o">=</span> <span class="n">grid</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                    <span class="n">neighbour_type</span> <span class="o">=</span> <span class="n">grid_type</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                    <span class="k">if</span> <span class="n">neighbour</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                                        <span class="n">dx</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">neighbour</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">i_pos_shift</span><span class="p">)</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">neighbour</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">j_pos_shift</span><span class="p">)</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">neighbour</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">k_pos_shift</span><span class="p">)</span>
                                        <span class="n">d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

                                        <span class="k">if</span> <span class="n">d</span><span class="o">&lt;</span><span class="p">(</span><span class="n">radii</span><span class="p">[</span><span class="n">neighbour_type</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]):</span>
                                            <span class="n">ok</span> <span class="o">=</span> <span class="kc">False</span>

                                        
                        <span class="k">if</span> <span class="n">ok</span><span class="p">:</span>
                            <span class="n">found</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
                            <span class="n">points_ptype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">])</span>
                            <span class="n">active</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">([</span><span class="n">sample</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">))]))</span>
                            <span class="n">ptype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">type_2_idx</span><span class="p">)</span>
                            <span class="n">count</span><span class="p">[</span><span class="n">type_2_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">grid</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">row</span><span class="o">*</span><span class="n">columns</span><span class="o">+</span><span class="n">aisle</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">rows</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                            <span class="n">grid_type</span><span class="p">[</span><span class="n">col</span><span class="o">+</span><span class="n">row</span><span class="o">*</span><span class="n">columns</span><span class="o">+</span><span class="n">aisle</span><span class="o">*</span><span class="n">columns</span><span class="o">*</span><span class="n">rows</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_2_idx</span>
                            
                            <span class="n">q</span> <span class="o">=</span> <span class="n">random_quaternion</span><span class="p">()</span>
                            <span class="n">quaternion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                            
                            <span class="k">break</span>
                        
                    
        <span class="k">if</span> <span class="ow">not</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="n">type_2_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">active</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">ptype</span><span class="p">[</span><span class="n">rand_idx</span><span class="p">]</span>
        
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">origin_x</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">origin_y</span>
        <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">origin_z</span>
        
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_ptype</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span></div>


<span class="c1">#%%</span>

<div class="viewcode-block" id="mc"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.mc">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">mc</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">N</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Does Monte Carlo sampling for N molecules inside a compartment returning vectors for the molecule positions, types and orientations.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    mol_types : `list of strings`</span>
<span class="sd">        List of molecule types to distribute.</span>
<span class="sd">    N : `int64[:]`</span>
<span class="sd">        Total number of molecules to distribute per molecule type.</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4])</span>
<span class="sd">        molecule positions, molecule types, molecule orientations in quaternion representation</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">mol_type_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        
    <span class="n">AABB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&lt;</span><span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
            <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
            <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
    
    <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">points</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">points_type</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">mol_id</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">):</span>
        
        <span class="k">while</span> <span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">&lt;</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            
            <span class="n">pos_MC</span> <span class="o">=</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">box_lengths</span>
        
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
                <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
                    <span class="n">Compartment_temp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                    <span class="n">point_on_correct_side_temp</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos_MC</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span>
                    <span class="k">if</span> <span class="n">point_on_correct_side_temp</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
                <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos_MC</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>   
                
    
            <span class="k">if</span> <span class="n">point_on_correct_side</span><span class="p">:</span> 
                <span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_MC</span><span class="p">)</span>
                <span class="n">points_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_id</span><span class="p">)</span>
                <span class="n">quaternion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">random_quaternion</span><span class="p">())</span>
                
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Molecules distributed in volume of compartment &#39;</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="n">count</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span></div>
    
    
    
<span class="c1">#%%</span>


<span class="n">listtype_1</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">float64</span><span class="p">[:]</span>
<span class="n">listtype_2</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span>
<span class="n">listtype_3</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
<span class="n">listtype_4</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:]</span>
<span class="n">listtype_5</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">ListType</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">int64</span><span class="p">[:])</span>


<div class="viewcode-block" id="pds_uniform"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.pds_uniform">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">pds_uniform</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">mol_types</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Uniformly distributes molecules of different types inside a compartment using a blue noise/poisson disc sampling algorithm originaly introduced by :cite:t:`Corsini2012` to distribute points on triangulated mesh surfaces but that has been adapted here for volume distributions. PyRID also uses a variant of the original algorithm to distribute molecules on mesh surfaces.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    mol_types : `array_like`</span>
<span class="sd">        Array of strings of molecule names</span>
<span class="sd">    N : `float64[:]`</span>
<span class="sd">        Number of molecules to distribute per given type</span>
<span class="sd">    multiplier : `int64`</span>
<span class="sd">        Specifies the multiplication factor by which the algorithm upscales the target number for the Monte Carlo sampling. Default = 100</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4])</span>
<span class="sd">        Returns arrays of the positions, molecule types, and rotation quaternions of the distributed moelcules.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">))</span>
    <span class="n">mol_type_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mol_types</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="n">radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">moltype</span><span class="p">)]</span><span class="o">.</span><span class="n">radius</span>
        <span class="n">mol_type_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">mol_types</span><span class="p">[</span><span class="n">i</span><span class="p">])]</span><span class="o">.</span><span class="n">type_id</span>
        
    <span class="n">weights</span> <span class="o">=</span> <span class="n">radii</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">radii</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">poisson_disc_sampling_uniform</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">moltype</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mol_types</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="o">+</span><span class="s1">&#39; molecules &#39;</span><span class="o">+</span><span class="n">moltype</span><span class="o">+</span><span class="s1">&#39; distributed in volume of compartment &#39;</span><span class="o">+</span><span class="n">Compartment</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;-------------------------------&#39;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span></div>



<div class="viewcode-block" id="monte_carlo_distribution_3D"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.monte_carlo_distribution_3D">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">monte_carlo_distribution_3D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">N_total</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Does Monte Carlo sampling for N points inside a compartment.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    N_total : `int64`</span>
<span class="sd">        Total number of points to distribute</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float64[:,3]</span>
<span class="sd">        Array of positions</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="n">AABB</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">AABB</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&lt;</span><span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
            <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span><span class="o">&gt;</span><span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]:</span>
            <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span>
    
    <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    
    <span class="n">points_MC</span> <span class="o">=</span> <span class="n">AABB</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">N_total</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">box_lengths</span>
                
    <span class="k">return</span> <span class="n">points_MC</span></div>


<div class="viewcode-block" id="poisson_disc_sampling_uniform"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/distribute_vol_util.html#pyrid.system.distribute_vol_util.poisson_disc_sampling_uniform">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span>
<span class="k">def</span> <span class="nf">poisson_disc_sampling_uniform</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">radii</span><span class="p">,</span> <span class="n">mol_type_ids</span><span class="p">,</span> <span class="n">weights</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Uniformly distributes spheres of different radii inside a compartment using a blue noise/poisson disc sampling algorithm originaly introduced by :cite:t:`Corsini2012` to distribute points on triangulated mesh surfaces but that has been adapted here for volume distributions. PyRID also uses a variant of the original algorithm to distribute molecules on mesh surfaces.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Compartment : `object`</span>
<span class="sd">        Instance of Compartment class</span>
<span class="sd">    radii : `int64[:]`</span>
<span class="sd">        radii of the different sphere types</span>
<span class="sd">    mol_type_ids : `array_like`</span>
<span class="sd">        Array of molecule type ids</span>
<span class="sd">    weights : `float64[:]`</span>
<span class="sd">        Weights specifying how often the different sphere types are selected for distribution. Weights should be higher for large spheres since the probability of a successfull trial is lower than for small spheres.</span>
<span class="sd">    N : `float64[:]`</span>
<span class="sd">        Number of molecules to distribute per given type</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">    multiplier : `int64`</span>
<span class="sd">        Specifies the multiplication factor by which the algorithm upscales the target number for the Monte Carlo sampling. Default = 100</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError(&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points in Compartment!&#39;)</span>
<span class="sd">        Raised if the selected compartment does not overlap with the simulation box.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float64[:,3], int64[:], float64[:,4], int64)</span>
<span class="sd">        Returns arrays of the positions, types and rotations quaternions. Also return the total count of distributed spheres.</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    The algorithm is based on Corsini et al. 2012, Efficient and Flexible Sampling with Blue Noise Properties of Triangular Meshes.</span>
<span class="sd">    </span>
<span class="sd">    The algorithm consists of 10 steps:</span>
<span class="sd">        </span>
<span class="sd">    1. Generate a sample pool S using monte_carlo_distribution_3D().</span>
<span class="sd">    2. Divide space into cells and count the number of samples in each cell.</span>
<span class="sd">    3. Randomly select a cell weighted by the number of active samples in each cell (active sample: sample that is not yet occupied or deleted).</span>
<span class="sd">    4. Randomly select a sample from the selected cell.</span>
<span class="sd">    5. Randomly choose a particle type of radius Ri (weighted by the relative number of each type that we want to distribute).</span>
<span class="sd">    6. Check whether the distance of the selected sample to the neighboring samples that are already occupied is larger or equal to Ri+Rj.</span>
<span class="sd">    7. If True, accept the sample and add the molecule type and position to an occupied sample list. Next, delete all other samples within radius Ri, as these wont ever become occupied anyway.</span>
<span class="sd">    8. Update the number count of samples for the current cell.</span>
<span class="sd">    9. While the desired number of molecules is not reached, return to 3. However, set a maximum number of trials.</span>
<span class="sd">    10. If their are no active samples left before we reach the desired molecule number and the maximum number of trials, generate a new sample pool.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span> 
        
        <span class="n">rc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">)</span>
        <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">/</span> <span class="n">rc</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">cells_per_dim</span><span class="o">&lt;</span><span class="mi">3</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;error: Cell division &lt;3&#39;</span><span class="p">)</span>
        <span class="n">cell_length_per_dim</span> <span class="o">=</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span> <span class="o">/</span> <span class="n">cells_per_dim</span>
        
        <span class="n">triangle_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">N_triangles</span><span class="p">)</span>
        
        <span class="n">CellList</span><span class="p">,</span> <span class="n">AABB_centers</span> <span class="o">=</span> <span class="n">create_cell_list_mesh</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">,</span> <span class="n">cells_per_dim</span><span class="p">,</span> <span class="n">cell_length_per_dim</span><span class="p">,</span> <span class="n">triangle_ids</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span> <span class="c1"># np.max(System.box_lengths)/50</span>
        
        
        <span class="c1"># Check if any part of the compartment is actually in the simulation box so we dont end</span>
        <span class="c1"># up in an infinite loop!</span>
        <span class="n">Compartment_in_box</span> <span class="o">=</span> <span class="n">mesh_inside_box_test</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Compartment_in_box</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
    
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There is no overlap of the Compartment with the Simulation box! Unable to distribute points inside Compartment!&#39;</span><span class="p">)</span>
    
    
    <span class="n">points</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_1</span><span class="p">)</span>
    <span class="n">points_type</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_2</span><span class="p">)</span>
    <span class="n">quaternion</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="p">()</span>
    <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    
    <span class="c1">#1. -----------------------------------------------------</span>
    <span class="n">N_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N</span><span class="p">)</span><span class="o">*</span><span class="n">multiplier</span><span class="c1">#50</span>
    <span class="n">sample_points</span> <span class="o">=</span> <span class="n">monte_carlo_distribution_3D</span><span class="p">(</span><span class="n">Compartment</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">N_total</span><span class="p">)</span>
    
    <span class="c1">#2. -----------------------------------------------------</span>
    <span class="n">rc</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">radii</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">)</span><span class="o">/</span><span class="mi">25</span><span class="p">)</span> <span class="c1"># np.max(radii)*10</span>
    
    <span class="n">active_cell_list</span><span class="p">,</span> <span class="n">N_samples_cell</span><span class="p">,</span> <span class="n">nonempty_cells</span><span class="p">,</span> <span class="n">Ncell</span><span class="p">,</span> <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="n">create_cell_list_points</span><span class="p">(</span><span class="n">rc</span><span class="p">,</span> <span class="n">sample_points</span><span class="p">,</span> <span class="n">Compartment</span><span class="p">)</span>
    
    <span class="n">occupied_cell_list</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_5</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Ncell</span><span class="p">):</span>

        <span class="n">occupied_cell_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">List</span><span class="o">.</span><span class="n">empty_list</span><span class="p">(</span><span class="n">listtype_4</span><span class="p">))</span>
        
    <span class="c1">#3.1 -----------------------------------------------------</span>
    
    <span class="n">N_Trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="n">max_Trials</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">)):</span>
        <span class="n">max_Trials</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">50</span><span class="o">*</span><span class="n">N</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">/</span><span class="n">weights</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    
    <span class="n">pos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span>
        
    <span class="k">while</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">count</span><span class="o">&gt;=</span><span class="n">N</span><span class="p">)</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">N_Trials</span><span class="o">&lt;</span><span class="n">max_Trials</span><span class="p">):</span>
        
        <span class="c1">#3.2 -----------------------------------------------------</span>
        <span class="c1"># Randomly select a cell weighted by the number of active samples. Yes, this can be done better...</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nonempty_cells</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">selected</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">cell_id</span> <span class="o">=</span> <span class="n">nonempty_cells</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">nonempty_cells</span><span class="p">))]</span>
                <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>

                <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">N_samples_cell</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">N_samples_cell</span><span class="p">):</span>            
                    
                    <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="c1">#3.3 Randomly select a sample from the selected cell.</span>
                    <span class="n">sample_nr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">N_samples_cell</span><span class="p">[</span><span class="n">cell_id</span><span class="p">])</span>
                    <span class="n">sample_id</span> <span class="o">=</span> <span class="n">active_cell_list</span><span class="p">[</span><span class="n">cell_id</span><span class="p">][</span><span class="n">sample_nr</span><span class="p">]</span>
                    
                    <span class="n">pos_i</span> <span class="o">=</span> <span class="n">sample_points</span><span class="p">[</span><span class="n">sample_id</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># generate new samples</span>
            <span class="k">break</span>
        
        <span class="c1">#3.3 -----------------------------------------------------</span>
        <span class="c1"># Check if point is inside the compartment</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">comp_id</span> <span class="ow">in</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
                <span class="n">Compartment_temp</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span>
                <span class="n">point_on_correct_side_temp</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment_temp</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos_i</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span><span class="o">==</span><span class="kc">False</span>
                <span class="k">if</span> <span class="n">point_on_correct_side_temp</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;System&#39;</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="n">point_inside_mesh_test</span><span class="p">(</span><span class="n">Compartment</span><span class="o">.</span><span class="n">triangle_ids</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="n">pos_i</span><span class="p">,</span> <span class="mf">1e0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">point_on_correct_side</span> <span class="o">=</span> <span class="kc">True</span>   
            

        <span class="k">if</span> <span class="n">point_on_correct_side</span><span class="p">:</span> 
                
            <span class="c1">#4. -----------------------------------------------------</span>
            <span class="c1"># Randomly choose a particle type of radius Ri (weighted by the relative number of each </span>
            <span class="c1"># type that we want to distribute).</span>
            <span class="n">dN</span> <span class="o">=</span> <span class="n">N</span><span class="o">-</span><span class="n">count</span> <span class="c1">#difference between goal and current number of molecules for each type</span>
            <span class="n">dN_weight</span> <span class="o">=</span> <span class="n">dN</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dN</span><span class="p">)</span>
            
            <span class="n">selected</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">while</span> <span class="n">selected</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
                <span class="n">type_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">radii</span><span class="p">))</span>
    
                <span class="k">if</span> <span class="n">N_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&lt;</span><span class="n">max_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                    <span class="n">N_Trials</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">dN_weight</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span>
                        <span class="k">if</span> <span class="n">val</span><span class="o">&lt;</span><span class="n">weights</span><span class="p">[</span><span class="n">type_id</span><span class="p">]:</span>
                            <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">N_Trials</span><span class="o">&gt;=</span><span class="n">max_Trials</span><span class="p">):</span>
                    <span class="n">selected</span> <span class="o">=</span> <span class="kc">True</span>
                         
            <span class="c1">#5. -----------------------------------------------------</span>
            <span class="c1"># Check whether the distance of the selected sample to the neighboring samples that are </span>
            <span class="c1"># already occupied is larger or equal to Ri+Rj.</span>
            
            <span class="n">boundary_check</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition</span> <span class="o">==</span> <span class="s1">&#39;repulsive&#39;</span><span class="p">:</span>
                <span class="n">boundary_check</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&gt;=-</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span>

            
            <span class="k">if</span> <span class="n">boundary_check</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span><span class="o">==</span><span class="kc">True</span> <span class="ow">and</span> <span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">:</span> 
                    <span class="c1"># !!! Here we use a loose cell grid!</span>
                    <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="n">Compartment</span><span class="o">.</span><span class="n">origin</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">/</span> <span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
                    <span class="c1"># Determine cell in 3D volume for i-th particle</span>
                    <span class="n">cell</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cz</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                
                    <span class="n">min_dist</span> <span class="o">=</span> <span class="mf">1e6</span>
                    <span class="n">triangles_list</span> <span class="o">=</span> <span class="n">CellList</span><span class="o">.</span><span class="n">get_triangles</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangles_list</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">Tri_idx</span> <span class="ow">in</span> <span class="n">triangles_list</span><span class="p">:</span>
                            
                            <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
                        
                            <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                            <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                            <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            
                            <span class="n">dist</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">point_triangle_distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">pos_i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">dist</span><span class="o">&lt;</span><span class="n">min_dist</span><span class="p">:</span>
                                <span class="n">min_dist</span> <span class="o">=</span> <span class="n">dist</span>
                    <span class="n">no_overlap</span> <span class="o">=</span> <span class="n">min_dist</span> <span class="o">&gt;=</span> <span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">no_overlap</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    
                <span class="k">if</span> <span class="n">no_overlap</span><span class="p">:</span>   
                
                    <span class="n">fits</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">cx</span><span class="p">,</span><span class="n">cy</span><span class="p">,</span><span class="n">cz</span> <span class="o">=</span> <span class="n">reverse_cell_mapping</span><span class="p">(</span><span class="n">cell_id</span><span class="p">,</span> <span class="n">cells_per_dim</span><span class="p">)</span>
                    
                    <span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cz</span> <span class="o">+</span> <span class="mi">2</span>
                    <span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="mi">2</span>
                    <span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="mi">2</span>
                    
                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        
                        <span class="k">if</span> <span class="n">cz_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cz_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cz_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            
                        <span class="k">if</span> <span class="n">cy_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cy_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cy_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            
                        <span class="k">if</span> <span class="n">cx_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cx_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cx_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
                    <span class="k">for</span> <span class="n">cz_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span><span class="p">):</span>
                        <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">cy_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span><span class="p">):</span>
                            <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">cx_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span><span class="p">):</span>
                                <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">Compartment</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                
                                <span class="n">cell_temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">+</span> <span class="n">cx_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">+</span> <span class="n">cy_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">+</span> <span class="n">cz_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                
                                <span class="k">for</span> <span class="n">neighbour</span> <span class="ow">in</span> <span class="n">occupied_cell_list</span><span class="p">[</span><span class="n">cell_temp</span><span class="p">]:</span>
                                    <span class="n">sample_id_j</span><span class="p">,</span> <span class="n">type_id_j</span> <span class="o">=</span> <span class="n">neighbour</span>
                                    <span class="n">pos_j</span> <span class="o">=</span> <span class="n">sample_points</span><span class="p">[</span><span class="n">sample_id_j</span><span class="p">]</span> 
                                    
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">-</span><span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                    
                                    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dy</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">dz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                                            
                                    <span class="k">if</span> <span class="n">distance</span><span class="o">&lt;</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span><span class="o">+</span><span class="n">radii</span><span class="p">[</span><span class="n">type_id_j</span><span class="p">]:</span>
                                        <span class="n">fits</span><span class="o">=</span><span class="kc">False</span>
                                        
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fits</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># 6. -----------------------------------------------------</span>
                <span class="c1"># If True, accept the sample and add the molecule type and position to an occupied sample list. </span>
                <span class="c1"># Next, delete all other samples within radius Ri, as these wont ever become occupied anyway.</span>
                <span class="k">if</span> <span class="n">fits</span><span class="o">==</span><span class="kc">True</span><span class="p">:</span>
                    
                    <span class="n">count</span><span class="p">[</span><span class="n">type_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="n">occupied_cell_list</span><span class="p">[</span><span class="n">cell_id</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sample_id</span><span class="p">,</span> <span class="n">type_id</span><span class="p">],</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">))</span>
                    
                    <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pos_i</span><span class="p">)</span>
                    <span class="n">points_type</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol_type_ids</span><span class="p">[</span><span class="n">type_id</span><span class="p">])</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">random_quaternion</span><span class="p">()</span>
                    <span class="n">quaternion</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
                    
                    <span class="c1">#7. -----------------------------------------------------</span>
                    <span class="c1"># Update the number count of samples for the current cell.</span>
            
    <span class="c1"># print(&#39;N_Trials: &#39;, N_Trials)</span>
    <span class="c1"># print(&#39;max_Trials: &#39;, max_Trials)</span>
    
    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">count</span></div>



</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>