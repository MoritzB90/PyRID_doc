<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.system.update_force &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>pyrid.system.update_force</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.system.update_force</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># import math</span>

<span class="c1"># from ..rand_util import random_util as randu</span>
<span class="kn">from</span> <span class="nn">..system</span> <span class="kn">import</span> <span class="n">potentials_util</span> <span class="k">as</span> <span class="n">potu</span>
<span class="kn">from</span> <span class="nn">..geometry.mesh_util</span> <span class="kn">import</span> <span class="n">point_triangle_distance</span>
<span class="kn">from</span> <span class="nn">..reactions.update_reactions</span> <span class="kn">import</span> <span class="n">convert_particle_type</span>

<span class="c1">#%%</span>

<div class="viewcode-block" id="react_interact_test"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/update_force.html#pyrid.system.update_force.react_interact_test">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">react_interact_test</span><span class="p">(</span><span class="n">comp_i</span><span class="p">,</span> <span class="n">loc_type_i</span><span class="p">,</span> <span class="n">mol_idx_j</span><span class="p">,</span> <span class="n">mol_idx_i</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">System</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;Tests if two particles are valid interaction or reaction partners.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    comp_i : `int64`</span>
<span class="sd">        Compartment index of molecule i</span>
<span class="sd">    loc_type_i : `int64`</span>
<span class="sd">        Location type of moelcule i (volume : 0, surface : 1)</span>
<span class="sd">    mol_idx_j : `int64`</span>
<span class="sd">        Index of moelcule j</span>
<span class="sd">    mol_idx_i : `int64`</span>
<span class="sd">        Index of moelcule i</span>
<span class="sd">    RBs : `object`</span>
<span class="sd">        Instance of RBs class</span>
<span class="sd">    System : `object`</span>
<span class="sd">        Instance of System class</span>
<span class="sd">        </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    We need to consider several cases:</span>
<span class="sd">        </span>
<span class="sd">    #. If both particles are in the same compartment</span>
<span class="sd">        #. and at least one is a volume molecule, interactions and reactions are always allowed.</span>
<span class="sd">        #. If both particles are surface molecules, interactions are always valid but reactions are only allowed if the angle between the molecules&#39; triangle normals is less than 90 degree.</span>
<span class="sd">    #. If both particles are in different compartments</span>
<span class="sd">        #. and both particles are volume molecules, neither interactions nor reactions are allowed.</span>
<span class="sd">        #. If both particles are surface particles, interactions are allowed, however, not reactions except binding reactions!</span>
<span class="sd">        #. If one of the particles belongs to a surface molecule and the other to a volume molecule</span>
<span class="sd">            #. reactions are always allowed if one of the compartments is the simulation box (System), otherwise neither reactions, nor interactions are allowed.</span>
<span class="sd">        </span>
<span class="sd">    We neglect reactions for surface molecules at an angle above 90 degree because the error introduced by using euclidian distances becomes large. In general, you should not use meshes with high local curvature (relative to the molecule size and reaction readius) and/or large angles between neighboring triangle for this reason. Also, triangles that are far apart in terms of the geodesic distance can come close to each other in terms of euclidian distance. In the latter case, the angle between the triangle is, however, in most cases larger than 90 degree. Thereby, neglecting reactions also prevents this type of erroneous reactions.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># comp_i = RBs[mol_idx_i][&#39;compartment&#39;]</span>
    <span class="n">comp_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">comp_i</span> <span class="o">==</span> <span class="n">comp_j</span><span class="p">:</span> <span class="c1"># if both particles are in the same compartment, interactions and reactions are always allowed (between volume molecules but also volume and surface moelcules)</span>
    
        <span class="k">if</span> <span class="n">loc_type_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        
        <span class="n">loc_type_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;loc_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">loc_type_j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        
        <span class="c1">#If both moelcules are surface molecules, we may want to check the angle between their triangles to see whether we want to allow reactions:</span>
        <span class="n">tri_id_I</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;triangle_id&#39;</span><span class="p">]</span>
        <span class="n">tri_id_J</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;triangle_id&#39;</span><span class="p">]</span>
        <span class="n">normal_i</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id_I</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">normal_j</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">tri_id_J</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
        <span class="n">cos_phi</span> <span class="o">=</span> <span class="n">normal_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">normal_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">normal_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">normal_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">normal_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">normal_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">cos_phi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> <span class="c1"># We allow reactions if the angle is smaller that 90 degree</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        
    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># loc_type_i = RBs[mol_idx_i][&#39;loc_id&#39;]</span>
        <span class="n">loc_type_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;loc_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">loc_type_i</span> <span class="o">==</span> <span class="n">loc_type_j</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">loc_type_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># If both molecules are volume molecules, neither interactions nor reactions are allowed:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">loc_type_i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># In the other case, i.e. if both are surface molecules, interactions are allowed, however, not reactions except binding reactions!</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># In the case where both molecules are from different compartments and different locations (surface vs volume), neither reactions, nor interactions are allowed, except the compartment of one molecule is System (comp_id = 0):</span>
            <span class="k">if</span> <span class="n">comp_i</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">comp_j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span></div>
            
        

<span class="c1">#%%</span>

<div class="viewcode-block" id="update_force_append_reactions"><a class="viewcode-back" href="../../../Developers/Developer%20API/system/update_force.html#pyrid.system.update_force.update_force_append_reactions">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="p">(</span><span class="n">fastmath</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">update_force_append_reactions</span><span class="p">(</span><span class="n">Particles</span><span class="p">,</span> <span class="n">System</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">HGrid</span><span class="p">):</span>
    

    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Updates the pair interaction forces between the particle pairs and between particles and the compartemnt meshes (and the simulation box boundary in case of repulsive boundary conditions).</span>
<span class="sd">    Also adds the bimolecular and unimolecular particle reactions to the reactions list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    System : `obj`</span>
<span class="sd">        Instance of System class.</span>
<span class="sd">    Particles : `obj`</span>
<span class="sd">        Instance of Particle class.</span>
<span class="sd">    RBs : `obj`</span>
<span class="sd">        Instance of RBs (Rigid Bodies) class.</span>
<span class="sd">    HGrid : `array_like`</span>
<span class="sd">        Hierarchical grid that divides the simulation box into cells. The cell size decreases with the level of the hierarchical grid. Particles are assigned to a level depending on their interaction cutoff radius.</span>
<span class="sd">        </span>
<span class="sd">        `dtype = np.dtype([(&#39;L&#39;, np.int64, (N_Levels,)), (&#39;sh&#39;, np.float64, (N_Levels,3)), (&#39;head&#39;, np.int64, (np.sum(NCells)*2,)), (&#39;head_start&#39;, np.int64, (N_Levels,)), (&#39;ls&#39;, np.int64, (2*N+1,)), (&#39;NCells&#39;, np.int64, (N_Levels,)), (&#39;cells_per_dim&#39;, np.int64, (N_Levels,3)), (&#39;cutoff&#39;, np.float64, (N_Levels,))],  align=True)`</span>
<span class="sd">    </span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    </span>
<span class="sd">    *Hierarchical Grid*</span>
<span class="sd">    </span>
<span class="sd">    The computationaly most expensive part in molecular dynamics simulations is usually the calculation of the pairwise interaction forces, beacuase to calculate these, we need to determine the distance between particles. When doing this in the most naiv way, i.e. for each particle i we iterate over all the other particles j in the system and calculate the distance, the computation time will increase quadratically with the number of partciles in the system (:math:`O(N^2)`). Even if we take into account Newtons third law, this will decrease the number of computations (:math:`O(\\frac{1}{2}N(N-1))`), but the computational complexity still is quadratic in N. </span>
<span class="sd">    A straight forward method to significantly improve the situation is the linked cell list approach :cite:p:`Allen2017` (pp.195: 5.3.2 Cell structures and linked lists) where the simulation box is divided into :math:`n \\times n \\times n` cells. The number of cells must be chosen such that the side length of the cells in each dimension :math:`s = L/n`, where :math:`L` is the simulation box length, is greater than the maximum cutoff radius for the pairwise molecular interactions (and in our case also bimolecular reactions). This will decrease the computational complexity to :math:`O(14 N \\rho s^3 )`, where :math:`\\rho` is the molecule density (assuming a mostly homogeneous distribution of molecules). Thereby, the computation time increase rather linear with :math:`N` instead of quadratically (:math:`N^2`).</span>
<span class="sd">    </span>
<span class="sd">    However, one problem with this method is that it does not efficiently handle polydisperse particle size distributions. This becomes a problem when doing minimal coarse graining of proteins and other structures we find in the cell such as vesicles. As mentioned above, n should be chosen such that the cell length is greater than teh maximum cutoff radius. If we would like to simulate, e.g. proteins (:math:`r \\approx 2-5 nm`) in the presence of synaptic vesicles (:math:`r \\approx 20-30 nm`), the cells become way larger than necessary from the perspective of the small proteins. </span>
<span class="sd">    </span>
<span class="sd">    One way to approach this problem would be, to choose a small cell size (e.g. based on the samllest cutoff radius) and just iterate not just over the nearest neighbour cells but over as many cells such that the cutoff radius of the larger proteins/SVs is covered. This approach has has a big disadvantages: Whereas for the smaller partciles we actually reduce the number of unnecessary distance calculations, for the larger particles we don&#39;t. We can, however, still take advantage of Newton&#39;s 3rd law. For this, we only do the distance calculation if the radius of particle i is larger than the radius of particle j. If the radii are equal, we only do the calculation if index i is smaller than index j.</span>
<span class="sd">    </span>
<span class="sd">    A much better approach has been introduced by :cite:t:`Ogarko2012` and makes use of a so called hierarchical grid. This approach is the one we use in PyRID. In the hierarchical grid approach, each particle is assigned to a different cell grid depending on its cutoff radius, i.e. the grid consists of different levels or hierarchies, each having a different cell size. This has the downside of taking up more memory, howewer, it drastically reduces the number of distance calculations we need to do for the larger particles and also takes advantage of Newtons third law, enabling polydisiperse system simulations with almost no performance loss. The algorithm for the distance checks works as follows:</span>
<span class="sd">        </span>
<span class="sd">        1. Iterate over all particles</span>
<span class="sd">        2. Assign each particle to a cell on their respective level in the hierarchical grid</span>
<span class="sd">        3. Iterate over all particles once more</span>
<span class="sd">        4. Do a distance check for the nearest neigbour cells on the level the current particle sites in. This is done using the classical linekd cell list algorithm.</span>
<span class="sd">        5. Afterwards, do a cross-level search. For this, distance checks are only done on lower hierarchy levels, i.e. on levels with smaller partcile sizes than the current one. This way, we do not need to double check the same particle pair (3rd law). However, in this step, we will have to iterate over potentialy many empty cells (Note: this should, in principle, also be doable in a more efficient way).</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">    *Mesh collision response*</span>
<span class="sd">    </span>
<span class="sd">    The distance between particle and mesh triangles is calculated and based on the distance a repulsive force is determined. </span>
<span class="sd">    The repulsive force is normalized by the total number of triangle collisions. This approach is not exact but works sufficiently well.</span>
<span class="sd">    Particle vertex collisions are neglected if one or more particle face collisions have been detected.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">Unbind</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar_Wall</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span>    
    <span class="n">System</span><span class="o">.</span><span class="n">virial_tensor</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">System</span><span class="o">.</span><span class="n">virial_tensor_Wall</span><span class="p">[:,:,:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    
    <span class="n">pos_tri</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    
    <span class="n">virial_tensor</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">virial_tensor</span>

    <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span>
    <span class="n">empty</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">empty</span>
    <span class="n">x_c_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
    <span class="n">x_c_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
    
    <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1">#Potential Energy</span>
    
    
    <span class="n">pos_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>  <span class="c1"># position shift to account for periodic boundary conditions.</span>
    <span class="n">dF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">dim</span><span class="p">)</span>
    
    <span class="c1"># Initialize</span>
    <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>

    <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">empty</span><span class="p">)</span>
    

    <span class="c1"># Loop over all particles and place them in cells, calculate bond forces and update reaction list.</span>
    <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span>
        
        <span class="n">ptype_idx_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>  
        <span class="n">pos_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        
        <span class="n">mol_idx_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;rb_id&#39;</span><span class="p">]</span>
        <span class="n">mtype_idx_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
        <span class="n">mpos_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
        
        <span class="n">within_box</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Check if particle is within box volume:</span>
            <span class="n">within_box</span> <span class="o">=</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">&lt;=</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">&lt;</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">&lt;=</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&lt;</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="o">&lt;=</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&lt;</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
            
        <span class="c1">#Only add the particle to the linked cell list if there is actually any pair-interaction or bimol-reaction defined for this partricle type:</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">]:</span>
        
            <span class="n">h</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="n">h_start</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head_start&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span>
            <span class="n">cells_per_dim_prim</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span>
            
            <span class="c1"># Determine what cell, in each direction, the i-th particle is in</span>
            <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="c1"># within_box = True</span>
            
            <span class="c1"># if System.boundary_condition_id == 1:</span>
            <span class="c1">#     # Check if particle is within box volume:</span>
            <span class="c1">#     within_box = 0&lt;=cx&lt;cells_per_dim_prim[0] and 0&lt;=cy&lt;cells_per_dim_prim[1] and 0&lt;=cz&lt;cells_per_dim_prim[2]</span>
            
            <span class="k">if</span> <span class="n">within_box</span><span class="p">:</span>
                
                <span class="n">c</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">cy</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cz</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="c1"># List of particle indices occupying a given cell</span>
                <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">h_start</span><span class="o">+</span><span class="n">c</span><span class="p">]</span>
        
                <span class="c1"># The last particle found to lie in cell c (head particle)</span>
                <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">h_start</span><span class="o">+</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        
        <span class="c1">#%%</span>
        
        <span class="c1"># Append any unimolecular reaction that is due to the reactions list:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;next_transition&#39;</span><span class="p">]</span><span class="o">&lt;=</span><span class="n">System</span><span class="o">.</span><span class="n">current_step</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">:</span>
                
                <span class="n">reaction_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">up_reaction_id</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">]</span>
                
                <span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                
        <span class="c1">#%%</span>

        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;collision_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">type_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">particle_id_to_name</span><span class="p">[</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]])</span>
            <span class="n">radius</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">type_name</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
                    
            <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                
                <span class="n">sign</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="n">dim</span><span class="p">])</span>
                <span class="n">r</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">-</span><span class="n">sign</span><span class="o">*</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">radius</span><span class="p">:</span>
                    
                    <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">-</span><span class="n">sign</span><span class="o">*</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">wall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">wall_force</span><span class="p">)</span>                            
                    
                    <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                    <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                    
                    <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="n">dim</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span>
                    
                    <span class="n">dx_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span> <span class="o">-</span> <span class="n">sign</span><span class="o">*</span><span class="n">box_lengths</span><span class="p">[</span><span class="n">dim</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span>
                    
                    <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar_Wall</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">fr</span><span class="o">*</span><span class="n">dx_mol</span>
                    
                    
                    
        <span class="n">j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound_with&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">j</span><span class="p">:</span>
                       
            <span class="n">mol_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;rb_id&#39;</span><span class="p">]</span>
            <span class="n">ptype_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
            <span class="n">pos_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            
            <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">dx</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dx</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">dx</span> <span class="o">&gt;=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">dy</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dy</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">dy</span> <span class="o">&gt;=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="n">dz</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">dz</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">dz</span> <span class="o">&gt;=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                
                <span class="n">mtype_idx_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                <span class="n">mpos_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                    
                <span class="n">dx_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dz_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">dx_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dx_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">dx_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dx_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">dy_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dy_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">dy_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dy_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    
                    <span class="k">if</span> <span class="n">dz_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dz_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    <span class="k">elif</span> <span class="n">dz_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                        <span class="n">dz_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                
                                
                
                <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">execute_force</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>
                
                <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>

                <span class="c1"># Update force for the i-th particle:</span>
                    
                <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> 
                <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> 
                <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span>
                
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="c1"># Newton&#39;s 3rd law:</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            
            <span class="c1"># if the bond is a breakable bond:</span>
            <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;breakable&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="n">Unbind</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">])</span>
                

<span class="c1">#%%</span>
    
        <span class="c1"># Interaction between particle and mesh faces. Need to check several conditions:</span>
            <span class="c1"># 1. Is the particle inside the box volume</span>
            <span class="c1"># 2. Is the particle part of a volume molecule</span>
            <span class="c1"># 3. Is the particle radius &gt; 0</span>
            <span class="c1"># 4. Is the collision type of the particle == 0. (For particles of radius 0, this should never be the case:</span>
            <span class="c1"># TODO: Add a test at the start of each simualtion and set the collision type of all radius = 0 particles to 1. This would save us from testing 3.)!</span>
            
        <span class="k">if</span> <span class="n">within_box</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">mesh</span> <span class="ow">and</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;loc_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;collision_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            
            <span class="n">radius</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
            <span class="n">face_intersection_count</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">r_edge</span> <span class="o">=</span> <span class="mf">1e10</span>
            <span class="n">pp_edge</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">face_sign</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">face_sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                
            <span class="c1"># face_intersection = False</span>
            
            <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            
            <span class="n">System</span><span class="o">.</span><span class="n">time_stamp</span> <span class="o">+=</span> <span class="mi">1</span>
                
            <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="n">dcx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
            <span class="n">dcy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">dcz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">((</span><span class="mi">2</span><span class="o">*</span><span class="n">radius</span><span class="p">)</span><span class="o">/</span><span class="n">System</span><span class="o">.</span><span class="n">cell_length_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
            
            <span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cz</span> <span class="o">-</span> <span class="n">dcz</span><span class="p">,</span> <span class="n">cz</span> <span class="o">+</span> <span class="n">dcz</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="n">dcy</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="n">dcy</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="n">dcx</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="n">dcx</span> <span class="o">+</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                
                <span class="k">if</span> <span class="n">cz_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cz_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cz_end</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">cz_end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">cy_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cy_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cy_end</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">cy_end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">cx_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cx_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cx_end</span> <span class="o">&gt;</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cx_end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>            
            
            
            <span class="k">for</span> <span class="n">cz_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span><span class="p">):</span>
                <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    
                <span class="k">for</span> <span class="n">cy_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span><span class="p">):</span>
                    <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
                    <span class="k">for</span> <span class="n">cx_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span><span class="p">):</span>
                        <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
                        <span class="c1"># Compute the location of the N-th cell:</span>
                        <span class="n">c_N</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">+</span> <span class="n">cx_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">+</span> <span class="n">cy_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                              <span class="o">+</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">+</span> <span class="n">cz_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                        
            
                        <span class="n">head</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">CellList</span><span class="o">.</span><span class="n">head</span><span class="p">[</span><span class="n">c_N</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">head</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>

                            <span class="n">Tri_idx</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">CellList</span><span class="p">[</span><span class="n">head</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                            
                            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">System</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">:</span>
                                <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">time_stamp</span>
                                
                                <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
                                
                                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                    <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                    <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                    
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                    <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                    <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                        
                                <span class="n">r</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">point_triangle_distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">pos_i</span><span class="p">,</span> <span class="n">pos_tri</span><span class="p">)</span>
                                
                                <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="c1"># face_intersection = True</span>

                                    <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
                                        
                                        <span class="n">normal</span> <span class="o">=</span> <span class="n">face_sign</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                        
                                        <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                        
                                        <span class="n">face_intersection_count</span><span class="o">+=</span><span class="mi">1</span>
                                        
                                        <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">wall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">wall_force</span><span class="p">)</span>                            
                                        
                                        <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                                        <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                    
                                        <span class="c1"># Update the force for particle i</span>
                                        <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                        <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
                                        <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                        
                                        
                                <span class="k">else</span><span class="p">:</span>
                                    
                                    <span class="k">if</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">r_edge</span><span class="p">:</span>
                                        <span class="n">r_edge</span> <span class="o">=</span> <span class="n">r</span>
                                        <span class="n">pp_edge</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pos_tri</span>
                                
                            <span class="nb">next</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">CellList</span><span class="p">[</span><span class="n">head</span><span class="p">][</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
                                    
                            <span class="k">while</span> <span class="nb">next</span><span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                                
                                
                                <span class="n">Tri_idx</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">CellList</span><span class="p">[</span><span class="nb">next</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                                
                                <span class="c1"># Only continue if this triangle has not yet been checked for collision!</span>
                                <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">System</span><span class="o">.</span><span class="n">time_stamp</span><span class="p">:</span>
                                    <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;stamp&#39;</span><span class="p">]</span><span class="o">=</span><span class="n">System</span><span class="o">.</span><span class="n">time_stamp</span>
                                    
                                    <span class="n">triangle</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangles&#39;</span><span class="p">]</span>
                                    
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                        <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                        <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span> <span class="o">+</span> <span class="n">pos_shift</span>
                                        
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">p0</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                                        <span class="n">p1</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                                        <span class="n">p2</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">vertices</span><span class="p">[</span><span class="n">triangle</span><span class="p">[</span><span class="mi">2</span><span class="p">]]</span>
                            
                                    <span class="n">r</span><span class="p">,</span> <span class="n">region</span> <span class="o">=</span> <span class="n">point_triangle_distance</span><span class="p">(</span><span class="n">p0</span><span class="p">,</span><span class="n">p1</span><span class="p">,</span><span class="n">p2</span><span class="p">,</span><span class="n">pos_i</span><span class="p">,</span> <span class="n">pos_tri</span><span class="p">)</span>
                                    
                                    <span class="k">if</span> <span class="n">region</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="c1"># face_intersection = True</span>
                                        
                                        <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
                                            
                                            <span class="n">normal</span> <span class="o">=</span> <span class="n">face_sign</span><span class="o">*</span><span class="n">System</span><span class="o">.</span><span class="n">Mesh</span><span class="p">[</span><span class="n">Tri_idx</span><span class="p">][</span><span class="s1">&#39;triangle_coord&#39;</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span>
                                            
                                            <span class="n">dx</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                            <span class="n">dy</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                            <span class="n">dz</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pos_tri</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            
                                            <span class="n">face_intersection_count</span><span class="o">+=</span><span class="mi">1</span>
                                            
                                            <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">wall</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">wall_force</span><span class="p">)</span>                            
                                            
                                            <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                                            <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                        
                                            <span class="c1"># Update the force for particle i</span>
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span> <span class="o">*</span> <span class="n">normal</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            
                                            
                                    <span class="k">else</span><span class="p">:</span>
                                        
                                        <span class="k">if</span> <span class="n">r</span><span class="o">&lt;</span><span class="n">r_edge</span><span class="p">:</span>
                                            <span class="n">r_edge</span> <span class="o">=</span> <span class="n">r</span>
                                            <span class="n">pp_edge</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pos_tri</span>
                    
                                <span class="nb">next</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">CellList</span><span class="p">[</span><span class="nb">next</span><span class="p">][</span><span class="s1">&#39;next&#39;</span><span class="p">]</span>
         
        
            <span class="k">if</span> <span class="n">face_intersection_count</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">face_intersection_count</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">face_intersection_count</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">face_intersection_count</span>
            <span class="k">elif</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r_edge</span> <span class="o">&lt;</span> <span class="n">radius</span><span class="p">:</span>
                
                <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pp_edge</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">pp_edge</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">pp_edge</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="n">face_intersection_count</span><span class="o">+=</span><span class="mi">1</span>
                
                <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">wall</span><span class="p">(</span><span class="n">r_edge</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">wall_force</span><span class="p">)</span>                            
                
                <span class="n">fr</span> <span class="o">/=</span> <span class="n">r_edge</span>
                <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>

                <span class="c1"># Update the force for particle i</span>
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> 
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> 
                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span>  
                
            <span class="c1"># if count&gt;1:</span>
            <span class="c1">#     print(&#39;triangle contacts: &#39;, count, i, System.current_step)</span>
            
<span class="c1">#%%</span>
                
    
    <span class="c1"># Loop over all Particles</span>
    <span class="k">for</span> <span class="n">i0</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="o">.</span><span class="n">n</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="n">Particles</span><span class="o">.</span><span class="n">occupied</span><span class="p">[</span><span class="n">i0</span><span class="p">]</span> 
        
        <span class="n">ptype_idx_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>  
        <span class="c1">#Only continue if there is actually any pair-interaction or bimol-reaction defined for this partricle type:</span>
        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">pair_interaction</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">]:</span>
        
            <span class="n">mol_idx_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;rb_id&#39;</span><span class="p">]</span>
            <span class="n">mtype_idx_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
            <span class="n">mpos_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            <span class="n">comp_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;compartment&#39;</span><span class="p">]</span>
            <span class="n">loc_type_i</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_i</span><span class="p">][</span><span class="s1">&#39;loc_id&#39;</span><span class="p">]</span>
            
            <span class="n">pos_i</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
            
            <span class="n">h</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;h&#39;</span><span class="p">]</span>
            <span class="n">h_start</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head_start&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span>
            <span class="n">cells_per_dim_prim</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">]</span>
            
            <span class="n">cx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">cy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">cz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">h</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
            
            <span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cz</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cy</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cy</span> <span class="o">+</span> <span class="mi">2</span>
            <span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cx</span> <span class="o">+</span> <span class="mi">2</span>
            
            <span class="n">within_box</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># Check if particle is within box volume:</span>
                <span class="n">within_box</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">cx</span><span class="o">&lt;</span><span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">cy</span><span class="o">&lt;</span><span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">and</span> <span class="mi">0</span><span class="o">&lt;=</span><span class="n">cz</span><span class="o">&lt;</span><span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">cz_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cz_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cz_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                    <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">cy_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cy_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cy_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                    <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    
                <span class="k">if</span> <span class="n">cx_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">cx_start</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="k">elif</span> <span class="n">cx_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">within_box</span><span class="p">:</span>
                <span class="c1"># Check contacts on same hierarchy level:</span>
                <span class="k">for</span> <span class="n">cz_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span><span class="p">):</span>
                    <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
                    <span class="k">for</span> <span class="n">cy_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span><span class="p">):</span>
                        <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
                        <span class="k">for</span> <span class="n">cx_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span><span class="p">):</span>
                            <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                            <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
                            <span class="c1"># Compute the location of the N-th cell based on shifts</span>
                            <span class="n">c_N</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">+</span> <span class="n">cx_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">+</span> <span class="n">cy_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                                  <span class="o">+</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">+</span> <span class="n">cz_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim_prim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                  
                          
                            <span class="c1"># Check neighboring head particle interactions</span>
                            <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">h_start</span><span class="o">+</span><span class="n">c_N</span><span class="p">]</span>
                    
                            <span class="k">while</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">empty</span><span class="p">:</span>
                                
                                <span class="n">mol_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;rb_id&#39;</span><span class="p">]</span>
                                <span class="n">ptype_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                                <span class="n">pos_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                
                                
                                <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">j</span> <span class="ow">and</span> <span class="n">mol_idx_i</span><span class="o">!=</span><span class="n">mol_idx_j</span> <span class="ow">and</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound_with&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">j</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">]:</span>
                                    
                                    <span class="c1"># We only allow interactions and reactions between volume molecules of the same compartment:</span>
                                    <span class="n">interaction_allowed</span><span class="p">,</span> <span class="n">reactions_allowed</span> <span class="o">=</span> <span class="n">react_interact_test</span><span class="p">(</span><span class="n">comp_i</span><span class="p">,</span> <span class="n">loc_type_i</span><span class="p">,</span> <span class="n">mol_idx_j</span><span class="p">,</span> <span class="n">mol_idx_i</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
                                    <span class="c1"># If neither reactions nor interactions are allow, we can go to the next particle and continue (if interaction_allowes == False, reactions_allowe dis always also False):</span>
                                    <span class="k">if</span> <span class="n">interaction_allowed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                        <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                        <span class="k">continue</span>
                                        
                                    <span class="n">System</span><span class="o">.</span><span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                                    
                                    <span class="c1"># Compute the difference in positions for the i-th and j-th particles</span>
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                            
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                        <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                        <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        
                                    <span class="c1"># Compute distance between particles i and j</span>
                                    <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                                    
        
                                    <span class="c1">#Binding Reactions:</span>
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]:</span>
                                            
                                                <span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">+=</span> <span class="mi">1</span>
                                                
                                                <span class="n">reaction_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
        
                                                <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                                
                                    <span class="c1"># Biparticle reactions (Particle pairs can either take part in a bindin reaction xor in </span>
                                    <span class="c1"># in a biparticle reaction:</span>
                                    <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">reactions_allowed</span><span class="p">:</span>
                                        <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]:</span>
                                            
                                            <span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">+=</span> <span class="mi">1</span>
                                            <span class="n">reaction_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                                            <span class="c1"># Which is the enzyme molecule (inserted second)?</span>
                                            <span class="n">enzyme_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">ptype_idx_j</span> <span class="o">==</span> <span class="n">enzyme_id</span><span class="p">:</span>
                                                <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
        
                                            
                                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;global&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> <span class="c1"># TODO: Is this condition check actually necessary (we do not coninue until here for bound particle pairs anyway!)?</span>
                                        <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
                                            
                                            <span class="n">mtype_idx_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                                            <span class="n">mpos_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                            
        
                                            <span class="n">dx_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">dx_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dx_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="k">elif</span> <span class="n">dx_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dx_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            
                                            <span class="n">dy_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">dy_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dy_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="k">elif</span> <span class="n">dy_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dy_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                
                                            <span class="n">dz_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="k">if</span> <span class="n">dz_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dz_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="k">elif</span> <span class="n">dz_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                <span class="n">dz_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                
                            
        
                                            <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">execute_force</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>
                                            
                                            <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                                            <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                                            <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
        
                                            <span class="c1"># Update force of the i-th particle</span>
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> 
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> 
                                            <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span>
                                            
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            
                                            <span class="c1"># Newton&#39;s 3rd law</span>
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            
                                            <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                                            <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                                            
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                            
                                <span class="c1"># Move down list (ls) of particles for cell interactions with a head particle</span>
                                <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
        
                <span class="c1">#-----------------------------------------------------------</span>
        
                <span class="n">hj</span> <span class="o">=</span> <span class="n">h</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">while</span> <span class="n">hj</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                    
                    <span class="n">cells_per_dim_sec</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cells_per_dim&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">]</span>
                    
                    <span class="n">h_start</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head_start&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">]</span>
                    
                    <span class="n">x_c_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">x_c_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">x_c_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
                    <span class="n">cx_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_min</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">cy_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_min</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">cz_start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_min</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span>
                    
                    
                    <span class="n">x_c_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">x_c_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                    <span class="n">x_c_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            
                    <span class="n">cx_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_max</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">cy_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_max</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                    <span class="n">cz_end</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x_c_max</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">+</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sh&#39;</span><span class="p">][</span><span class="n">hj</span><span class="p">][</span><span class="mi">2</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                        
                        <span class="k">if</span> <span class="n">cz_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cz_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cz_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span>
                            <span class="n">cz_end</span> <span class="o">=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                            
                        <span class="k">if</span> <span class="n">cy_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cy_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cy_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="n">cy_end</span> <span class="o">=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                            
                        <span class="k">if</span> <span class="n">cx_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">cx_start</span> <span class="o">=</span> <span class="mi">0</span> 
                        <span class="k">elif</span> <span class="n">cx_end</span> <span class="o">&gt;</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">cx_end</span> <span class="o">=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            
        
                    <span class="k">for</span> <span class="n">cz_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cz_start</span><span class="p">,</span> <span class="n">cz_end</span><span class="p">):</span>
                        <span class="n">cz_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cz_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">cy_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cy_start</span><span class="p">,</span> <span class="n">cy_end</span><span class="p">):</span>
                            <span class="n">cy_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cy_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">cx_N</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cx_start</span><span class="p">,</span> <span class="n">cx_end</span><span class="p">):</span>
                                <span class="n">cx_shift</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">-</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">cx_N</span> <span class="o">&gt;=</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                
                                <span class="n">c_N</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx_N</span> <span class="o">+</span> <span class="n">cx_shift</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">cy_N</span> <span class="o">+</span> <span class="n">cy_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> \
                                      <span class="o">+</span> <span class="p">(</span><span class="n">cz_N</span> <span class="o">+</span> <span class="n">cz_shift</span><span class="p">)</span> <span class="o">*</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">cells_per_dim_sec</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                      
                                
                                <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;head&#39;</span><span class="p">][</span><span class="n">h_start</span><span class="o">+</span><span class="n">c_N</span><span class="p">]</span>
                                
                                <span class="k">while</span> <span class="n">j</span> <span class="o">!=</span> <span class="n">empty</span><span class="p">:</span>
                                    
                                    <span class="n">mol_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;rb_id&#39;</span><span class="p">]</span>
                                    <span class="n">ptype_idx_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                                    <span class="n">pos_j</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                            
                                            
                                    <span class="k">if</span> <span class="n">mol_idx_i</span><span class="o">!=</span><span class="n">mol_idx_j</span> <span class="ow">and</span> <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound_with&#39;</span><span class="p">]</span><span class="o">!=</span><span class="n">j</span> <span class="ow">and</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_defined</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">]:</span>
                                        
                                        <span class="n">interaction_allowed</span><span class="p">,</span> <span class="n">reactions_allowed</span> <span class="o">=</span> <span class="n">react_interact_test</span><span class="p">(</span><span class="n">comp_i</span><span class="p">,</span> <span class="n">loc_type_i</span><span class="p">,</span> <span class="n">mol_idx_j</span><span class="p">,</span> <span class="n">mol_idx_i</span><span class="p">,</span> <span class="n">RBs</span><span class="p">,</span> <span class="n">System</span><span class="p">)</span>
                                        <span class="c1"># If neither reactions nor interactions are allow, we can go to the next particle and continue (if interaction_allowes == False, reactions_allowe dis always also False):</span>
                                        <span class="k">if</span> <span class="n">interaction_allowed</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
                                            <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                                            <span class="k">continue</span>
                                        
                                        <span class="n">System</span><span class="o">.</span><span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
                                        
                                        <span class="c1"># Compute the difference in positions for the i-th and j-th particles</span>
                                        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                                            <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                            <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                            <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">pos_shift</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                                                
                                        <span class="k">else</span><span class="p">:</span>
                                            <span class="n">dx</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                            <span class="n">dy</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                                            <span class="n">dz</span> <span class="o">=</span> <span class="n">pos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">pos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
            
                                        <span class="c1"># Compute distance between particles i and j</span>
                                        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dx</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dy</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">dz</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
                                        
            
                                        <span class="c1">#Binding Reactions:</span>
                                        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;bond&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">):</span>
                                                <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]:</span>
                                                
                                                    <span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">+=</span> <span class="mi">1</span>
                                                    
                                                    <span class="n">reaction_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
            
                                                    <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                                    
                                        <span class="c1"># Biparticle reactions (Particle pairs can either take part in a bindin reaction xor in </span>
                                        <span class="c1"># in a biparticle reaction:</span>
                                        <span class="k">elif</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;defined&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">reactions_allowed</span><span class="p">:</span>
                                            <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]:</span>
                                                
                                                <span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">+=</span> <span class="mi">1</span>
                                                <span class="n">reaction_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">]</span>
                                                <span class="c1"># Which is the enzyme molecule (inserted second)?</span>
                                                <span class="n">enzyme_id</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">reaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;enzyme&#39;</span><span class="p">]</span>
                                                <span class="k">if</span> <span class="n">ptype_idx_j</span> <span class="o">==</span> <span class="n">enzyme_id</span><span class="p">:</span>
                                                    <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">)</span>
                                                <span class="k">else</span><span class="p">:</span>
                                                    <span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_id</span><span class="p">]</span><span class="o">.</span><span class="n">append_reaction</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">)</span>
                                                    
                                                
                                        <span class="k">if</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;global&#39;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                                            
                                            <span class="k">if</span> <span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">r</span> <span class="o">&lt;</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;cutoff&#39;</span><span class="p">]:</span>
        
                                                <span class="n">mtype_idx_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]</span>
                                                <span class="n">mpos_j</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">[</span><span class="n">mol_idx_j</span><span class="p">][</span><span class="s1">&#39;pos&#39;</span><span class="p">]</span>
                                                
                                                <span class="n">dx_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="k">if</span> <span class="n">dx_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dx_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="k">elif</span> <span class="n">dx_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dx_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                
                                                <span class="n">dy_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="k">if</span> <span class="n">dy_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dy_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="k">elif</span> <span class="n">dy_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dy_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                    
                                                <span class="n">dz_mol</span> <span class="o">=</span> <span class="n">mpos_i</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">mpos_j</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="k">if</span> <span class="n">dz_mol</span><span class="o">&lt;=-</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dz_mol</span> <span class="o">+=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="k">elif</span> <span class="n">dz_mol</span><span class="o">&gt;=</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span>
                                                    <span class="n">dz_mol</span> <span class="o">-=</span> <span class="n">box_lengths</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>                
                            
        
                                                <span class="n">pot</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="n">potu</span><span class="o">.</span><span class="n">execute_force</span><span class="p">(</span><span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">r</span><span class="p">,</span> <span class="n">System</span><span class="o">.</span><span class="n">interaction_args</span><span class="p">[</span><span class="n">ptype_idx_i</span><span class="p">][</span><span class="n">ptype_idx_j</span><span class="p">][</span><span class="s1">&#39;parameters&#39;</span><span class="p">])</span>
                                                
                                                <span class="n">fr</span> <span class="o">/=</span> <span class="n">r</span>
                                                <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
                                                <span class="n">System</span><span class="o">.</span><span class="n">Epot</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">pot</span>
            
                                                <span class="c1"># Update force for particle i</span>
                                                <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="n">fr</span> 
                                                <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="n">fr</span> 
                                                <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dz</span> <span class="o">*</span> <span class="n">fr</span>
                                                
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                
                                                <span class="c1"># Apply Newton&#39;s 3rd law</span>
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;force&#39;</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">-=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                
                                                <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                                                <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">dx_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">dy_mol</span><span class="o">+</span><span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">*</span><span class="n">dz_mol</span>
                                                
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_i</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dx_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dy_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                                                <span class="n">virial_tensor</span><span class="p">[</span><span class="n">mtype_idx_j</span><span class="p">][</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">dz_mol</span> <span class="o">*</span> <span class="n">dF</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                                    
                                            
                                <span class="c1"># Move down list (ls) of particles for cell interactions with a head particle</span>
                                    <span class="n">j</span> <span class="o">=</span> <span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">][</span><span class="n">j</span><span class="p">]</span>
                            
                    <span class="n">hj</span> <span class="o">-=</span> <span class="mi">1</span>


    <span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="o">*=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">System</span><span class="o">.</span><span class="n">virial_tensor</span><span class="o">*=</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span> <span class="ow">in</span> <span class="n">Unbind</span><span class="p">:</span>
        
        <span class="c1"># If the binding reaction changed the particle types, reverse that:</span>
        <span class="n">educt_type_i</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type&#39;</span><span class="p">])][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;bond_educt_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">educt_type_i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">convert_particle_type</span><span class="p">(</span><span class="n">System</span><span class="p">,</span> <span class="n">educt_type_i</span><span class="p">,</span> <span class="n">Particles</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="c1"># Note: if we convert particle type i, the binding partner j is automatically also converted back, this is already taken care of in convert_particle_type().</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bound&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;bound_with&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;bound_with&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">System</span><span class="o">.</span><span class="n">N_bonds</span><span class="p">[</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]][</span><span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="n">System</span><span class="o">.</span><span class="n">N_bonds</span><span class="p">[</span><span class="n">Particles</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]][</span><span class="n">Particles</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="s1">&#39;type_id&#39;</span><span class="p">]]</span> <span class="o">-=</span> <span class="mi">1</span></div>
        




</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>