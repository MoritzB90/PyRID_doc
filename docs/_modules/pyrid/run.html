<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>pyrid.run &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/my_theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> PyRID
            <img src="../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../Developers/Overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developers/Developer%20API/Contents.html">Developer API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developers/Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Developers/Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>pyrid.run</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for pyrid.run</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">@author: Moritz F P Becker</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">numba</span> <span class="k">as</span> <span class="nn">nb</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">sqrtm</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">h5py</span>

<span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">update_pos</span> <span class="k">as</span> <span class="n">upos</span>
<span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">update_force</span> <span class="k">as</span> <span class="n">uf</span>
<span class="kn">from</span> <span class="nn">.reactions</span> <span class="kn">import</span> <span class="n">update_reactions</span> <span class="k">as</span> <span class="n">uru</span>
<span class="kn">from</span> <span class="nn">.observables</span> <span class="kn">import</span> <span class="n">write_util</span> <span class="k">as</span> <span class="n">wru</span>
<span class="kn">from</span> <span class="nn">.data_structures</span> <span class="kn">import</span> <span class="n">h_grid_util</span> <span class="k">as</span> <span class="n">hu</span>
<span class="kn">from</span> <span class="nn">.observables</span> <span class="kn">import</span> <span class="n">checkpoint_util</span> <span class="k">as</span> <span class="n">cp</span>
<span class="kn">from</span> <span class="nn">.system.system_util</span> <span class="kn">import</span> <span class="n">System</span>
<span class="kn">from</span> <span class="nn">.molecules.particles_util</span> <span class="kn">import</span> <span class="n">Particles</span>
<span class="kn">from</span> <span class="nn">.molecules.rigidbody_util</span> <span class="kn">import</span> <span class="n">RBs</span>
<span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">distribute_vol_util</span> <span class="k">as</span> <span class="n">distribute_vol</span>
<span class="kn">from</span> <span class="nn">.system</span> <span class="kn">import</span> <span class="n">distribute_surface_util</span> <span class="k">as</span> <span class="n">distribute_surf</span>
<span class="kn">from</span> <span class="nn">.observables.checkpoint_util</span> <span class="kn">import</span> <span class="n">load_checkpoint</span>
<span class="kn">from</span> <span class="nn">.observables.observables_util</span> <span class="kn">import</span> <span class="n">Observables</span>
<span class="kn">from</span> <span class="nn">.math</span> <span class="kn">import</span> <span class="n">transform_util</span> <span class="k">as</span> <span class="n">trf</span>
<span class="kn">from</span> <span class="nn">.evaluation.rdf_util</span> <span class="kn">import</span> <span class="n">create_rb_hgrid</span><span class="p">,</span> <span class="n">update_rb_hgrid</span>
<span class="kn">from</span> <span class="nn">.reactions</span> <span class="kn">import</span> <span class="n">reactions_util</span> <span class="k">as</span> <span class="n">ru</span>

<span class="kn">import</span> <span class="nn">time</span>


<span class="k">def</span> <span class="nf">convert_dict</span><span class="p">(</span><span class="n">untyped_dict</span><span class="p">):</span>
    
    <span class="n">key_type</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">untyped_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">value_type</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typeof</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">untyped_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">typed_dict</span> <span class="o">=</span> <span class="n">nb</span><span class="o">.</span><span class="n">typed</span><span class="o">.</span><span class="n">Dict</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">key_type</span><span class="p">,</span> <span class="n">value_type</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">untyped_dict</span><span class="p">:</span>
        <span class="n">typed_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">untyped_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">typed_dict</span>


<div class="viewcode-block" id="random_quaternion"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.random_quaternion">[docs]</a><span class="nd">@nb</span><span class="o">.</span><span class="n">njit</span><span class="c1">#(cache=True)</span>
<span class="k">def</span> <span class="nf">random_quaternion</span><span class="p">():</span>
    
    <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameter_1 : dtype</span>
<span class="sd">        Some Information</span>
<span class="sd">    parameter_2 : dtype</span>
<span class="sd">        Some Information</span>
<span class="sd">    </span>
<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    NotImplementedError (just an example)</span>
<span class="sd">        Brief explanation of why/when this exception is raised</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dtype</span>
<span class="sd">        Some information</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># Based on K. Shoemake. Uniform random rotations. In D. Kirk, editor, Graphics Gems III, pages 124-132. Academic, New York, 1992. http://planning.cs.uiuc.edu/node198.html</span>
    
    <span class="n">u1</span><span class="p">,</span><span class="n">u2</span><span class="p">,</span><span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u2</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">u3</span><span class="p">)])</span></div>


<div class="viewcode-block" id="update_pressure"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.update_pressure">[docs]</a><span class="k">def</span> <span class="nf">update_pressure</span><span class="p">(</span><span class="n">Simulation</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;Calculates the pressure from the virial tensor.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    Simulation : `ob`</span>
<span class="sd">        Simulation instance</span>
<span class="sd">    </span>
<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">    When doing rigid body molecular dynamics or Brownian dynamics simulations, we need to be careful how to calculate the virial tensor. Taking the interparticle distances will result in the wrong pressure. Instead, one needs to use the pairwise distance between the centers of mass of the rigid bodies :cite:p:`Glaser2020` :</span>
<span class="sd">        </span>
<span class="sd">    .. math::</span>
<span class="sd">        :label: Pressure</span>
<span class="sd">        </span>
<span class="sd">        P_{mol} = P_{mol}^{kin} + \\frac{1}{6 V} \\sum_{i=1}^{N} \\sum_{j \\neq}^{N} \\langle \\boldsymbol{F}_{ij} \cdot (\\boldsymbol{R}_i - \\boldsymbol{R}_j) \\rangle,</span>
<span class="sd">        </span>
<span class="sd">    where :math:`V` is the total volume of the simulation box, :math:`\\boldsymbol{F}_{ij}` is the force on particle i exerted by particle j and :math:`\\boldsymbol{R}_{i}, \\boldsymbol{R}_{j}` are the center of mass of the rigid body molecules, not the center of particles i and j! In Brownian dynamics simulations, :math:`P_{mol}^{kin} = N_{mol} k_B T`, where :math:`N_{mol}` is the number of molecules. Also, the origin of molecules is represented by the center of diffusion around which the molecule rotates about, which is not the center of mass :cite:p:`Harvey1980`! The net frictional force and troque act thorugh the center of diffusion. This is because when doing Brownian dynamics (and equaly for Langevin dynamics), we do account for the surrounding fluid. Different parts of the molecule will therefore interact with each other via hydrodynamic interactions/coupling. As a result, the center of the molecule (around which the molecule rotates in response to external forces) is not the same as the center of mass, which assumes no such interactions (the molecule sites in empry space). However, for symmetric molecules, the center of mass and the center of diffusion are the same!</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    tuple(float, float64[3,3])</span>
<span class="sd">        Total pressure and pressure tensor.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">mol_name</span> <span class="ow">in</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
        <span class="n">mol_id</span> <span class="o">=</span> <span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span><span class="o">.</span><span class="n">type_id</span>
        <span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Pressure</span><span class="p">[</span><span class="n">mol_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Nmol</span><span class="p">[</span><span class="n">mol_id</span><span class="p">]</span><span class="o">*</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span><span class="o">+</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">virial_scalar</span><span class="p">[</span><span class="n">mol_id</span><span class="p">]</span><span class="o">+</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">virial_scalar_Wall</span><span class="p">[</span><span class="n">mol_id</span><span class="p">])</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span><span class="o">/</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span>
        
    <span class="n">Pressure_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Pressure</span><span class="p">)</span>
    <span class="n">Pressure_Tensor</span> <span class="o">=</span> <span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N</span><span class="o">*</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">virial_tensor</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span><span class="o">/</span><span class="n">Simulation</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span>
                
    <span class="k">return</span> <span class="n">Pressure_total</span><span class="p">,</span> <span class="n">Pressure_Tensor</span></div>

<span class="c1">#%%</span>

<div class="viewcode-block" id="Simulation"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation">[docs]</a><span class="k">class</span> <span class="nc">Simulation</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A brief summary of the classes purpose and behavior</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    attribute_1 : dtype</span>
<span class="sd">        Some Information</span>
<span class="sd">    attribute_2 : dtype</span>
<span class="sd">        Some Information</span>
<span class="sd">    </span>
<span class="sd">    Methods</span>
<span class="sd">    -------</span>
<span class="sd">    method_1(arguments)</span>
<span class="sd">        Some general information about this method</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">,</span><span class="mf">50.0</span><span class="p">]),</span> <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="mf">293.15</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="mf">1e-21</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">write_trajectory</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">file_path</span> <span class="o">=</span> <span class="s1">&#39;Files//&#39;</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="s1">&#39;PyRID&#39;</span><span class="p">,</span> <span class="n">fig_path</span> <span class="o">=</span> <span class="s1">&#39;Figures//&#39;</span><span class="p">,</span> <span class="n">boundary_condition</span> <span class="o">=</span> <span class="s1">&#39;periodic&#39;</span><span class="p">,</span> <span class="n">nsteps</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">sim_time</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">wall_force</span> <span class="o">=</span> <span class="mf">100.0</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">length_unit</span> <span class="o">=</span> <span class="s1">&#39;nanometer&#39;</span><span class="p">,</span> <span class="n">time_unit</span> <span class="o">=</span> <span class="s1">&#39;ns&#39;</span><span class="p">,</span> <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">max_cells_per_dim</span> <span class="o">=</span> <span class="mi">50</span><span class="p">)</span> <span class="p">:</span>
                      
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="c1"># directory already exists</span>
            <span class="k">pass</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fig_path</span><span class="p">)</span> 
        <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
            <span class="c1"># directory already exists</span>
            <span class="k">pass</span>
            
        <span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">precision</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">finfo</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span><span class="o">.</span><span class="n">precision</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">box_lengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">box_lengths</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span> <span class="o">=</span> <span class="n">System</span><span class="p">(</span><span class="n">box_lengths</span> <span class="o">=</span> <span class="n">box_lengths</span><span class="p">,</span> <span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span><span class="p">,</span> <span class="n">Temp</span> <span class="o">=</span> <span class="n">Temp</span><span class="p">,</span> <span class="n">eta</span> <span class="o">=</span> <span class="n">eta</span><span class="p">,</span> <span class="n">boundary_condition</span> <span class="o">=</span> <span class="n">boundary_condition</span><span class="p">,</span> <span class="n">seed</span> <span class="o">=</span> <span class="n">seed</span><span class="p">,</span> <span class="n">wall_force</span> <span class="o">=</span> <span class="n">wall_force</span><span class="p">,</span> <span class="n">length_unit</span> <span class="o">=</span> <span class="n">length_unit</span><span class="p">,</span> <span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_unit</span><span class="p">,</span> <span class="n">cells_per_dim</span> <span class="o">=</span> <span class="n">cells_per_dim</span><span class="p">,</span> <span class="n">max_cells_per_dim</span> <span class="o">=</span> <span class="n">max_cells_per_dim</span><span class="p">)</span><span class="c1">#&#39;repulsive&#39;,  wall_force = 1e7</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span> <span class="o">=</span> <span class="n">Particles</span><span class="p">()</span> <span class="c1"># particle_array()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span> <span class="o">=</span> <span class="n">RBs</span><span class="p">()</span>
        
        <span class="c1"># self.Observables = {}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">file_path</span> <span class="o">=</span> <span class="n">file_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fig_path</span> <span class="o">=</span> <span class="n">fig_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write_trajectory</span> <span class="o">=</span> <span class="n">write_trajectory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stride</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">release_events</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">nsteps</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="n">nsteps</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="o">=</span> <span class="mf">1e10</span>
        <span class="k">if</span> <span class="n">sim_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="n">sim_time</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span> <span class="o">=</span> <span class="mf">1e10</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Measures</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">,</span> <span class="s1">&#39;Energy&#39;</span><span class="p">,</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Virial&#39;</span><span class="p">,</span> <span class="s1">&#39;Virial Tensor&#39;</span><span class="p">,</span> <span class="s1">&#39;Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;Bonds&#39;</span><span class="p">,</span> <span class="s1">&#39;Reactions&#39;</span><span class="p">,</span> <span class="s1">&#39;Force&#39;</span><span class="p">,</span> <span class="s1">&#39;Torque&#39;</span><span class="p">,</span> <span class="s1">&#39;RDF&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;micrometer&#39;</span><span class="p">:</span><span class="s1">&#39;\mu m&#39;</span><span class="p">,</span> <span class="s1">&#39;nanometer&#39;</span><span class="p">:</span><span class="s1">&#39;nm&#39;</span><span class="p">}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">time_unit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Energy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac</span><span class="si">{kJ}{mol}</span><span class="s1">$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$</span><span class="si">{}</span><span class="s1">^3$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Force&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac{{kJ}}{{mol \cdot </span><span class="si">{}</span><span class="s1">}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Torque&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac</span><span class="si">{kJ}{mol}</span><span class="s1">$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Virial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac</span><span class="si">{kJ}{mol}</span><span class="s1">$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Virial Tensor&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac</span><span class="si">{kJ}{mol}</span><span class="s1">$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Pressure&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\frac{{kJ}}{{mol \cdot </span><span class="si">{}</span><span class="s1">^3}}$&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length_units</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Reactions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;#&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Bonds&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;#&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;#&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">units</span><span class="p">[</span><span class="s1">&#39;Orientation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;°&#39;</span>

            
        <span class="bp">self</span><span class="o">.</span><span class="n">time_unit</span> <span class="o">=</span> <span class="n">time_unit</span>
        
        <span class="n">item_t_checkpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="s1">&#39;U40&#39;</span><span class="p">),(</span><span class="s1">&#39;max_saves&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),(</span><span class="s1">&#39;stride&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_checkpoint</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stride&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        
    <span class="k">def</span> <span class="nf">print_timer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">t_total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">key</span><span class="o">+</span><span class="s1">&#39;: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="n">key</span><span class="p">],</span><span class="s1">&#39; it/s | &#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="p">)</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39; ms/it&#39;</span> <span class="p">)</span>
            <span class="n">t_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span>
            
    <span class="k">def</span> <span class="nf">k_micro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mol_type_1</span><span class="p">,</span> <span class="n">mol_type_2</span><span class="p">,</span> <span class="n">k_macro</span><span class="p">,</span> <span class="n">R_react</span><span class="p">,</span> <span class="n">loc_type</span> <span class="o">=</span> <span class="s1">&#39;Volume&#39;</span><span class="p">):</span>
        
        <span class="n">k</span> <span class="o">=</span> <span class="n">ru</span><span class="o">.</span><span class="n">k_micro</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">mol_type_1</span><span class="p">,</span> <span class="n">mol_type_2</span><span class="p">,</span> <span class="n">k_macro</span><span class="p">,</span> <span class="n">R_react</span><span class="p">,</span> <span class="n">loc_type</span> <span class="o">=</span> <span class="n">loc_type</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">k</span>
    
    <span class="k">def</span> <span class="nf">k_macro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">D1</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span> <span class="n">k_micro</span><span class="p">,</span> <span class="n">R_react</span><span class="p">):</span>
        
        <span class="n">k</span> <span class="o">=</span> <span class="n">ru</span><span class="o">.</span><span class="n">k_macro</span><span class="p">(</span><span class="n">D1</span><span class="p">,</span> <span class="n">D2</span><span class="p">,</span> <span class="n">k_micro</span><span class="p">,</span> <span class="n">R_react</span><span class="p">)</span>
            
        <span class="k">return</span> <span class="n">k</span>
    
<div class="viewcode-block" id="Simulation.add_checkpoints"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.add_checkpoints">[docs]</a>    <span class="k">def</span> <span class="nf">add_checkpoints</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">max_saves</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="n">item_t_checkpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">([(</span><span class="s1">&#39;directory&#39;</span><span class="p">,</span> <span class="s1">&#39;U40&#39;</span><span class="p">),(</span><span class="s1">&#39;max_saves&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">),(</span><span class="s1">&#39;stride&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)],</span>  <span class="n">align</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>   
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">item_t_checkpoint</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stride&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">stride</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;directory&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_saves</span></div>
        
        
    <span class="k">def</span> <span class="nf">add_barostat_berendsen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Tau_P</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">start</span><span class="p">):</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_barostat_berendsen</span><span class="p">(</span><span class="n">Tau_P</span><span class="p">,</span> <span class="n">P0</span><span class="p">,</span> <span class="n">start</span><span class="p">)</span>
        
<div class="viewcode-block" id="Simulation.set_compartments"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.set_compartments">[docs]</a>    <span class="k">def</span> <span class="nf">set_compartments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Compartments</span><span class="p">,</span> <span class="n">triangles</span><span class="p">,</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">mesh_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">cells_per_dim</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">!=</span><span class="mi">3</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_system_grid</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Please register all particle types used in the simulation or manualy define a grid size for the simulation box before adding a mesh compartment! &#39;</span><span class="p">)</span>
            
        <span class="c1"># Check if there are any transparent face groups:</span>
        <span class="n">triangle_ids_transparent</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">comp_name</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;transparent&#39;</span><span class="p">:</span>
                        <span class="n">triangle_ids_transparent</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">triangle_ids_transparent</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="n">triangle_ids_transparent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">triangle_ids_transparent</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">triangle_ids_transparent</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="c1"># --------------------</span>
        <span class="c1"># Check if a Box compartment is defined:</span>
        <span class="k">if</span> <span class="s1">&#39;Box&#39;</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">:</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_box_compartment</span><span class="p">()</span>
            <span class="n">box_triangle_ids</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">box_triangle_ids</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="c1"># --------------------</span>
        <span class="c1">#Add mesh:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_mesh</span><span class="p">(</span><span class="n">vertices</span><span class="p">,</span> <span class="n">triangles</span><span class="p">,</span> <span class="n">mesh_scale</span><span class="p">,</span> <span class="n">box_triangle_ids</span><span class="p">,</span> <span class="n">triangle_ids_transparent</span><span class="p">)</span>
        
        <span class="c1"># -------------------</span>
        
        <span class="k">for</span> <span class="n">comp_name</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">comp_name</span> <span class="o">!=</span> <span class="s1">&#39;Box&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">set_compartments</span><span class="p">(</span><span class="n">comp_name</span><span class="p">,</span> <span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;triangle_ids&#39;</span><span class="p">])</span>
                
                <span class="n">comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">n_comps</span>
            
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s1">&#39;border&#39;</span><span class="p">:</span>
                            <span class="n">triangle_ids_border</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_border_2d</span><span class="p">(</span><span class="n">triangle_ids_border</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                            
                            <span class="k">if</span> <span class="s1">&#39;Box&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">:</span>
                                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Compartment border given, but the Box Compartment is missing!&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">comp_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">Compartments</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">]:</span>
                                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;Compartment-Box intersection face group is missing!&#39;</span><span class="p">)</span>
                            
                            <span class="n">triangle_ids_border_box</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">][</span><span class="n">comp_name</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_border_3d</span><span class="p">(</span><span class="n">triangle_ids_border_box</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                                
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">triangle_ids_group</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_id</span><span class="p">]</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="n">triangle_ids_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                        
            <span class="k">elif</span> <span class="n">comp_name</span> <span class="o">==</span> <span class="s1">&#39;Box&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">Compartments</span><span class="p">[</span><span class="n">comp_name</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span> 
                
                <span class="n">triangle_ids_box</span> <span class="o">=</span> <span class="n">Compartments</span><span class="p">[</span><span class="s1">&#39;Box&#39;</span><span class="p">][</span><span class="s1">&#39;face_groups&#39;</span><span class="p">][</span><span class="s1">&#39;Box&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_border_3d</span><span class="p">(</span><span class="n">triangle_ids_box</span><span class="p">)</span>
                
                
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">create_cell_list</span><span class="p">()</span></div>
                
                
        
    <span class="k">def</span> <span class="nf">register_particle_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">radius</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">register_particle_type</span><span class="p">(</span><span class="n">Type</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
        
    <span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">add_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interaction_type</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">bond</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">convert_dict</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_interaction</span><span class="p">(</span><span class="n">interaction_type</span><span class="p">,</span> <span class="n">type1</span><span class="p">,</span> <span class="n">type2</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">bond</span><span class="p">)</span>
        

<span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">add_up_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">product_loc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">product_direction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
            
        <span class="k">if</span> <span class="n">reaction_type</span> <span class="o">==</span> <span class="s1">&#39;release&#39;</span><span class="p">:</span>
            <span class="n">product_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">product_loc</span><span class="p">])</span>
            <span class="n">product_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="n">product_direction</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_direction</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_up_reaction</span><span class="p">(</span><span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            
    <span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">add_um_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">product_loc</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">product_direction</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">radius</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">product_types</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_types</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_loc</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_loc</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">product_direction</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">product_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_direction</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_um_reaction</span><span class="p">(</span><span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_type</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">product_loc</span><span class="p">,</span> <span class="n">product_direction</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
            
    <span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">add_bp_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_types</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">interaction_type</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">interaction_parameters</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="n">educt_1_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
        <span class="n">educt_2_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">radius</span> <span class="o">&lt;</span> <span class="n">educt_1_radius</span><span class="o">+</span><span class="n">educt_2_radius</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: The reaction radius for the particle pair </span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> is smaller than the sum of their radii. The reaction radius should not be smaller than </span><span class="si">{2:.3g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">educt_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">educt_types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">educt_1_radius</span><span class="o">+</span><span class="n">educt_2_radius</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">interaction_parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">interaction_parameters</span> <span class="o">=</span> <span class="n">convert_dict</span><span class="p">(</span><span class="n">interaction_parameters</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_bp_reaction</span><span class="p">(</span><span class="n">reaction_type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">educt_types</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_types</span><span class="p">),</span> <span class="n">rate</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">interaction_type</span><span class="p">,</span> <span class="n">interaction_parameters</span><span class="p">)</span>
        
    <span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">add_bm_reaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reaction_type</span><span class="p">,</span> <span class="n">educt_types</span><span class="p">,</span> <span class="n">product_types</span><span class="p">,</span> <span class="n">particle_pairs</span><span class="p">,</span> <span class="n">pair_rates</span><span class="p">,</span> <span class="n">pair_radii</span><span class="p">):</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">particle_types</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particle_pairs</span><span class="p">):</span>
            <span class="n">educt_1_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
            <span class="n">educt_2_radius</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">[</span><span class="n">particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">]][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;radius&#39;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">pair_radii</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">educt_1_radius</span><span class="o">+</span><span class="n">educt_2_radius</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: The reaction radius for the particle pair </span><span class="si">{0}</span><span class="s1">, </span><span class="si">{1}</span><span class="s1"> is smaller than the sum of their radii. The reaction radius should not be smaller than </span><span class="si">{2:.3g}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">particle_types</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">particle_types</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">educt_1_radius</span><span class="o">+</span><span class="n">educt_2_radius</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">add_bm_reaction</span><span class="p">(</span><span class="n">reaction_type</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">educt_types</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">product_types</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particle_pairs</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pair_rates</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pair_radii</span><span class="p">))</span>
            
    <span class="c1">#%%</span>
    
    <span class="k">def</span> <span class="nf">register_molecule_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">particle_pos</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">,</span> <span class="n">collision_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h_membrane</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="n">particle_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particle_pos</span><span class="p">)</span>
        <span class="n">particle_types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particle_types</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="s1">&#39;U20&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">register_molecule_type</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">particle_pos</span><span class="p">,</span> <span class="n">particle_types</span><span class="p">,</span> <span class="n">collision_type</span><span class="p">,</span> <span class="n">h_membrane</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">set_diffusion_tensor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">D_tt</span><span class="p">,</span> <span class="n">D_rr</span><span class="p">):</span>
        
        <span class="n">D_tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_tt</span><span class="p">)</span>
        <span class="n">D_rr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">D_rr</span><span class="p">)</span>
        
        <span class="n">mu_tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">D_tt</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span><span class="p">))</span>
        <span class="n">mu_rb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">D_rr</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">kbt</span><span class="p">))</span>
        
        <span class="n">mu_tb_sqrt</span> <span class="o">=</span> <span class="n">sqrtm</span><span class="p">(</span><span class="n">mu_tb</span><span class="p">)</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">valid_mobility_tensor_test</span><span class="p">(</span><span class="n">mu_tb</span><span class="p">,</span> <span class="n">mu_tb_sqrt</span><span class="p">)</span>
        <span class="n">mu_rb_sqrt</span> <span class="o">=</span> <span class="n">sqrtm</span><span class="p">(</span><span class="n">mu_rb</span><span class="p">)</span>
        <span class="n">trf</span><span class="o">.</span><span class="n">valid_mobility_tensor_test</span><span class="p">(</span><span class="n">mu_rb</span><span class="p">,</span> <span class="n">mu_rb_sqrt</span><span class="p">)</span>
        
        <span class="c1"># If mu passed the valid mobility tensor test there might still exist a small imaginary part due to numerical errors occuring in sqrtm():</span>
        <span class="n">mu_rb_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mu_rb_sqrt</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        <span class="n">mu_tb_sqrt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">mu_tb_sqrt</span><span class="o">.</span><span class="n">real</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">set_diffusion_tensor</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">D_tt</span><span class="p">,</span> <span class="n">D_rr</span><span class="p">,</span> <span class="n">mu_tb</span><span class="p">,</span> <span class="n">mu_rb</span><span class="p">,</span> <span class="n">mu_tb_sqrt</span><span class="p">,</span> <span class="n">mu_rb_sqrt</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">fixed_concentration_at_boundary</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">molecule_name</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">fixed_concentration_at_boundary</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">location</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">fixed_concentration_at_boundary</span><span class="p">(</span><span class="n">molecule_name</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Location must be either Volume or Surface!&#39;</span><span class="p">)</span>            
        
<div class="viewcode-block" id="Simulation.add_molecules"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.add_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">add_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">Compartment_Number</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">points_type</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">Compartment_Number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No compartment with id </span><span class="si">{}</span><span class="s1"> found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Compartment_Number</span><span class="p">))</span>
        
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        
        <span class="k">if</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">elif</span> <span class="n">Compartment_Number</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be a positive interger!&#39;</span><span class="p">)</span>
                
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Types</span><span class="p">[</span><span class="n">points_type</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">comp_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                
        <span class="k">elif</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">comp_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be greater zero!&#39;</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">face_ids</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Missing required argument face_ids&#39;</span><span class="p">)</span>
                
            <span class="c1"># a_n = np.zeros(3)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">points</span><span class="p">)):</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">add_RB</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">Types</span><span class="p">[</span><span class="n">points_type</span><span class="p">[</span><span class="n">i</span><span class="p">]]),</span> <span class="n">comp_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">set_triangle</span><span class="p">(</span><span class="n">face_ids</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">set_pos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> 
                
                <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">set_orientation_quat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="o">.</span><span class="n">slot</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Location must be either Volume or Surface!&#39;</span><span class="p">)</span>            </div>

            
<div class="viewcode-block" id="Simulation.distribute"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.distribute">[docs]</a>    <span class="k">def</span> <span class="nf">distribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Method</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">Compartment_Number</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">jitter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">facegroup</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">Compartment_Number</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No compartment with id </span><span class="si">{}</span><span class="s1"> found!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Compartment_Number</span><span class="p">))</span>
    
        <span class="n">Number</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Number</span><span class="p">)</span>
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Types</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">Method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;PDS&#39;</span><span class="p">,</span> <span class="s1">&#39;PDS uniform&#39;</span><span class="p">,</span> <span class="s1">&#39;Gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;MC&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Method </span><span class="si">{}</span><span class="s1"> does not exist!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Method</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">Method</span> <span class="o">==</span> <span class="s1">&#39;MC&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">mc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">],</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">elif</span> <span class="n">Compartment_Number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">mc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be a positive interger!&#39;</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
                
                <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">distribute_surf</span><span class="o">.</span><span class="n">mc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">],</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">facegroup</span><span class="p">)</span>
                
                <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Location must be either Volume or Surface!&#39;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">Method</span> <span class="o">==</span> <span class="s1">&#39;PDS uniform&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">pds_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">elif</span> <span class="n">Compartment_Number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">pds_uniform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">multiplier</span> <span class="o">=</span> <span class="n">multiplier</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be a positive interger!&#39;</span><span class="p">)</span>
                    
            <span class="k">elif</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Method &quot;PDS uniform&quot; is only available for distribution of points in a Compartment Volume. For Surface distribution use Method &quot;PDS&quot; instead!&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Location must be either Volume or Surface!&#39;</span><span class="p">)</span>
                    
                    
        <span class="k">if</span> <span class="n">Method</span> <span class="o">==</span> <span class="s1">&#39;PDS&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">pds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="p">,</span> <span class="n">max_trials</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">elif</span> <span class="n">Compartment_Number</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">pds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">clustering_factor</span><span class="p">,</span> <span class="n">max_trials</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be a positive interger!&#39;</span><span class="p">)</span>
            
            <span class="k">elif</span> <span class="n">Location</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Compartment_Number</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">distribute_surf</span><span class="o">.</span><span class="n">pds</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Compartments</span><span class="p">[</span><span class="n">Compartment_Number</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">facegroup</span><span class="p">)</span>
                    
                    <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span>
                
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s1">&#39;Compartment number must be greater than zero!&#39;</span><span class="p">)</span>
                    
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Location must be either Volume or Surface!&#39;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">Method</span> <span class="o">==</span> <span class="s1">&#39;Gauss&#39;</span><span class="p">:</span>
            <span class="n">points</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">face_ids</span> <span class="o">=</span> <span class="n">distribute_surf</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">triangle_id</span><span class="p">,</span> <span class="n">jitter</span><span class="p">,</span> <span class="n">Number</span><span class="p">,</span> <span class="n">Types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">points</span><span class="p">,</span> <span class="n">points_types</span><span class="p">,</span> <span class="n">quaternion</span><span class="p">,</span> <span class="n">face_ids</span></div>
        
    <span class="c1">#%%</span>
    
<div class="viewcode-block" id="Simulation.observe"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Measure</span><span class="p">,</span> <span class="n">molecules</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">reactions</span> <span class="o">=</span> <span class="s1">&#39;All&#39;</span><span class="p">,</span> <span class="n">obs_stride</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bin_width</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">n_bins</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stepwise</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">binned</span><span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="o">=</span> <span class="n">Observables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">Measure</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">Measures</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NameError</span><span class="p">(</span><span class="s1">&#39;Measure </span><span class="si">{}</span><span class="s1"> not known!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Measure</span><span class="p">))</span>
          
            
        <span class="k">if</span> <span class="n">Measure</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Force&#39;</span><span class="p">,</span> <span class="s1">&#39;Troque&#39;</span><span class="p">,</span> <span class="s1">&#39;Orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;Position&#39;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">binned</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">binned</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">stepwise</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Binning is not supported for property </span><span class="si">{0}</span><span class="s1">. PyRID will instead sample </span><span class="si">{0}</span><span class="s1"> stepwise!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Measure</span><span class="p">))</span>
            
        <span class="k">if</span> <span class="n">molecules</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
            <span class="n">molecules</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">mol</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                <span class="n">molecules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mol</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">reactions</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
            <span class="n">reactions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">reactions_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">:</span>
                <span class="n">reactions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">reactions_id</span><span class="p">)</span>
                
        <span class="n">molecules</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">molecules</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">Measure</span><span class="p">,</span> <span class="n">obs_stride</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">types</span> <span class="o">=</span> <span class="n">molecules</span><span class="p">,</span> <span class="n">reactions</span> <span class="o">=</span> <span class="n">reactions</span><span class="p">,</span> <span class="n">stepwise</span> <span class="o">=</span> <span class="n">stepwise</span><span class="p">,</span> <span class="n">binned</span><span class="o">=</span> <span class="n">binned</span><span class="p">)</span></div>
            
        
        
           
    <span class="k">def</span> <span class="nf">observe_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rdf_pairs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">rdf_bins</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">rdf_cutoff</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stride</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="o">=</span> <span class="n">Observables</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">observe_rdf</span><span class="p">(</span><span class="n">rdf_pairs</span><span class="p">,</span> <span class="n">rdf_bins</span><span class="p">,</span> <span class="n">rdf_cutoff</span><span class="p">,</span> <span class="n">stride</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Observing RDF.&#39;</span><span class="p">)</span>
        
        
    <span class="c1">#%%</span>
                
<div class="viewcode-block" id="Simulation.add_release_site"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.add_release_site">[docs]</a>    <span class="k">def</span> <span class="nf">add_release_site</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Location</span><span class="p">,</span> <span class="n">timepoint</span><span class="p">,</span> <span class="n">compartment_id</span><span class="p">,</span> <span class="n">Number</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Types</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">jitter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Molecules_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Positions</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Quaternion</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">triangle_id</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">release_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;compartment_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compartment_id</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;timepoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timepoint</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Location</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;triangle_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">triangle_id</span>
        
        <span class="c1"># Use position data passed by user:</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;Positions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Positions</span><span class="p">)</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;Quaternion&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Quaternion</span><span class="p">)</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;Molecules_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Molecules_id</span>
        
        <span class="c1"># Release Molecules based on some Method:</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Number</span><span class="p">)</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;Types&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Types</span><span class="p">)</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;jitter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jitter</span>
        <span class="n">release_dict</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">origin</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">release_events</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">release_dict</span><span class="p">)</span></div>
            
            
<div class="viewcode-block" id="Simulation.release_molecules"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.release_molecules">[docs]</a>    <span class="k">def</span> <span class="nf">release_molecules</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">release_event</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">Types</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        
        <span class="k">if</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;jitter&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="n">Positions</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Molecules_id</span> <span class="o">=</span> <span class="n">distribute_vol</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;jitter&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Types&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
            
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Positions</span> <span class="o">=</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Positions&#39;</span><span class="p">]</span>
                <span class="n">Quaternion</span> <span class="o">=</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Quaternion&#39;</span><span class="p">]</span>
                <span class="n">Molecules_id</span> <span class="o">=</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Molecules_id&#39;</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Positions</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">distribute_vol</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;compartment_id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="n">Positions</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Molecules_id</span><span class="p">,</span> <span class="n">Types</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Surface&#39;</span><span class="p">:</span>
        
            <span class="n">Positions</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Molecules_id</span><span class="p">,</span> <span class="n">Triangle_ids</span> <span class="o">=</span> <span class="n">distribute_surf</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;triangle_id&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;jitter&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Number&#39;</span><span class="p">],</span> <span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;Types&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Positions</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">distribute_surf</span><span class="o">.</span><span class="n">add_molecules</span><span class="p">(</span><span class="n">release_event</span><span class="p">[</span><span class="s1">&#39;compartment_id&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="n">Positions</span><span class="p">,</span> <span class="n">Quaternion</span><span class="p">,</span> <span class="n">Triangle_ids</span><span class="p">,</span> <span class="n">Molecules_id</span><span class="p">,</span> <span class="n">Types</span><span class="p">)</span></div>
                
    
<span class="c1">#%%</span>

    <span class="c1"># ------------------</span>
    
<div class="viewcode-block" id="Simulation.progress"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.progress">[docs]</a>    <span class="k">def</span> <span class="nf">progress</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim_time</span><span class="p">,</span> <span class="n">nsteps</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">time_passed</span><span class="p">,</span> <span class="n">it_per_s</span><span class="p">,</span> <span class="n">Np</span><span class="p">,</span> <span class="n">Pressure_total</span><span class="p">,</span> <span class="n">N_bonds</span><span class="p">,</span> <span class="n">Volume</span><span class="p">,</span> <span class="n">out_linebreak</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">30</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1"># sys.stdout.write(&quot;\033[F&quot;) #back to previous line </span>
        <span class="c1"># sys.stdout.write(&quot;\033[K&quot;) #clear line </span>
        
        <span class="k">if</span> <span class="n">out_linebreak</span><span class="o">==</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">end_type</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">end_type</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
            
            
        <span class="k">if</span> <span class="n">sim_time</span><span class="o">&lt;</span><span class="mf">1e10</span><span class="p">:</span>
            
            <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">time_passed</span> <span class="o">//</span> <span class="n">sim_time</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">left</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">time_passed</span><span class="o">/</span> <span class="n">sim_time</span> <span class="o">*</span><span class="mi">100</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">[&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">left</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">right</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span>
                  <span class="s1">&#39; </span><span class="si">{0:1.0f}</span><span class="s1">% |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Time left: </span><span class="si">{0:1.1f}</span><span class="s1"> min.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">((</span><span class="n">sim_time</span><span class="o">-</span><span class="n">time_passed</span><span class="p">)</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            
            <span class="n">left</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">j</span> <span class="o">//</span> <span class="n">nsteps</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">width</span> <span class="o">-</span> <span class="n">left</span>
            <span class="n">percent</span> <span class="o">=</span> <span class="n">j</span><span class="o">/</span><span class="n">nsteps</span> <span class="o">*</span><span class="mi">100</span>
            
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\r</span><span class="s1">[&#39;</span><span class="p">,</span> <span class="s1">&#39;#&#39;</span> <span class="o">*</span> <span class="n">left</span><span class="p">,</span> <span class="s1">&#39; &#39;</span> <span class="o">*</span> <span class="n">right</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">,</span> <span class="s1">&#39; </span><span class="si">{0:1.0f}</span><span class="s1">% |&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">percent</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;Steps left: </span><span class="si">{0:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsteps</span><span class="o">-</span><span class="n">j</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            
                
        <span class="c1"># print(&#39;\r[&#39;, &#39;#&#39; * left, &#39; &#39; * right, &#39;]&#39;,</span>
        <span class="c1">#       &#39; {0:.0f}% |&#39;.format(percent)+progress_type+&#39;: {0:1.1f} min.&#39;.format((sim_time-time_passed)/60),</span>
        <span class="c1">#       &#39;| P: {0:.2E}&#39;.format(Pressure_total), &#39;| Bonds: {0:1.0f}&#39;.format(np.sum(N_bonds)),</span>
        <span class="c1">#       &#39;| V: {0:.2E}&#39;.format(Volume), &#39;| Time: {0:1.1f} min.&#39;.format(time_passed/60), &#39;| step: {0:1.0f}&#39;.format(j), &#39;| it/s: {0:1.1f}&#39;.format(it_per_s), &#39;| pu/s: {0:1.1f}&#39;.format(Np*it_per_s), &#39;| N: {0:d} |&#39;.format(N),</span>
        <span class="c1">#       sep=&#39;&#39;, end=end_type, flush=True)</span>
        
        
        <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">progress_properties</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;it/s&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| it/s: </span><span class="si">{0:1.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it_per_s</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;pu/s&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| pu/s: </span><span class="si">{0:1.1f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Np</span><span class="o">*</span><span class="n">it_per_s</span><span class="p">),</span><span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Time passed&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Time: </span><span class="si">{0:1.1f}</span><span class="s1"> min.&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time_passed</span><span class="o">/</span><span class="mi">60</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;step&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| step: </span><span class="si">{0:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">j</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;N&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| N: </span><span class="si">{0:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">N</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>                
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| P: </span><span class="si">{0:1.2E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Pressure_total</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Volume&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| V: </span><span class="si">{0:1.2E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Volume</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Vol_Frac&#39;</span><span class="p">:</span>
                
                <span class="n">Vfrac</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">mol_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">:</span>
                    <span class="n">mol_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span><span class="o">.</span><span class="n">type_id</span>
                    <span class="n">N</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Nmol</span><span class="p">[</span><span class="n">mol_id</span><span class="p">]</span>
                    <span class="n">Vfrac</span> <span class="o">+=</span> <span class="n">N</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_types</span><span class="p">[</span><span class="n">mol_name</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span>
                    
                 
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Vfrac: </span><span class="si">{0:1.2E}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Vfrac</span><span class="p">),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="k">if</span> <span class="n">prop</span> <span class="o">==</span> <span class="s1">&#39;Bonds&#39;</span><span class="p">:</span>
                
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;| Bonds: </span><span class="si">{0:1.0f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">N_bonds</span><span class="p">)),</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_type</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
                

            
<span class="c1">#%%</span>

<div class="viewcode-block" id="Simulation.load_checkpoint"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.load_checkpoint">[docs]</a>    <span class="k">def</span> <span class="nf">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;checkpoints/&#39;</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">file_extension</span> <span class="o">=</span> <span class="s1">&#39;.npz&#39;</span>
        <span class="k">if</span> <span class="n">file_name</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;.npz&#39;</span><span class="p">:</span>
            <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span> <span class="o">=</span> <span class="n">load_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="n">directory</span> <span class="o">=</span> <span class="n">directory</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">file_name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">file_extension</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span></div>
        
        
    <span class="c1">#%%</span>
    
    
<div class="viewcode-block" id="Simulation.run"><a class="viewcode-back" href="../../Developers/Developer%20API/run.html#pyrid.run.Simulation.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">progress_stride</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">keep_time</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">out_linebreak</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">progress_bar_properties</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">start_reactions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span>
        
        <span class="sd">&quot;&quot;&quot;A brief description of what the function (method in case of classes) is and what it’s used for</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameter_1 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        parameter_2 : dtype</span>
<span class="sd">            Some Information</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        NotImplementedError (just an example)</span>
<span class="sd">            Brief explanation of why/when this exception is raised</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dtype</span>
<span class="sd">            Some information</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">progress_bar_properties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;it/s&#39;</span><span class="p">,</span> <span class="s1">&#39;pu/s&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">progress_bar_properties</span> <span class="o">==</span> <span class="s1">&#39;All&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;it/s&#39;</span><span class="p">,</span> <span class="s1">&#39;pu/s&#39;</span><span class="p">,</span> <span class="s1">&#39;Time passed&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Vol_Frac&#39;</span><span class="p">,</span> <span class="s1">&#39;Bonds&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">progress_bar_properties</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;progress_bar_properties must be a list of strings!&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">prop</span> <span class="ow">in</span> <span class="n">progress_bar_properties</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">prop</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;it/s&#39;</span><span class="p">,</span> <span class="s1">&#39;pu/s&#39;</span><span class="p">,</span> <span class="s1">&#39;Time passed&#39;</span><span class="p">,</span> <span class="s1">&#39;step&#39;</span><span class="p">,</span> <span class="s1">&#39;N&#39;</span><span class="p">,</span> <span class="s1">&#39;Pressure&#39;</span><span class="p">,</span> <span class="s1">&#39;Volume&#39;</span><span class="p">,</span> <span class="s1">&#39;Vol_Frac&#39;</span><span class="p">,</span> <span class="s1">&#39;Bonds&#39;</span><span class="p">]:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">prop</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;is not a supported property to be displayed in the progress bar!&#39;</span><span class="p">)</span>
                    
            <span class="bp">self</span><span class="o">.</span><span class="n">progress_properties</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;it/s&#39;</span><span class="p">,</span> <span class="s1">&#39;pu/s&#39;</span><span class="p">]</span><span class="o">+</span><span class="n">progress_bar_properties</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span> <span class="o">=</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">file_path</span><span class="o">+</span><span class="s1">&#39;hdf5/&#39;</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">file_name</span><span class="o">+</span><span class="s1">&#39;.h5&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span>
        
        <span class="n">print_system_count</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span> <span class="o">=</span> <span class="n">hu</span><span class="o">.</span><span class="n">create_hgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Np</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
        
        <span class="c1"># Check if the reaction rates are not too high for the chosen time step, otherwise print a warning:</span>
        <span class="k">for</span> <span class="n">reaction_type_index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">:</span>
            <span class="n">Reaction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">reaction_type_index</span><span class="p">]</span>
            <span class="k">if</span> <span class="mi">10</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="o">/</span><span class="n">Reaction</span><span class="o">.</span><span class="n">rate</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">Reaction</span><span class="o">.</span><span class="n">reaction_educt_type</span> <span class="o">==</span> <span class="s1">&#39;Molecule&#39;</span><span class="p">:</span>
                    <span class="n">educts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">molecule_id_to_name</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">educt_id</span> <span class="ow">in</span> <span class="n">Reaction</span><span class="o">.</span><span class="n">educts</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">educts</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_id_to_name</span><span class="p">[</span><span class="n">educt_id</span><span class="p">]</span> <span class="k">for</span> <span class="n">educt_id</span> <span class="ow">in</span> <span class="n">Reaction</span><span class="o">.</span><span class="n">educts</span><span class="p">]</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;Warning: Reaction rate for the </span><span class="si">{0}</span><span class="s1"> reaction of educts </span><span class="si">{1}</span><span class="s1"> &gt; 1/(10*dt). k*dt = </span><span class="si">{2:.3g}</span><span class="s1">. Discretization errors may become too large!&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">Reaction</span><span class="o">.</span><span class="n">reaction_educt_type</span> <span class="p">,</span><span class="n">educts</span><span class="p">,</span> <span class="n">Reaction</span><span class="o">.</span><span class="n">rate</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        
        <span class="c1">#-----------------------------------------------------</span>
        <span class="c1"># Initialize Write Molecule Traces</span>
        <span class="c1">#-----------------------------------------------------</span>

        <span class="n">wru</span><span class="o">.</span><span class="n">write_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
        
        <span class="c1">#---------------------</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;directory&#39;</span><span class="p">])</span> 
            <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
                <span class="c1"># directory already exists</span>
                <span class="k">pass</span>
                    
    
        <span class="n">lu_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_units_prefix</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">length_unit</span><span class="p">]</span>
        <span class="n">Pressure_total</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">Pressure_Tensor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">checkpoint_counter</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;integrate&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;reactions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;observables&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;barostat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="c1">#%%</span>
        <span class="c1"># ------------------------------------------</span>
        <span class="c1"># Write to file</span>
        <span class="c1"># ------------------------------------------</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            
            <span class="n">cp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span><span class="p">,</span> <span class="n">checkpoint_counter</span><span class="p">)</span>
            <span class="n">checkpoint_counter</span> <span class="o">+=</span> <span class="mi">1</span>
            
            <span class="k">if</span> <span class="n">checkpoint_counter</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]:</span>
                <span class="n">checkpoint_counter</span> <span class="o">=</span> <span class="mi">0</span>
    
        <span class="n">wru</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">)</span>
        
        <span class="c1">#%%</span>
        
        <span class="c1"># # ------------------------------------------</span>
        <span class="c1"># # Update Force</span>
        <span class="c1"># # ------------------------------------------</span>
        
        <span class="c1"># if self.System.interactions == True:</span>
            
        <span class="c1">#     uf.update_force_append_reactions(self.Particles, self.System, self.RBs, self.HGrid)</span>
            
        <span class="c1">#     Pressure_total, Pressure_Tensor = update_pressure(self)</span>
            
        <span class="c1">#%%</span>
                
        <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="n">time_jit</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">j</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">j</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">done</span><span class="p">:</span>
                
    
            <span class="c1">#%%</span>
            
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Progress</span>
            <span class="c1"># ------------------------------------------</span>
            <span class="k">if</span> <span class="n">keep_time</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">Time_passed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">)</span>
            
            
            <span class="k">if</span> <span class="n">j</span><span class="o">%</span><span class="n">progress_stride</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                <span class="c1"># if (time.perf_counter()-time_stamp)&gt;0.0:</span>
                <span class="n">itps</span> <span class="o">=</span> <span class="n">progress_stride</span><span class="o">/</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">time_stamp</span><span class="p">)</span>
                <span class="c1"># else:</span>
                <span class="c1">#     itps = 10000</span>
                    
                <span class="bp">self</span><span class="o">.</span><span class="n">progress</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span><span class="p">,</span><span class="n">j</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="n">itps</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Np</span><span class="p">,</span> <span class="n">Pressure_total</span><span class="o">*</span><span class="mf">1e3</span><span class="o">*</span><span class="n">lu_prefix</span><span class="o">**</span><span class="mi">3</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">avogadro</span><span class="o">*</span><span class="mf">1e-5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N_bonds</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span><span class="p">,</span> <span class="n">out_linebreak</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N</span><span class="p">)</span>
                
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="c1"># We start counting time after the first iteration so the result does not get biased by the initial jit compilation!</span>
                <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="n">time_stamp</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                
            <span class="c1">#%%</span>
            
            <span class="k">if</span> <span class="n">print_system_count</span> <span class="ow">and</span> <span class="n">j</span><span class="o">%</span><span class="n">progress_stride</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;count:&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
            
            
            <span class="c1">#%%</span>
            
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">re_initialize</span><span class="p">()</span>
                
            <span class="c1">#%%</span>
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Update Positions</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="n">start_pos</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">mesh</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">upos</span><span class="o">.</span><span class="n">update_rb_compartments</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">upos</span><span class="o">.</span><span class="n">update_rb</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
    
            <span class="n">end_pos</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_pos</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;integrate&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_pos</span>

            
            <span class="c1">#%%</span>
            
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Update Force</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="n">start_force</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">interactions</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                
                <span class="n">uf</span><span class="o">.</span><span class="n">update_force_append_reactions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span><span class="p">)</span>
                
                <span class="n">Pressure_total</span><span class="p">,</span> <span class="n">Pressure_Tensor</span> <span class="o">=</span> <span class="n">update_pressure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                
                <span class="c1">#Ideales Gas: P =2/3*N/V*Ekin, Ekin = 1/2*m*v^2 = f/2*kB*T (3D: f=3)</span>
                
                <span class="c1"># Pressure_Tensor = (self.System.N*self.System.kbt + Vir_Tensor)/self.System.volume</span>
    
            <span class="n">end_force</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_force</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;force&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_force</span>
            
            
            <span class="c1">#%%</span>
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Evaluate Reactions</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="k">if</span> <span class="n">j</span><span class="o">&gt;=</span><span class="n">start_reactions</span><span class="p">:</span>
                
                <span class="n">start_react</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Reactions_Dict</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
                    <span class="n">uru</span><span class="o">.</span><span class="n">update_reactions</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">)</span>
                
                <span class="k">for</span> <span class="n">event</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">release_events</span><span class="p">:</span>
                    
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;timepoint&#39;</span><span class="p">]:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">release_molecules</span><span class="p">(</span><span class="n">event</span><span class="p">)</span>
                        
                    
                <span class="n">end_react</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_react</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;reactions&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_react</span>
                
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">reactions_left</span> <span class="o">=</span> <span class="mi">0</span>
                
            <span class="c1">#%%</span>
            
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Handle fixed concentration boundary</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">boundary_condition_id</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">distribute_vol</span><span class="o">.</span><span class="n">release_molecules_boundary</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">)</span>
                <span class="n">distribute_surf</span><span class="o">.</span><span class="n">release_molecules_boundary_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">)</span>
            
            <span class="c1">#%%</span>
            
            <span class="c1"># UPDATE FORCES FOR REACTION PRODUCTS</span>
            
            <span class="c1">#%%</span>
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Update Barostat</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="n">start_barostat</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;active&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span> <span class="ow">and</span> <span class="n">j</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;start&#39;</span><span class="p">]:</span>
    
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Tau_P&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">Pressure_total</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;P0&#39;</span><span class="p">]))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="o">*=</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">barostat</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;mu&#39;</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">volume</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
                
                <span class="c1">#----------------------------------</span>
                <span class="c1">#=====================</span>
                <span class="c1"># Anisotropic barostat:</span>
                <span class="c1">#=====================    </span>
                
                <span class="c1"># self.System.barostat[0][&#39;mu_tensor&#39;][:,:]=(np.eye(3)+self.System.dt/self.System.barostat[0][&#39;Tau_P&#39;]*(Pressure_Tensor-self.System.barostat[0][&#39;P0&#39;]))**(1/3)</span>
                
                <span class="c1"># #We assume that our simulation box is rectangular!</span>
                <span class="c1"># self.System.box_lengths[0]=self.System.barostat[0][&#39;mu_tensor&#39;][0][0]*self.System.box_lengths[0]</span>
                <span class="c1"># self.System.box_lengths[1]=self.System.barostat[0][&#39;mu_tensor&#39;][1][1]*self.System.box_lengths[1]</span>
                <span class="c1"># self.System.box_lengths[2]=self.System.barostat[0][&#39;mu_tensor&#39;][2][2]*self.System.box_lengths[2]</span>
                
                <span class="c1"># self.System.volume = self.System.box_lengths.prod()</span>
                
                <span class="c1">#----------------------------------</span>
                
                
                <span class="n">hu</span><span class="o">.</span><span class="n">update_hgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Np</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">observing_rdf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">update_rb_hgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">rdf_hgrid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">update_rb_barostat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">)</span>
                
            <span class="n">end_barostat</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_barostat</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;barostat&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_barostat</span>
            
            
            <span class="c1">#%%</span>
            
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Update HGrid</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Np</span><span class="p">:</span>
            
                <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span> <span class="o">=</span> <span class="n">hu</span><span class="o">.</span><span class="n">create_hgrid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">particle_types</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">Np</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">observing_rdf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">rdf_hgrid</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;ls&#39;</span><span class="p">])</span><span class="o">&lt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N</span><span class="p">:</span>
                    
                        <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">rdf_hgrid</span> <span class="o">=</span> <span class="n">create_rb_hgrid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">rdf_molecules</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">box_lengths</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">N</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">)</span>
                
            
            <span class="c1">#%%</span>
            
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Update Observables</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="n">start_obs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">update_bins</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
                
                <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">observing_rdf</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span><span class="o">.</span><span class="n">update_rdf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="p">)</span>
                
            <span class="n">end_obs</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_obs</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;observables&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_obs</span>
            
            
            <span class="c1">#%%</span>
            <span class="c1"># ------------------------------------------</span>
            <span class="c1"># Write to File</span>
            <span class="c1"># ------------------------------------------</span>
            
            <span class="n">start_write</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">j</span><span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">j</span><span class="o">%</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;stride&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    
                    <span class="n">cp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">RBs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">HGrid</span><span class="p">,</span> <span class="n">checkpoint_counter</span><span class="p">)</span>
                    <span class="n">checkpoint_counter</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="k">if</span> <span class="n">checkpoint_counter</span><span class="o">&gt;=</span><span class="bp">self</span><span class="o">.</span><span class="n">checkpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;max_saves&#39;</span><span class="p">]:</span>
                        <span class="n">checkpoint_counter</span> <span class="o">=</span> <span class="mi">0</span>
            
                <span class="n">wru</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">Particles</span><span class="p">)</span>
                
            <span class="n">end_write</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_write</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Timer</span><span class="p">[</span><span class="s1">&#39;write&#39;</span><span class="p">]</span><span class="o">+=</span><span class="n">end_write</span>
            
            <span class="c1">#%%</span>
            
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">nsteps</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start</span><span class="o">&gt;</span><span class="bp">self</span><span class="o">.</span><span class="n">sim_time</span><span class="p">:</span>
                <span class="n">done</span><span class="o">=</span><span class="kc">True</span>
                
            <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">j</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">System</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="n">j</span>
            
            <span class="c1">#%%</span>
            
            <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Simulation started!&#39;</span><span class="o">+</span><span class="s1">&#39;(JIT Compilation Time:</span><span class="si">{:1.1f}</span><span class="s1"> s)&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">time_jit</span><span class="p">))</span>
                
        <span class="c1">#%%</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        
        <span class="n">total_time</span><span class="o">=</span><span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span><span class="o">-</span><span class="n">start</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Time per steps: &#39;</span><span class="p">,</span> <span class="n">total_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="o">*</span><span class="mf">1e3</span><span class="p">,</span> <span class="s1">&#39;ms&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;it/s: &#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_step</span><span class="o">/</span><span class="n">total_time</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">Observer</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hdf</span><span class="o">.</span><span class="n">close</span><span class="p">()</span> </div></div>
        
    
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>