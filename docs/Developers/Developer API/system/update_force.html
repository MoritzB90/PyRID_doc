<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>update_force &mdash; PyRID 15.06.2022 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/my_theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/design-tabs.js"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="update_pos" href="update_pos.html" />
    <link rel="prev" title="system_util" href="system_util.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> PyRID
            <img src="../../../_static/PyRID_Logo_Render2_cropped.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Users</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/User_Guide/Contents.html">User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../Users/Examples/Contents.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developers</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../Overview.html">Overview</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Contents.html">Developer API</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../data_structures.html">data_structures</a></li>
<li class="toctree-l2"><a class="reference internal" href="../evaluation.html">evaluation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../geometry.html">geometry</a></li>
<li class="toctree-l2"><a class="reference internal" href="../math.html">math</a></li>
<li class="toctree-l2"><a class="reference internal" href="../molecules.html">molecules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../observables.html">observables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../reactions.html">reactions</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../system.html">system</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="distribute_surface_util.html">distribute_surface_util</a></li>
<li class="toctree-l3"><a class="reference internal" href="distribute_vol_util.html">distribute_vol_util</a></li>
<li class="toctree-l3"><a class="reference internal" href="potentials_util.html">potentials_util</a></li>
<li class="toctree-l3"><a class="reference internal" href="system_util.html">system_util</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">update_force</a></li>
<li class="toctree-l3"><a class="reference internal" href="update_pos.html">update_pos</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../run.html">run</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../Theory/Contents.html">Theory</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Validation/Contents.html">Validation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">References</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../References.html">References</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/MoritzB90/PyRID">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/">PyPI</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.youtube.com/channel/UC4o41QLwsfeh0g981MZPl7w">Youtube</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../license.html">license</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">PyRID</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../Contents.html">Developer API</a> &raquo;</li>
          <li><a href="../system.html">system</a> &raquo;</li>
      <li>update_force</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../_sources/Developers/Developer API/system/update_force.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="update-force">
<h1>update_force<a class="headerlink" href="#update-force" title="Permalink to this heading"></a></h1>
<p>Short description</p>
<span class="target" id="module-pyrid.system.update_force"></span><p>&#64;author: Moritz F P Becker</p>
<dl class="py function">
<dt class="sig sig-object py" id="pyrid.system.update_force.react_interact_test">
<span class="sig-prename descclassname"><span class="pre">pyrid.system.update_force.</span></span><span class="sig-name descname"><span class="pre">react_interact_test</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">comp_i</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">loc_type_i</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mol_idx_j</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mol_idx_i</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RBs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">System</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/pyrid/system/update_force.html#react_interact_test"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pyrid.system.update_force.react_interact_test" title="Permalink to this definition"></a></dt>
<dd><p>Tests if two particles are valid interaction or reaction partners.</p>
<dl class="field-list">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl>
<dt><strong>comp_i</strong><span class="classifier"><cite>int64</cite></span></dt><dd><p>Compartment index of molecule i</p>
</dd>
<dt><strong>loc_type_i</strong><span class="classifier"><cite>int64</cite></span></dt><dd><p>Location type of moelcule i (volume : 0, surface : 1)</p>
</dd>
<dt><strong>mol_idx_j</strong><span class="classifier"><cite>int64</cite></span></dt><dd><p>Index of moelcule j</p>
</dd>
<dt><strong>mol_idx_i</strong><span class="classifier"><cite>int64</cite></span></dt><dd><p>Index of moelcule i</p>
</dd>
<dt><strong>RBs</strong><span class="classifier"><cite>object</cite></span></dt><dd><p>Instance of RBs class</p>
</dd>
<dt><strong>System</strong><span class="classifier"><cite>object</cite></span></dt><dd><p>Instance of System class</p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Notes</p>
<p>We need to consider several cases:</p>
<ol class="arabic simple">
<li><dl class="simple">
<dt>If both particles are in the same compartment</dt><dd><ol class="arabic simple">
<li><p>and at least one is a volume molecule, interactions and reactions are always allowed.</p></li>
<li><p>If both particles are surface molecules, interactions are always valid but reactions are only allowed if the angle between the molecules’ triangle normals is less than 90 degree.</p></li>
</ol>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>If both particles are in different compartments</dt><dd><ol class="arabic simple">
<li><p>and both particles are volume molecules, neither interactions nor reactions are allowed.</p></li>
<li><p>If both particles are surface particles, interactions are allowed, however, not reactions except binding reactions!</p></li>
<li><dl class="simple">
<dt>If one of the particles belongs to a surface molecule and the other to a volume molecule</dt><dd><ol class="arabic simple">
<li><p>reactions are always allowed if one of the compartments is the simulation box (System), otherwise neither reactions, nor interactions are allowed.</p></li>
</ol>
</dd>
</dl>
</li>
</ol>
</dd>
</dl>
</li>
</ol>
<p>We neglect reactions for surface molecules at an angle above 90 degree because the error introduced by using euclidian distances becomes large. In general, you should not use meshes with high local curvature (relative to the molecule size and reaction readius) and/or large angles between neighboring triangle for this reason. Also, triangles that are far apart in terms of the geodesic distance can come close to each other in terms of euclidian distance. In the latter case, the angle between the triangle is, however, in most cases larger than 90 degree. Thereby, neglecting reactions also prevents this type of erroneous reactions.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="pyrid.system.update_force.update_force_append_reactions">
<span class="sig-prename descclassname"><span class="pre">pyrid.system.update_force.</span></span><span class="sig-name descname"><span class="pre">update_force_append_reactions</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">Particles</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">System</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">RBs</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">HGrid</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../../../_modules/pyrid/system/update_force.html#update_force_append_reactions"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#pyrid.system.update_force.update_force_append_reactions" title="Permalink to this definition"></a></dt>
<dd><p>Updates the pair interaction forces between the particle pairs and between particles and the compartemnt meshes (and the simulation box boundary in case of repulsive boundary conditions).
Also adds the bimolecular and unimolecular particle reactions to the reactions list.</p>
<dl class="field-list">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><dl>
<dt><strong>System</strong><span class="classifier"><cite>obj</cite></span></dt><dd><p>Instance of System class.</p>
</dd>
<dt><strong>Particles</strong><span class="classifier"><cite>obj</cite></span></dt><dd><p>Instance of Particle class.</p>
</dd>
<dt><strong>RBs</strong><span class="classifier"><cite>obj</cite></span></dt><dd><p>Instance of RBs (Rigid Bodies) class.</p>
</dd>
<dt><strong>HGrid</strong><span class="classifier"><cite>array_like</cite></span></dt><dd><p>Hierarchical grid that divides the simulation box into cells. The cell size decreases with the level of the hierarchical grid. Particles are assigned to a level depending on their interaction cutoff radius.</p>
<p><cite>dtype = np.dtype([(‘L’, np.int64, (N_Levels,)), (‘sh’, np.float64, (N_Levels,3)), (‘head’, np.int64, (np.sum(NCells)*2,)), (‘head_start’, np.int64, (N_Levels,)), (‘ls’, np.int64, (2*N+1,)), (‘NCells’, np.int64, (N_Levels,)), (‘cells_per_dim’, np.int64, (N_Levels,3)), (‘cutoff’, np.float64, (N_Levels,))],  align=True)</cite></p>
</dd>
</dl>
</dd>
</dl>
<p class="rubric">Notes</p>
<p><em>Hierarchical Grid</em></p>
<p>The computationaly most expensive part in molecular dynamics simulations is usually the calculation of the pairwise interaction forces, beacuase to calculate these, we need to determine the distance between particles. When doing this in the most naiv way, i.e. for each particle i we iterate over all the other particles j in the system and calculate the distance, the computation time will increase quadratically with the number of partciles in the system (<span class="math notranslate nohighlight">\(O(N^2)\)</span>). Even if we take into account Newtons third law, this will decrease the number of computations (<span class="math notranslate nohighlight">\(O(\frac{1}{2}N(N-1))\)</span>), but the computational complexity still is quadratic in N. 
A straight forward method to significantly improve the situation is the linked cell list approach <span id="id1">[<a class="reference internal" href="../../../References.html#id26" title="Michael P. Allen and Dominic J. Tildesley. Computer Simulation of Liquids. Oxford University Press, nov 2017. doi:10.1093/oso/9780198803195.001.0001.">3</a>]</span> (pp.195: 5.3.2 Cell structures and linked lists) where the simulation box is divided into <span class="math notranslate nohighlight">\(n \times n \times n\)</span> cells. The number of cells must be chosen such that the side length of the cells in each dimension <span class="math notranslate nohighlight">\(s = L/n\)</span>, where <span class="math notranslate nohighlight">\(L\)</span> is the simulation box length, is greater than the maximum cutoff radius for the pairwise molecular interactions (and in our case also bimolecular reactions). This will decrease the computational complexity to <span class="math notranslate nohighlight">\(O(14 N \rho s^3 )\)</span>, where <span class="math notranslate nohighlight">\(\rho\)</span> is the molecule density (assuming a mostly homogeneous distribution of molecules). Thereby, the computation time increase rather linear with <span class="math notranslate nohighlight">\(N\)</span> instead of quadratically (<span class="math notranslate nohighlight">\(N^2\)</span>).</p>
<p>However, one problem with this method is that it does not efficiently handle polydisperse particle size distributions. This becomes a problem when doing minimal coarse graining of proteins and other structures we find in the cell such as vesicles. As mentioned above, n should be chosen such that the cell length is greater than teh maximum cutoff radius. If we would like to simulate, e.g. proteins (<span class="math notranslate nohighlight">\(r \approx 2-5 nm\)</span>) in the presence of synaptic vesicles (<span class="math notranslate nohighlight">\(r \approx 20-30 nm\)</span>), the cells become way larger than necessary from the perspective of the small proteins.</p>
<p>One way to approach this problem would be, to choose a small cell size (e.g. based on the samllest cutoff radius) and just iterate not just over the nearest neighbour cells but over as many cells such that the cutoff radius of the larger proteins/SVs is covered. This approach has has a big disadvantages: Whereas for the smaller partciles we actually reduce the number of unnecessary distance calculations, for the larger particles we don’t. We can, however, still take advantage of Newton’s 3rd law. For this, we only do the distance calculation if the radius of particle i is larger than the radius of particle j. If the radii are equal, we only do the calculation if index i is smaller than index j.</p>
<p>A much better approach has been introduced by <span id="id2">Ogarko and Luding [<a class="reference internal" href="../../../References.html#id27" title="V. Ogarko and S. Luding. A fast multilevel algorithm for contact detection of arbitrarily polydisperse objects. Computer Physics Communications, 183(4):931–936, apr 2012. doi:10.1016/j.cpc.2011.12.019.">4</a>]</span> and makes use of a so called hierarchical grid. This approach is the one we use in PyRID. In the hierarchical grid approach, each particle is assigned to a different cell grid depending on its cutoff radius, i.e. the grid consists of different levels or hierarchies, each having a different cell size. This has the downside of taking up more memory, howewer, it drastically reduces the number of distance calculations we need to do for the larger particles and also takes advantage of Newtons third law, enabling polydisiperse system simulations with almost no performance loss. The algorithm for the distance checks works as follows:</p>
<blockquote>
<div><ol class="arabic simple">
<li><p>Iterate over all particles</p></li>
<li><p>Assign each particle to a cell on their respective level in the hierarchical grid</p></li>
<li><p>Iterate over all particles once more</p></li>
<li><p>Do a distance check for the nearest neigbour cells on the level the current particle sites in. This is done using the classical linekd cell list algorithm.</p></li>
<li><p>Afterwards, do a cross-level search. For this, distance checks are only done on lower hierarchy levels, i.e. on levels with smaller partcile sizes than the current one. This way, we do not need to double check the same particle pair (3rd law). However, in this step, we will have to iterate over potentialy many empty cells (Note: this should, in principle, also be doable in a more efficient way).</p></li>
</ol>
</div></blockquote>
<p><em>Mesh collision response</em></p>
<p>The distance between particle and mesh triangles is calculated and based on the distance a repulsive force is determined. 
The repulsive force is normalized by the total number of triangle collisions. This approach is not exact but works sufficiently well.
Particle vertex collisions are neglected if one or more particle face collisions have been detected.</p>
</dd></dl>

</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="system_util.html" class="btn btn-neutral float-left" title="system_util" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="update_pos.html" class="btn btn-neutral float-right" title="update_pos" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, Moritz F P Becker.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>